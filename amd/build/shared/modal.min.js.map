{"version":3,"file":"modal.min.js","sources":["../../src/shared/modal.js"],"sourcesContent":["/**\n * @fileoverview Gestionnaire de modales d'avertissement s√©curis√©\n * @module quizaccess_cheatdetect/shared/modal\n * @copyright 2025 CBlue SRL <support@cblue.be>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since 1.0.0\n */\n\ndefine([\n    'quizaccess_cheatdetect/shared/utils',\n    'quizaccess_cheatdetect/extension-detector/config'\n], function(Utils, Config) {\n    'use strict';\n\n    /**\n     * ID de la modale actuellement affich√©e\n     * @type {string|null}\n     * @private\n     */\n    var currentModalId = null;\n\n    /**\n     * Extension key de la modale actuelle pour le tracking\n     * @type {string|null}\n     * @private\n     */\n    var currentExtensionKey = null;\n\n    /**\n     * Callback pour enregistrer les √©v√©nements\n     * @type {Function|null}\n     * @private\n     */\n    var eventLogger = null;\n\n    /**\n     * G√®re le clic sur le bouton de la modale\n     * @function handleModalButtonClick\n     * @private\n     * @since 1.0.0\n     */\n    var handleModalButtonClick = function() {\n\n        // Enregistrer l'√©v√©nement de fermeture de modale\n        if (eventLogger) {\n            eventLogger({\n                action: \"extension_modal_dismissed\",\n                data: {\n                    extensionKey: currentExtensionKey, // Utilise la variable globale du module\n                    modalAction: Config.SETTINGS.reloadOnModalClose ? \"reload\" : \"close\"\n                }\n            });\n        } else {\n            console.error('‚ùå eventLogger non configur√© pour extension_modal_dismissed !');\n        }\n\n        // Action selon la configuration\n        if (Config.SETTINGS.reloadOnModalClose === true) {\n            window.location.reload();\n        } else {\n            closeModal();\n        }\n    };\n\n    /**\n     * D√©finit la fonction de logging des √©v√©nements\n     * @function setEventLogger\n     * @param {Function} loggerFunction - Fonction pour enregistrer les √©v√©nements\n     * @example\n     * Modal.setEventLogger((event) => {\n     *   console.log('Nouvel √©v√©nement:', event);\n     * });\n     * @since 1.0.0\n     */\n    var setEventLogger = function(loggerFunction) {\n        eventLogger = loggerFunction;\n    };\n\n    /**\n     * Affiche une modale d'avertissement avec IDs/classes randomis√©s pour √©viter la d√©tection\n     * @function showModal\n     * @param {Object} extension - Information sur l'extension d√©tect√©e\n     * @param {Object} [config] - Configuration de la modale\n     * @param {string} [config.icon='‚ö†Ô∏è'] - Ic√¥ne √† afficher\n     * @param {string} [config.title='Avertissement d\\'int√©grit√© acad√©mique.'] - Titre de la modale\n     * @param {string} [config.buttonText='OK ‚Äî J\\'ai retir√© l\\'extension et je continue'] - Texte du bouton\n     * @example\n     * showModal('Crowdly Extension', {\n     *   title: 'Extension d√©tect√©e',\n     *   icon: 'üö´'\n     * });\n     * @since 1.0.0\n     */\n    var showModal = function(extension, config) {\n\n        config = config || {};\n\n        var modalId = Utils.generateUniqueId();\n        var contentClass = Utils.generateUniqueId();\n        var iconClass = Utils.generateUniqueId();\n        var titleClass = Utils.generateUniqueId();\n        var messageClass = Utils.generateUniqueId();\n        var buttonClass = Utils.generateUniqueId();\n        var buttonId = Utils.generateUniqueId();\n        var animationClass = Utils.generateUniqueId();\n\n        // Configuration par d√©faut\n        var modalConfig = {\n            icon: config.icon || '‚ö†Ô∏è',\n            title: config.title || 'Avertissement d\\'int√©grit√© acad√©mique.',\n            message: config.message || '<p>L\\'extension <b>&laquo; %extension.name% &raquo;</b> a √©t√© d√©tect√©e sur votre navigateur. Cette extension est incompatible avec les normes d\\'int√©grit√© acad√©mique de notre plateforme. Veuillez la d√©sactiver ou la d√©sinstaller de votre navigateur pour continuer.</p>',\n            buttonText: config.buttonText || 'OK ‚Äî J\\'ai retir√© l\\'extension et je continue',\n            theme: config.theme || {\n                primaryColor: 'var(--primary, \"#d73502\")',\n                backgroundColor: '#ffffff',\n                borderRadius: '12px',\n                zIndex: 10000\n            }\n        };\n\n        currentModalId = modalId;\n        // Stocker l'extension key pour l'utiliser dans handleModalButtonClick\n        currentExtensionKey = extension.key;\n\n        // Enregistrer l'√©v√©nement d'affichage AVANT la cr√©ation de la modale\n        if (eventLogger) {\n            eventLogger({\n                action: \"extension_modal_shown\",\n                data: {\n                    extensionKey: extension.key,\n                }\n            });\n        } else {\n            console.error('‚ùå eventLogger non configur√© pour extension_modal_shown !');\n        }\n\n        // Cr√©ation de l'√©l√©ment modal\n        var modal = document.createElement('div');\n        modal.id = modalId;\n\n        modal.innerHTML = `\n            <style>\n                html, body {\n                    overflow: hidden;\n                    height: 100dvh;\n                }\n                #${modalId} {\n                    position: fixed;\n                    inset: 0;\n                    background: rgba(0, 0, 0, 0.6);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    z-index: ${modalConfig.theme.zIndex};\n                }\n\n                #${modalId} .${contentClass} {\n                    background: ${modalConfig.theme.backgroundColor};\n                    border-radius: ${modalConfig.theme.borderRadius};\n                    padding: 32px;\n                    max-width: 700px;\n                    width: 90%;\n                    max-height: 90vh;\n                    overflow-y: auto;\n                    text-align: center;\n                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n                    animation: ${animationClass} 0.3s ease-out;\n                }\n\n                @keyframes ${animationClass} {\n                    from { \n                        opacity: 0; \n                        transform: scale(0.9) translateY(-20px); \n                    }\n                    to { \n                        opacity: 1; \n                        transform: scale(1) translateY(0); \n                    }\n                }\n\n                #${modalId} .${iconClass} { \n                    font-size: 48px; \n                    margin-bottom: 16px; \n                }\n\n                #${modalId} .${titleClass} { \n                    color: #333; \n                    font-size: 24px; \n                    font-weight: 600; \n                    margin: 0 0 20px 0; \n                    line-height: 1.4;\n                }\n\n                #${modalId} .${messageClass} { \n                    color: #333; \n                    font-size: 16px; \n                    line-height: 1.6; \n                    margin-bottom: 16px; \n                }\n\n                #${modalId} .${buttonClass} { \n                    padding: 14px 28px; \n                }\n            </style>\n\n            <div class=\"${contentClass}\">\n                <div class=\"${iconClass}\">${modalConfig.icon}</div>\n                <div class=\"${titleClass}\">${modalConfig.title}</div>\n                <div class=\"${messageClass}\">${modalConfig.message.replace('%extension.name%', extension.name)}</div>\n                <button class=\"${buttonClass} btn btn-primary\" id=\"${buttonId}\">\n                    ${modalConfig.buttonText}\n                </button>\n            </div>\n        `;\n\n        // Ajout √† la page\n        document.body.appendChild(modal);\n\n        // Attacher l'√©v√©nement click au bouton\n        var button = modal.querySelector('#' + buttonId);\n        if (button) {\n            button.addEventListener('click', handleModalButtonClick);\n        } else {\n            console.error('‚ùå Bouton de modale non trouv√© !');\n        }\n\n        // Focus sur le bouton pour l'accessibilit√©\n        setTimeout(function() {\n            if (button) {\n                button.focus();\n            }\n        }, 100);\n\n    };\n\n    /**\n     * V√©rifie si un ID d'√©l√©ment correspond √† notre modale actuelle\n     * @function isOurModalId\n     * @param {string} elementId - ID de l'√©l√©ment √† v√©rifier\n     * @returns {boolean} True si l'ID correspond √† notre modale\n     * @example\n     * if (isOurModalId(element.id)) {\n     *   // Ne pas traiter cet √©l√©ment, c'est notre modale\n     * }\n     * @since 1.0.0\n     */\n    var isOurModalId = function(elementId) {\n        return currentModalId && elementId === currentModalId;\n    };\n\n    /**\n     * Ferme la modale actuelle si elle existe\n     * @function closeModal\n     * @returns {boolean} True si une modale a √©t√© ferm√©e\n     * @example\n     * const closed = closeModal();\n     * @since 1.0.0\n     */\n    var closeModal = function() {\n        if (!currentModalId) {\n            return false;\n        }\n\n        var modal = document.getElementById(currentModalId);\n        if (modal && modal.parentNode) {\n            modal.parentNode.removeChild(modal);\n            currentModalId = null;\n            // CORRECTION: R√©initialiser aussi l'extension key\n            currentExtensionKey = null;\n            return true;\n        }\n\n        currentModalId = null;\n        currentExtensionKey = null;\n        return false;\n    };\n\n    /**\n     * R√©cup√®re l'ID de la modale actuellement affich√©e\n     * @function getCurrentModalId\n     * @returns {string|null} ID de la modale actuelle ou null\n     * @example\n     * const modalId = getCurrentModalId();\n     * @since 1.0.0\n     */\n    var getCurrentModalId = function() {\n        return currentModalId;\n    };\n\n    // API publique\n    return {\n        showModal: showModal,\n        isOurModalId: isOurModalId,\n        closeModal: closeModal,\n        getCurrentModalId: getCurrentModalId,\n        setEventLogger: setEventLogger\n    };\n});"],"names":["define","Utils","Config","currentModalId","currentExtensionKey","eventLogger","handleModalButtonClick","action","data","extensionKey","modalAction","SETTINGS","reloadOnModalClose","console","error","window","location","reload","closeModal","modal","document","getElementById","parentNode","removeChild","showModal","extension","config","modalId","generateUniqueId","contentClass","iconClass","titleClass","messageClass","buttonClass","buttonId","animationClass","modalConfig","icon","title","message","buttonText","theme","primaryColor","backgroundColor","borderRadius","zIndex","key","createElement","id","innerHTML","concat","replace","name","body","appendChild","button","querySelector","addEventListener","setTimeout","focus","isOurModalId","elementId","getCurrentModalId","setEventLogger","loggerFunction"],"mappings":";;;;;;;AAQAA,OAAM,sCAAC,CACH,sCACA,oDACD,SAASC,MAAOC,QAQf,IAAIC,eAAiB,KAOjBC,oBAAsB,KAOtBC,YAAc,KAQdC,uBAAyB,WAGrBD,YACAA,YAAY,CACRE,OAAQ,4BACRC,KAAM,CACFC,aAAcL,oBACdM,YAAaR,OAAOS,SAASC,mBAAqB,SAAW,WAIrEC,QAAQC,MAAM,iEAIyB,IAAvCZ,OAAOS,SAASC,mBAChBG,OAAOC,SAASC,SAEhBC,cAsMJA,WAAa,WACb,IAAKf,eACD,OAAO,EAGX,IAAIgB,MAAQC,SAASC,eAAelB,gBACpC,OAAIgB,OAASA,MAAMG,YACfH,MAAMG,WAAWC,YAAYJ,OAC7BhB,eAAiB,KAEjBC,oBAAsB,MACf,IAGXD,eAAiB,KACjBC,oBAAsB,MACf,IAgBX,MAAO,CACHoB,UAtMY,SAASC,UAAWC,QAEhCA,OAASA,QAAU,GAEnB,IAAIC,QAAU1B,MAAM2B,mBAChBC,aAAe5B,MAAM2B,mBACrBE,UAAY7B,MAAM2B,mBAClBG,WAAa9B,MAAM2B,mBACnBI,aAAe/B,MAAM2B,mBACrBK,YAAchC,MAAM2B,mBACpBM,SAAWjC,MAAM2B,mBACjBO,eAAiBlC,MAAM2B,mBAGvBQ,YAAc,CACdC,KAAMX,OAAOW,MAAQ,KACrBC,MAAOZ,OAAOY,OAAS,wCACvBC,QAASb,OAAOa,SAAW,6QAC3BC,WAAYd,OAAOc,YAAc,8CACjCC,MAAOf,OAAOe,OAAS,CACnBC,aAAc,4BACdC,gBAAiB,UACjBC,aAAc,OACdC,OAAQ,MAIhB1C,eAAiBwB,QAEjBvB,oBAAsBqB,UAAUqB,IAG5BzC,YACAA,YAAY,CACRE,OAAQ,wBACRC,KAAM,CACFC,aAAcgB,UAAUqB,OAIhCjC,QAAQC,MAAM,4DAIlB,IAAIK,MAAQC,SAAS2B,cAAc,OACnC5B,MAAM6B,GAAKrB,QAEXR,MAAM8B,UAASC,wKAAAA,OAMJvB,QAAOuB,2RAAAA,OAOKd,YAAYK,MAAMI,OAAM,6CAAAK,OAGpCvB,QAAO,MAAAuB,OAAKrB,aAAY,wCAAAqB,OACTd,YAAYK,MAAME,gBAAeO,0CAAAA,OAC9Bd,YAAYK,MAAMG,aAAYM,0UAAAA,OAQlCf,eAAce,qEAAAA,OAGlBf,+WAAce,OAWxBvB,QAAO,MAAAuB,OAAKpB,UAAS,iIAAAoB,OAKrBvB,QAAOuB,MAAAA,OAAKnB,WAAUmB,kPAAAA,OAQtBvB,QAAO,MAAAuB,OAAKlB,aAAY,4MAAAkB,OAOxBvB,QAAO,MAAAuB,OAAKjB,YAAW,sHAAAiB,OAKhBrB,aAAYqB,oCAAAA,OACRpB,UAASoB,MAAAA,OAAKd,YAAYC,KAAI,wCAAAa,OAC9BnB,WAAU,MAAAmB,OAAKd,YAAYE,MAAKY,wCAAAA,OAChClB,aAAYkB,MAAAA,OAAKd,YAAYG,QAAQY,QAAQ,mBAAoB1B,UAAU2B,MAAKF,2CAAAA,OAC7EjB,sCAAWiB,OAAyBhB,SAAQ,4BAAAgB,OACvDd,YAAYI,WAGzB,6DAGDpB,SAASiC,KAAKC,YAAYnC,OAG1B,IAAIoC,OAASpC,MAAMqC,cAAc,IAAMtB,UACnCqB,OACAA,OAAOE,iBAAiB,QAASnD,wBAEjCO,QAAQC,MAAM,mCAIlB4C,WAAW,WACHH,QACAA,OAAOI,OAEd,EAAE,MA6DHC,aA9Ce,SAASC,WACxB,OAAO1D,gBAAkB0D,YAAc1D,gBA8CvCe,WAAYA,WACZ4C,kBAToB,WACpB,OAAO3D,gBASP4D,eA7NiB,SAASC,gBAC1B3D,YAAc2D,gBA8NtB"}