{"version":3,"file":"report_enhancer.min.js","sources":["../src/report_enhancer.js"],"sourcesContent":["/**\n * This JS is made to enhance the /mod/quiz/report.php?id=X&mode=overview core_moodle report table\n * and /mod/quiz/reviewquestion.php pages\n *\n * @module     quizaccess_cheatdetect/report_enhancer\n * @package\n * @copyright   2025 CBlue SPRL\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author      gnormand@cblue.be\n */\n\n/* global bootstrap */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str'], function($, Ajax, Notification, Str) {\n\n    var config = {}; // eslint-disable-line no-unused-vars\n\n    // Toggle between mock data and real webservice calls\n    var useMockData = true;\n\n    // Debug mode: if true, popovers won't auto-close (easier to inspect in DevTools)\n    var debugMode = true;\n\n    /**\n     * Initialize the report enhancer\n     * @param {object} params Configuration parameters\n     */\n    var init = function(params) {\n        config = params;\n        // Wait for DOM to be ready\n        $(document).ready(function() {\n            // Check if we are on the review question page\n            if (window.location.pathname.indexOf('reviewquestion.php') !== -1) {\n                enhanceReviewQuestionPage();\n            } else {\n                enhanceReportTable();\n            }\n        });\n    };\n\n    /**\n     * Add data-cblue-attempt attribute to each row in the attempts table\n     * @returns {Array} Array of attempt IDs found in the table\n     */\n    var addAttemptDataAttributes = function() {\n        // Find the attempts table\n        var $attemptsTable = $('#attempts');\n        var attemptIds = [];\n\n        if ($attemptsTable.length === 0) {\n            console.warn('CheatDetect: Attempts table not found'); // eslint-disable-line no-console\n            return attemptIds;\n        }\n\n        // Iterate through each row in the tbody\n        $attemptsTable.find('tbody tr').each(function() {\n            var $row = $(this);\n\n            // Find the review link in this row\n            var $reviewLink = $row.find('.reviewlink');\n\n            if ($reviewLink.length > 0) {\n                // Get the href attribute\n                var href = $reviewLink.attr('href');\n\n                if (href) {\n                    // Extract the attempt parameter from the URL\n                    var urlParts = href.split('?');\n                    if (urlParts.length > 1) {\n                        var urlParams = new URLSearchParams(urlParts[1]);\n                        var attemptId = urlParams.get('attempt');\n\n                        if (attemptId) {\n                            // Add the data attribute to the row\n                            $row.attr('data-cblue-attempt', attemptId);\n                            // Add to the array (convert to integer)\n                            attemptIds.push(parseInt(attemptId, 10));\n                            // eslint-disable-next-line no-console\n                            console.log('CheatDetect: Added data-cblue-attempt=' + attemptId + ' to row');\n                        }\n                    }\n                }\n            }\n        });\n\n        return attemptIds;\n    };\n\n    /**\n     * Add data-cblue-slot attribute to each TD containing reviewquestion.php links\n     */\n    var addSlotDataAttributes = function() {\n        // Find all links to reviewquestion.php\n        $('a[href*=\"reviewquestion.php\"]').each(function() {\n            var $link = $(this);\n            var href = $link.attr('href');\n\n            if (href) {\n                var slotId = extractSlotFromUrl(href);\n                if (slotId) {\n                    // Find the TD parent and add the data attribute\n                    var $td = $link.closest('td');\n                    $td.attr('data-cblue-slot', slotId);\n                    // eslint-disable-next-line no-console\n                    console.log('CheatDetect: Added data-cblue-slot=' + slotId + ' to TD');\n                }\n            }\n        });\n    };\n\n    /**\n     * Fetch bulk attempt summaries from webservice\n     * @param {Array} attemptIds Array of attempt IDs to fetch\n     */\n    var fetchBulkAttemptSummaries = function(attemptIds) {\n        if (!attemptIds || attemptIds.length === 0) {\n            console.warn('CheatDetect: No attempt IDs provided'); // eslint-disable-line no-console\n            return;\n        }\n\n        // Determine URL and method based on useMockData flag\n        var url = useMockData ?\n            M.cfg.wwwroot + '/mod/quiz/accessrule/cheatdetect/mockdata/bulk-attempt-summaries.json' :\n            '/local/rest/api/quizaccess_cheatdetect/bulk-attempt-summaries';\n\n        var method = useMockData ? 'GET' : 'POST';\n        var payload = useMockData ? null : {attemptids: attemptIds};\n\n        if (useMockData) {\n            // eslint-disable-next-line no-console\n            console.log('CheatDetect: Using MOCK DATA from file for attempt IDs:', attemptIds);\n        } else {\n            console.log('CheatDetect: Fetching bulk attempt summaries for IDs:', attemptIds); // eslint-disable-line no-console\n        }\n\n        var ajaxConfig = {\n            url: url,\n            method: method,\n            dataType: 'json',\n            success: function(response) {\n                // eslint-disable-next-line no-console\n                console.log('CheatDetect: Bulk attempt summaries response:', response);\n                if (response.success && response.data) {\n                    processBulkAttemptSummaries(response.data);\n                } else {\n                    // eslint-disable-next-line no-console\n                    console.warn('CheatDetect: Invalid response from bulk summaries webservice', response);\n                }\n            },\n            error: function(xhr, status, error) {\n                console.error('CheatDetect: Error fetching bulk attempt summaries', error); // eslint-disable-line no-console\n            }\n        };\n\n        // Add POST-specific parameters only for real webservice calls\n        if (!useMockData) {\n            ajaxConfig.contentType = 'application/json';\n            ajaxConfig.data = JSON.stringify(payload);\n        }\n\n        $.ajax(ajaxConfig);\n    };\n\n    /**\n     * Create SVG icon element\n     * @param {string} iconColor Color of icon: 'red', 'green', or 'gray'\n     * @param {string} iconType Type of icon: 'summary' or 'question'\n     * @returns {jQuery} jQuery object containing the SVG icon\n     */\n    var createSvgIcon = function(iconColor, iconType) {\n        var iconFile = 'spy-icon-' + iconColor + '.svg';\n        var svgPath = M.cfg.wwwroot + '/mod/quiz/accessrule/cheatdetect/pix/' + iconFile;\n\n        var $img = $('<img>')\n            .attr('src', svgPath)\n            .attr('aria-hidden', 'true')\n            .addClass('cheatdetect-svg-icon')\n            .attr('data-cblue-spyicon', iconType);\n\n        // Set size (20x20 for all icons)\n        if (iconType === 'summary') {\n            $img.css({\n                'width': '20px',\n                'height': '20px',\n                'margin-left': '8px',\n                'vertical-align': 'middle'\n            });\n        } else {\n            $img.css({\n                'width': '20px',\n                'height': '20px',\n                'display': 'block',\n                'margin-top': '4px'\n            });\n        }\n\n        return $img;\n    };\n\n    /**\n     * Extract slot number from reviewquestion.php URL\n     * @param {string} url URL containing slot parameter\n     * @returns {number|null} Slot number or null if not found\n     */\n    var extractSlotFromUrl = function(url) {\n        if (!url) {\n            return null;\n        }\n\n        var urlParts = url.split('?');\n        if (urlParts.length > 1) {\n            var urlParams = new URLSearchParams(urlParts[1]);\n            var slot = urlParams.get('slot');\n            return slot ? parseInt(slot, 10) : null;\n        }\n\n        return null;\n    };\n\n    /**\n     * Generate popover content HTML for a slot\n     * @param {object} slotData Slot data from webservice\n     * @param {object} strings Translated strings from language files\n     * @returns {string} HTML content for the popover\n     */\n    var generatePopoverContent = function(slotData, strings) {\n        // Calculate time in minutes\n        var timeInMinutes = Math.round(slotData.time_spent / 60);\n        var timePercentage = Math.round(slotData.time_percentage);\n\n        // Build HTML content as a bullet list\n        var html = '<ul class=\"mb-0\">';\n\n        // Time spent\n        var timeSpentText = strings.timespent\n            .replace('{$a->minutes}', timeInMinutes)\n            .replace('{$a->percentage}', timePercentage);\n        html += '<li>' + timeSpentText + '</li>';\n\n        // Copy count (red if > 0)\n        var copyCountText = strings.copycount.replace('{$a}', slotData.copy_count);\n        if (slotData.copy_count > 0) {\n            html += '<li class=\"text-danger fw-bold\">' + copyCountText + '</li>';\n        } else {\n            html += '<li>' + copyCountText + '</li>';\n        }\n\n        // Focus loss count (red if > 0)\n        var focusLossText = strings.focuslosscount.replace('{$a}', slotData.focus_loss_count);\n        if (slotData.focus_loss_count > 0) {\n            html += '<li class=\"text-danger fw-bold\">' + focusLossText + '</li>';\n        } else {\n            html += '<li>' + focusLossText + '</li>';\n        }\n\n        // Extension detection (red if true)\n        var extensionText = slotData.has_extension ? strings.yes : strings.no;\n        var extensionDetectedText = strings.extensiondetected.replace('{$a}', extensionText);\n        if (slotData.has_extension) {\n            html += '<li class=\"text-danger fw-bold\">' + extensionDetectedText + '</li>';\n        } else {\n            html += '<li>' + extensionDetectedText + '</li>';\n        }\n\n        html += '</ul>';\n\n        return html;\n    };\n\n    /**\n     * Initialize Bootstrap 5 popovers with custom configuration\n     */\n    var initializePopovers = function() {\n        // Check if Bootstrap is available\n        if (typeof bootstrap === 'undefined' || !bootstrap.Popover) {\n            console.warn('CheatDetect: Bootstrap 5 not available'); // eslint-disable-line no-console\n            return;\n        }\n\n        // Find all popover trigger elements\n        var popoverElements = document.querySelectorAll('[data-bs-toggle=\"popover\"]');\n\n        popoverElements.forEach(function(element) {\n            // Check if already initialized\n            if (bootstrap.Popover.getInstance(element)) {\n                return;\n            }\n\n            // Configure popover options\n            var popoverConfig = {\n                html: true,\n                trigger: 'click',\n                sanitize: false\n            };\n\n            // In debug mode, popovers stay open (easier to inspect in DevTools)\n            if (debugMode) {\n                popoverConfig.trigger = 'manual';\n                element.addEventListener('click', function(e) {\n                    e.preventDefault();\n                    var popover = bootstrap.Popover.getInstance(element);\n                    if (popover) {\n                        popover.show();\n                    }\n                });\n            }\n\n            // Initialize popover\n            new bootstrap.Popover(element, popoverConfig);\n        });\n\n        var message = 'CheatDetect: Initialized ' + popoverElements.length + ' popovers';\n        if (debugMode) {\n            message += ' (DEBUG MODE: popovers stay open)';\n        }\n        console.log(message); // eslint-disable-line no-console\n    };\n\n    /**\n     * Process bulk attempt summaries data\n     * @param {Array} summaries Array of attempt summaries from webservice\n     */\n    var processBulkAttemptSummaries = function(summaries) {\n        console.log('CheatDetect: Processing ' + summaries.length + ' attempt summaries'); // eslint-disable-line no-console\n\n        // Load translated strings first\n        var stringKeys = [\n            {key: 'questiondetails', component: 'quizaccess_cheatdetect'},\n            {key: 'timespent', component: 'quizaccess_cheatdetect'},\n            {key: 'copycount', component: 'quizaccess_cheatdetect'},\n            {key: 'focuslosscount', component: 'quizaccess_cheatdetect'},\n            {key: 'extensiondetected', component: 'quizaccess_cheatdetect'},\n            {key: 'yes', component: 'quizaccess_cheatdetect'},\n            {key: 'no', component: 'quizaccess_cheatdetect'}\n        ];\n\n        Str.get_strings(stringKeys).then(function(stringsArray) {\n            // Build strings object for easier access\n            var strings = {\n                questiondetails: stringsArray[0],\n                timespent: stringsArray[1],\n                copycount: stringsArray[2],\n                focuslosscount: stringsArray[3],\n                extensiondetected: stringsArray[4],\n                yes: stringsArray[5],\n                no: stringsArray[6]\n            };\n\n            processAttemptSummariesWithStrings(summaries, strings);\n        }).catch(function(error) {\n            console.error('CheatDetect: Error loading strings', error); // eslint-disable-line no-console\n        });\n    };\n\n    /**\n     * Process attempt summaries with loaded strings\n     * @param {Array} summaries Array of attempt summaries from webservice\n     * @param {object} strings Translated strings from language files\n     */\n    var processAttemptSummariesWithStrings = function(summaries, strings) {\n        summaries.forEach(function(attemptData) {\n            var attemptId = attemptData.attemptid;\n            var slots = attemptData.slots;\n\n            // Find the corresponding table row\n            var $row = $('tr[data-cblue-attempt=\"' + attemptId + '\"]');\n\n            if ($row.length === 0) {\n                console.warn('CheatDetect: Row not found for attempt ' + attemptId); // eslint-disable-line no-console\n                return;\n            }\n\n            // eslint-disable-next-line no-console\n            console.log('CheatDetect: Processing attempt ' + attemptId + ' with ' + slots.length + ' slots');\n\n            var hasRedSlot = false;\n\n            // If slots array is empty, we need to add gray icons to all TDs with data-cblue-slot\n            if (!slots || slots.length === 0) {\n                // eslint-disable-next-line no-console\n                console.log('CheatDetect: No slot data for attempt ' + attemptId + ', using gray icons');\n\n                $row.find('td[data-cblue-slot]').each(function() {\n                    var $td = $(this);\n\n                    // Check if icon already added\n                    if ($td.find('.cheatdetect-svg-icon').length > 0) {\n                        return;\n                    }\n\n                    var slotId = $td.attr('data-cblue-slot');\n                    var $link = $td.find('a[href*=\"reviewquestion.php\"]').first();\n\n                    if ($link.length > 0) {\n                        var $icon = createSvgIcon('gray', 'question');\n\n                        // Generate popover content using translated strings\n                        var grayPopoverData = {\n                            time_spent: 0,\n                            time_percentage: 0,\n                            copy_count: 0,\n                            focus_loss_count: 0,\n                            has_extension: false\n                        };\n                        var grayPopoverContent = generatePopoverContent(grayPopoverData, strings);\n\n                        var $iconButton = $('<button>')\n                            .attr('type', 'button')\n                            .attr('data-bs-toggle', 'popover')\n                            .attr('data-bs-trigger', 'click')\n                            .attr('data-bs-html', 'true')\n                            .attr('data-bs-title', strings.questiondetails)\n                            .attr('data-bs-content', grayPopoverContent)\n                            .attr('data-bs-placement', 'left')\n                            .addClass('btn btn-link p-0')\n                            .css({\n                                'border': 'none',\n                                'background': 'none',\n                                'cursor': 'pointer',\n                                'display': 'inline-block'\n                            })\n                            .append($icon);\n\n                        $td.append($iconButton);\n                        // eslint-disable-next-line no-console\n                        console.log('CheatDetect: Added gray icon for slot ' + slotId);\n                    }\n                });\n            } else {\n                // Process each slot from the webservice data\n                slots.forEach(function(slotData) {\n                    var slotId = slotData.slot;\n\n                    // Find the TD with both data-cblue-attempt (via parent row) and data-cblue-slot\n                    var $td = $row.find('td[data-cblue-slot=\"' + slotId + '\"]');\n\n                    if ($td.length === 0) {\n                        // eslint-disable-next-line no-console\n                        console.warn('CheatDetect: TD not found for attempt ' + attemptId + ' slot ' + slotId);\n                        return;\n                    }\n\n                    // Check if icon already added\n                    if ($td.find('.cheatdetect-svg-icon').length > 0) {\n                        return;\n                    }\n\n                    // Determine icon color based on cheat_detected\n                    var iconColor = slotData.cheat_detected ? 'red' : 'green';\n\n                    if (slotData.cheat_detected) {\n                        hasRedSlot = true;\n                    }\n\n                    // Find the link in this TD\n                    var $link = $td.find('a[href*=\"reviewquestion.php\"]').first();\n\n                    if ($link.length > 0) {\n                        var $icon = createSvgIcon(iconColor, 'question');\n\n                        // Generate popover content with translated strings\n                        var popoverContent = generatePopoverContent(slotData, strings);\n\n                        var $iconButton = $('<button>')\n                            .attr('type', 'button')\n                            .attr('data-bs-toggle', 'popover')\n                            .attr('data-bs-trigger', 'click')\n                            .attr('data-bs-html', 'true')\n                            .attr('data-bs-title', strings.questiondetails)\n                            .attr('data-bs-content', popoverContent)\n                            .attr('data-bs-placement', 'left')\n                            .addClass('btn btn-link p-0')\n                            .css({\n                                'border': 'none',\n                                'background': 'none',\n                                'cursor': 'pointer',\n                                'display': 'inline-block'\n                            })\n                            .append($icon);\n\n                        $td.append($iconButton);\n                        // eslint-disable-next-line no-console\n                        console.log('CheatDetect: Added ' + iconColor + ' icon for slot ' + slotId +\n                                    ' (cheat_detected: ' + slotData.cheat_detected + ')');\n                    }\n                });\n            }\n\n            // Process summary icon (in the review link)\n            var $reviewLink = $row.find('.reviewlink');\n            if ($reviewLink.length > 0) {\n                var $oldEyeIcon = $reviewLink.find('.cheatdetect-icon');\n\n                if ($oldEyeIcon.length > 0) {\n                    // Use gray if no slots, red if any slot is red, green otherwise\n                    var summaryColor = (!slots || slots.length === 0) ? 'gray' : (hasRedSlot ? 'red' : 'green');\n                    var $newEyeIcon = createSvgIcon(summaryColor, 'summary');\n                    $oldEyeIcon.replaceWith($newEyeIcon);\n                    // eslint-disable-next-line no-console\n                    console.log('CheatDetect: Replaced summary icon for attempt ' + attemptId +\n                                ' (color: ' + summaryColor + ')');\n                }\n            }\n        });\n\n        console.log('CheatDetect: Finished processing all attempt summaries'); // eslint-disable-line no-console\n\n        // Initialize popovers with sanitize: false to allow red color styles\n        initializePopovers();\n    };\n\n    /**\n     * Enhance the report table with cheat detection information\n     */\n    var enhanceReportTable = function() {\n        // Find the report table\n        var domtable = $('table.generaltable');\n\n        if (domtable.length === 0) {\n            console.warn('CheatDetect: Report table not found'); // eslint-disable-line no-console\n            return;\n        }\n\n        console.log('CheatDetect: Enhancing report table'); // eslint-disable-line no-console\n\n        // Add data-cblue-attempt attributes to table rows and collect attempt IDs\n        var attemptIds = addAttemptDataAttributes();\n\n        // Add data-cblue-slot attributes to TDs containing reviewquestion.php links\n        addSlotDataAttributes();\n\n        // Add icons next to \"Relecture de cette tentative\" links\n        addIconsToReviewLinks();\n\n        // Fetch bulk attempt summaries if we have attempt IDs\n        if (attemptIds.length === 0) {\n            console.warn('CheatDetect: No attempts found'); // eslint-disable-line no-console\n            return;\n        }\n\n        // Fetch bulk attempt summaries from webservice\n        fetchBulkAttemptSummaries(attemptIds);\n\n        return attemptIds;\n\n    };\n\n    /**\n     * Add icons next to \"Relecture de cette tentative\" links\n     */\n    var addIconsToReviewLinks = function() {\n        // Find all review links\n        $('.reviewlink').each(function() {\n            var $link = $(this);\n\n            // Check if icon already added\n            if ($link.find('.cheatdetect-icon').length > 0) {\n                return;\n            }\n\n            // Create icon element\n            var $icon = $('<i>')\n                .addClass('fa fa-eye cheatdetect-icon')\n                .attr('aria-hidden', 'true')\n                .css({\n                    'margin-left': '8px',\n                    'color': '#0066cc'\n                });\n\n            // Append icon to the link\n            $link.append(' ').append($icon);\n        });\n    };\n\n\n    /**\n     * Enhance the review question page with cheat detection summary\n     */\n    var enhanceReviewQuestionPage = function() {\n        console.log('CheatDetect: Enhancing review question page'); // eslint-disable-line no-console\n\n        // Extract attempt and slot from URL parameters\n        var attemptId = getUrlParameter('attempt');\n        var slotId = getUrlParameter('slot');\n\n        if (!attemptId || !slotId) {\n            console.warn('CheatDetect: Missing attempt or slot parameter in URL'); // eslint-disable-line no-console\n            return;\n        }\n\n        // Fetch attempt summary data from webservice\n        fetchAttemptSummary(attemptId, slotId);\n    };\n\n    /**\n     * Get URL parameter value by name\n     * @param {string} name Parameter name\n     * @returns {string|null} Parameter value or null if not found\n     */\n    var getUrlParameter = function(name) {\n        var urlParams = new URLSearchParams(window.location.search);\n        return urlParams.get(name);\n    };\n\n    /**\n     * Fetch attempt summary data from webservice\n     * @param {string} attemptId Attempt ID\n     * @param {string} slotId Slot ID\n     */\n    var fetchAttemptSummary = function(attemptId, slotId) {\n        var url = '/local/rest/api/quizaccess_cheatdetect/attempt-summary/' + attemptId + '/slots/' + slotId;\n\n        $.ajax({\n            url: url,\n            method: 'GET',\n            dataType: 'json',\n            success: function(response) {\n                if (response.success && response.data) {\n                    createCheatDetectResumeBlock(response.data);\n                } else {\n                    console.warn('CheatDetect: Invalid response from webservice', response); // eslint-disable-line no-console\n                }\n            },\n            error: function(xhr, status, error) {\n                console.error('CheatDetect: Error fetching attempt summary', error); // eslint-disable-line no-console\n            }\n        });\n    };\n\n    /**\n     * Create and display the cheat detection resume block\n     * @param {object} data Attempt summary data from webservice\n     */\n    var createCheatDetectResumeBlock = function(data) {\n        // Check if block already exists\n        if ($('.cheatdetect_resume').length > 0) {\n            return;\n        }\n\n        // Convert time_spent from seconds to minutes\n        var timeInMinutes = Math.round(data.time_spent / 60);\n        var timePercentage = Math.round(data.time_percentage);\n\n        // Load translated strings\n        var stringKeys = [\n            {key: 'timespent', component: 'quizaccess_cheatdetect'},\n            {key: 'copycount', component: 'quizaccess_cheatdetect'},\n            {key: 'focuslosscount', component: 'quizaccess_cheatdetect'},\n            {key: 'extensiondetected', component: 'quizaccess_cheatdetect'},\n            {key: 'yes', component: 'quizaccess_cheatdetect'},\n            {key: 'no', component: 'quizaccess_cheatdetect'}\n        ];\n\n        Str.get_strings(stringKeys).then(function(strings) {\n            var timeSpentStr = strings[0];\n            var copyCountStr = strings[1];\n            var focusLossCountStr = strings[2];\n            var extensionDetectedStr = strings[3];\n            var yesStr = strings[4];\n            var noStr = strings[5];\n\n            // Determine extension detection text\n            var extensionText = data.has_extension ? yesStr : noStr;\n\n            // Create the resume block HTML\n            var $resumeBlock = $('<div>')\n                .addClass('cheatdetect_resume')\n                .css({\n                    'background-color': '#d3d3d3',\n                    'padding': '1rem 1rem',\n                    'margin-bottom': '1rem',\n                    'border': 'var(--bs-border-width) solid #fff0',\n                    'border-radius': 'var(--bs-border-radius)',\n                    'font-size': '14px',\n                    'line-height': '1.6'\n                });\n\n            // Time spent line\n            var timeSpentText = timeSpentStr\n                .replace('{$a->minutes}', timeInMinutes)\n                .replace('{$a->percentage}', timePercentage);\n            var $timeLine = $('<div>').text(timeSpentText);\n\n            // Copy count line (in red if > 0)\n            var copyCountText = copyCountStr.replace('{$a}', data.copy_count);\n            var $copyLine = $('<div>')\n                .text(copyCountText)\n                .css('color', data.copy_count > 0 ? '#ff0000' : 'inherit');\n\n            // Focus loss count line (in red if > 0)\n            var focusLossCountText = focusLossCountStr.replace('{$a}', data.focus_loss_count);\n            var $focusLine = $('<div>')\n                .text(focusLossCountText)\n                .css('color', data.focus_loss_count > 0 ? '#ff0000' : 'inherit');\n\n            // Extension detection line\n            var extensionDetectedText = extensionDetectedStr.replace('{$a}', extensionText);\n            var $extensionLine = $('<div>').text(extensionDetectedText);\n\n            // Append all lines to the block\n            $resumeBlock.append($timeLine)\n                .append($copyLine)\n                .append($focusLine)\n                .append($extensionLine);\n\n            // Insert the block after the .outcome element\n            var $outcomeContainer = $('.outcome');\n            if ($outcomeContainer.length > 0) {\n                $outcomeContainer.after($resumeBlock);\n            } else {\n                // Fallback: insert at the top of the question container\n                var $targetContainer = $('.que');\n                if ($targetContainer.length > 0) {\n                    $targetContainer.prepend($resumeBlock);\n                } else {\n                    // Last fallback: insert after the page header\n                    $('#page-content').prepend($resumeBlock);\n                }\n            }\n\n            console.log('CheatDetect: Resume block added successfully'); // eslint-disable-line no-console\n        }).catch(function(error) {\n            console.error('CheatDetect: Error loading strings', error); // eslint-disable-line no-console\n        });\n    };\n\n    return {\n        init: init\n    };\n});"],"names":["define","$","Ajax","Notification","Str","createSvgIcon","iconColor","iconType","iconFile","svgPath","M","cfg","wwwroot","$img","attr","addClass","css","width","height","display","extractSlotFromUrl","url","urlParts","split","length","slot","URLSearchParams","get","parseInt","generatePopoverContent","slotData","strings","timeInMinutes","Math","round","time_spent","timePercentage","time_percentage","html","timespent","replace","copyCountText","copycount","copy_count","focusLossText","focuslosscount","focus_loss_count","extensionText","has_extension","yes","no","extensionDetectedText","extensiondetected","processBulkAttemptSummaries","summaries","console","log","get_strings","key","component","then","stringsArray","questiondetails","processAttemptSummariesWithStrings","catch","error","forEach","attemptData","attemptId","attemptid","slots","$row","hasRedSlot","slotId","$td","find","cheat_detected","first","$icon","popoverContent","$iconButton","border","background","cursor","append","warn","each","this","grayPopoverContent","$reviewLink","$oldEyeIcon","summaryColor","$newEyeIcon","replaceWith","bootstrap","Popover","popoverElements","document","querySelectorAll","element","getInstance","popoverConfig","trigger","sanitize","addEventListener","e","preventDefault","popover","show","message","initializePopovers","enhanceReportTable","attemptIds","$attemptsTable","href","push","addAttemptDataAttributes","$link","closest","addIconsToReviewLinks","ajaxConfig","method","dataType","success","response","data","xhr","status","ajax","fetchBulkAttemptSummaries","color","enhanceReviewQuestionPage","getUrlParameter","fetchAttemptSummary","name","window","location","search","createCheatDetectResumeBlock","timeSpentStr","copyCountStr","focusLossCountStr","extensionDetectedStr","yesStr","noStr","$resumeBlock","padding","timeSpentText","$timeLine","text","$copyLine","focusLossCountText","$focusLine","$extensionLine","$outcomeContainer","after","$targetContainer","prepend","init","params","ready","pathname","indexOf"],"mappings":"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"}