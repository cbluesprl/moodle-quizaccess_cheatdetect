{"version":3,"file":"report_enhancer.min.js","sources":["../src/report_enhancer.js"],"sourcesContent":["/**\n * This JS is made to enhance the /mod/quiz/report.php?id=X&mode=overview core_moodle report table\n * and /mod/quiz/reviewquestion.php pages\n *\n * @module     quizaccess_cheatdetect/report_enhancer\n * @package\n * @copyright   2025 CBlue SPRL\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @author      gnormand@cblue.be\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str'], function($, Ajax, Notification, Str) {\n\n    var config = {}; // eslint-disable-line no-unused-vars\n\n    /**\n     * Initialize the report enhancer\n     * @param {object} params Configuration parameters\n     */\n    var init = function(params) {\n        config = params;\n        // Wait for DOM to be ready\n        $(document).ready(function() {\n            // Check if we are on the review question page\n            if (window.location.pathname.indexOf('reviewquestion.php') !== -1) {\n                enhanceReviewQuestionPage();\n            } else {\n                enhanceReportTable();\n            }\n        });\n    };\n\n    /**\n     * Enhance the report table with cheat detection information\n     */\n    var enhanceReportTable = function() {\n        // Find the report table\n        var domtable = $('table.generaltable');\n\n        if (domtable.length === 0) {\n            console.warn('CheatDetect: Report table not found'); // eslint-disable-line no-console\n            return;\n        }\n\n        console.log('CheatDetect: Enhancing report table'); // eslint-disable-line no-console\n\n        // Add icons next to \"Relecture de cette tentative\" links\n        addIconsToReviewLinks();\n\n        // Add icons next to question results\n        addIconsToQuestionResults();\n\n        // Get all attempt IDs from the table\n        var attemptIds = [1, 45, 78]; // Futur : extractAttemptIds($table);\n\n        if (attemptIds.length === 0) {\n            console.warn('CheatDetect: No attempts found'); // eslint-disable-line no-console\n            return;\n        }\n\n        return attemptIds;\n\n    };\n\n    /**\n     * Add icons next to \"Relecture de cette tentative\" links\n     */\n    var addIconsToReviewLinks = function() {\n        // Find all review links\n        $('.reviewlink').each(function() {\n            var $link = $(this);\n\n            // Check if icon already added\n            if ($link.find('.cheatdetect-icon').length > 0) {\n                return;\n            }\n\n            // Create icon element\n            var $icon = $('<i>')\n                .addClass('fa fa-eye cheatdetect-icon')\n                .attr('aria-hidden', 'true')\n                .css({\n                    'margin-left': '8px',\n                    'color': '#0066cc'\n                });\n\n            // Append icon to the link\n            $link.append(' ').append($icon);\n        });\n    };\n\n    /**\n     * Add icons next to question results\n     */\n    var addIconsToQuestionResults = function() {\n        // Find all question result links (links in cells that contain question grades)\n        $('table.generaltable tbody tr').each(function() {\n            var $row = $(this);\n\n            // Find cells with question results (columns after c8, which is the total grade)\n            $row.find('td[class*=\"c9\"], td[class*=\"c10\"], td[class*=\"c11\"], td[class*=\"c12\"], td[class*=\"c13\"],' +\n                      'td[class*=\"c14\"], td[class*=\"c15\"], td[class*=\"c16\"], td[class*=\"c17\"], td[class*=\"c18\"]').each(function() {\n                var $cell = $(this);\n                var $link = $cell.find('a[href*=\"reviewquestion.php\"]');\n\n                if ($link.length > 0) {\n                    // Check if icon already added\n                    if ($link.find('.cheatdetect-qicon').length > 0) {\n                        return;\n                    }\n\n                    // Create icon element\n                    var $icon = $('<i>')\n                        .addClass('fa fa-flag cheatdetect-qicon')\n                        .attr('aria-hidden', 'true')\n                        .css({\n                            'margin-left': '6px',\n                            'color': '#ff6600',\n                            'font-size': '0.9em'\n                        });\n\n                    // Append icon after the link content\n                    $link.append(' ').append($icon);\n                }\n            });\n        });\n    };\n\n    /**\n     * Enhance the review question page with cheat detection summary\n     */\n    var enhanceReviewQuestionPage = function() {\n        console.log('CheatDetect: Enhancing review question page'); // eslint-disable-line no-console\n\n        // Extract attempt and slot from URL parameters\n        var attemptId = getUrlParameter('attempt');\n        var slotId = getUrlParameter('slot');\n\n        if (!attemptId || !slotId) {\n            console.warn('CheatDetect: Missing attempt or slot parameter in URL'); // eslint-disable-line no-console\n            return;\n        }\n\n        // Fetch attempt summary data from webservice\n        fetchAttemptSummary(attemptId, slotId);\n    };\n\n    /**\n     * Get URL parameter value by name\n     * @param {string} name Parameter name\n     * @returns {string|null} Parameter value or null if not found\n     */\n    var getUrlParameter = function(name) {\n        var urlParams = new URLSearchParams(window.location.search);\n        return urlParams.get(name);\n    };\n\n    /**\n     * Fetch attempt summary data from webservice\n     * @param {string} attemptId Attempt ID\n     * @param {string} slotId Slot ID\n     */\n    var fetchAttemptSummary = function(attemptId, slotId) {\n        var url = '/local/rest/api/quizaccess_cheatdetect/attempt-summary/' + attemptId + '/slots/' + slotId;\n\n        $.ajax({\n            url: url,\n            method: 'GET',\n            dataType: 'json',\n            success: function(response) {\n                if (response.success && response.data) {\n                    createCheatDetectResumeBlock(response.data);\n                } else {\n                    console.warn('CheatDetect: Invalid response from webservice', response); // eslint-disable-line no-console\n                }\n            },\n            error: function(xhr, status, error) {\n                console.error('CheatDetect: Error fetching attempt summary', error); // eslint-disable-line no-console\n            }\n        });\n    };\n\n    /**\n     * Create and display the cheat detection resume block\n     * @param {object} data Attempt summary data from webservice\n     */\n    var createCheatDetectResumeBlock = function(data) {\n        // Check if block already exists\n        if ($('.cheatdetect_resume').length > 0) {\n            return;\n        }\n\n        // Convert time_spent from seconds to minutes\n        var timeInMinutes = Math.round(data.time_spent / 60);\n        var timePercentage = Math.round(data.time_percentage);\n\n        // Load translated strings\n        var stringKeys = [\n            {key: 'timespent', component: 'quizaccess_cheatdetect'},\n            {key: 'copycount', component: 'quizaccess_cheatdetect'},\n            {key: 'focuslosscount', component: 'quizaccess_cheatdetect'},\n            {key: 'extensiondetected', component: 'quizaccess_cheatdetect'},\n            {key: 'yes', component: 'quizaccess_cheatdetect'},\n            {key: 'no', component: 'quizaccess_cheatdetect'}\n        ];\n\n        Str.get_strings(stringKeys).then(function(strings) {\n            var timeSpentStr = strings[0];\n            var copyCountStr = strings[1];\n            var focusLossCountStr = strings[2];\n            var extensionDetectedStr = strings[3];\n            var yesStr = strings[4];\n            var noStr = strings[5];\n\n            // Determine extension detection text\n            var extensionText = data.has_extension ? yesStr : noStr;\n\n            // Create the resume block HTML\n            var $resumeBlock = $('<div>')\n                .addClass('cheatdetect_resume')\n                .css({\n                    'background-color': '#d3d3d3',\n                    'padding': '1rem 1rem',\n                    'margin-bottom': '1rem',\n                    'border': 'var(--bs-border-width) solid #fff0',\n                    'border-radius': 'var(--bs-border-radius)',\n                    'font-size': '14px',\n                    'line-height': '1.6'\n                });\n\n            // Time spent line\n            var timeSpentText = timeSpentStr\n                .replace('{$a->minutes}', timeInMinutes)\n                .replace('{$a->percentage}', timePercentage);\n            var $timeLine = $('<div>').text(timeSpentText);\n\n            // Copy count line (in red if > 0)\n            var copyCountText = copyCountStr.replace('{$a}', data.copy_count);\n            var $copyLine = $('<div>')\n                .text(copyCountText)\n                .css('color', data.copy_count > 0 ? '#ff0000' : 'inherit');\n\n            // Focus loss count line (in red if > 0)\n            var focusLossCountText = focusLossCountStr.replace('{$a}', data.focus_loss_count);\n            var $focusLine = $('<div>')\n                .text(focusLossCountText)\n                .css('color', data.focus_loss_count > 0 ? '#ff0000' : 'inherit');\n\n            // Extension detection line\n            var extensionDetectedText = extensionDetectedStr.replace('{$a}', extensionText);\n            var $extensionLine = $('<div>').text(extensionDetectedText);\n\n            // Append all lines to the block\n            $resumeBlock.append($timeLine)\n                .append($copyLine)\n                .append($focusLine)\n                .append($extensionLine);\n\n            // Insert the block after the .outcome element\n            var $outcomeContainer = $('.outcome');\n            if ($outcomeContainer.length > 0) {\n                $outcomeContainer.after($resumeBlock);\n            } else {\n                // Fallback: insert at the top of the question container\n                var $targetContainer = $('.que');\n                if ($targetContainer.length > 0) {\n                    $targetContainer.prepend($resumeBlock);\n                } else {\n                    // Last fallback: insert after the page header\n                    $('#page-content').prepend($resumeBlock);\n                }\n            }\n\n            console.log('CheatDetect: Resume block added successfully'); // eslint-disable-line no-console\n        }).catch(function(error) {\n            console.error('CheatDetect: Error loading strings', error); // eslint-disable-line no-console\n        });\n    };\n\n    return {\n        init: init\n    };\n});"],"names":["define","$","Ajax","Notification","Str","enhanceReportTable","length","console","log","addIconsToReviewLinks","addIconsToQuestionResults","attemptIds","warn","each","$link","this","find","$icon","addClass","attr","css","color","append","enhanceReviewQuestionPage","attemptId","getUrlParameter","slotId","fetchAttemptSummary","name","URLSearchParams","window","location","search","get","url","ajax","method","dataType","success","response","data","createCheatDetectResumeBlock","error","xhr","status","timeInMinutes","Math","round","time_spent","timePercentage","time_percentage","get_strings","key","component","then","strings","timeSpentStr","copyCountStr","focusLossCountStr","extensionDetectedStr","yesStr","noStr","extensionText","has_extension","$resumeBlock","padding","border","timeSpentText","replace","$timeLine","text","copyCountText","copy_count","$copyLine","focusLossCountText","focus_loss_count","$focusLine","extensionDetectedText","$extensionLine","$outcomeContainer","after","$targetContainer","prepend","catch","init","params","document","ready","pathname","indexOf"],"mappings":"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"}