{"version":3,"file":"metrics-manager.min.js","sources":["../../src/extension-detector/metrics-manager.js"],"sourcesContent":["/**\n * @fileoverview Gestionnaire de métriques ultra-simplifié pour la détection d'extensions\n * @module quizaccess_cheatdetect/extension-detector/metrics-manager\n * @copyright 2025 CBlue SRL <support@cblue.be>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since 1.0.0\n */\n\ndefine([\n    'quizaccess_cheatdetect/extension-detector/config',\n    'quizaccess_cheatdetect/shared/utils'\n], function(Config, SharedUtils) {\n    'use strict';\n\n    /**\n     * @typedef {Object} DetectedElement\n     * @property {string} uid - Identifiant unique de l'élément détecté\n     * @property {string} timestamp - Horodatage ISO de la détection\n     * @property {string} DOM - HTML externe de l'élément\n     * @property {string|null} shadowDOM - HTML du Shadow DOM si présent\n     * @property {string} detection - Méthode de détection utilisée\n     */\n\n    /**\n     * @typedef {Object} ExtensionMetrics\n     * @property {DetectedElement[]} detectedElements - Liste des éléments détectés\n     */\n\n    /**\n     * @typedef {Object} MetricsData\n     * @property {Object.<string, ExtensionMetrics>} extensions - Métriques par extension\n     */\n\n    /**\n     * @typedef {Object} ExportData\n     * @property {string} timestamp - Horodatage de l'export\n     * @property {Object.<string, Object>} extensionDetection - Données d'export par extension\n     */\n\n    /**\n     * Constructeur du gestionnaire de métriques\n     * @class MetricsManager\n     * @example\n     * const manager = new MetricsManager();\n     * @since 1.0.0\n     */\n    var MetricsManager = function() {\n        this.data = {\n            extensions: {}\n        };\n\n        this._sessionStart = Date.now();\n    };\n\n    /**\n     * Enregistre un élément détecté pour une extension\n     * @memberof MetricsManager\n     * @function logDetectedElement\n     * @param {string} extensionKey - Clé de l'extension\n     * @param {Object} elementInfo - Informations sur l'élément détecté\n     * @param {string} elementInfo.DOM - HTML externe de l'élément\n     * @param {string|null} elementInfo.shadowDOM - HTML du Shadow DOM\n     * @param {string} elementInfo.detection - Méthode de détection\n     * @example\n     * manager.logDetectedElement('crowdly', {\n     *   DOM: '<div class=\"crowd-element\">...</div>',\n     *   shadowDOM: null,\n     *   detection: 'Classe trouvée : crowd'\n     * });\n     * @since 1.0.0\n     */\n    MetricsManager.prototype.logDetectedElement = function(extensionKey, elementInfo) {\n        this._initExtension(extensionKey);\n\n        var detectedElement = {\n            uid: Date.now().toString(36) + Math.random().toString(36).substring(2, 7),\n            extensionKey: extensionKey,\n            timestamp: new Date().toISOString()\n        };\n\n        // Copier les propriétés de elementInfo\n        for (var key in elementInfo) {\n            if (elementInfo.hasOwnProperty(key)) {\n                detectedElement[key] = elementInfo[key];\n            }\n        }\n\n        this.data.extensions[extensionKey].detectedElements.push(detectedElement);\n    };\n\n    /**\n     * Initialise les données d'extension si nécessaire\n     * @memberof MetricsManager\n     * @function _initExtension\n     * @param {string} extensionKey - Clé de l'extension\n     * @private\n     * @since 1.0.0\n     */\n    MetricsManager.prototype._initExtension = function(extensionKey) {\n        if (!this.data.extensions[extensionKey]) {\n            this.data.extensions[extensionKey] = {\n                detectedElements: []\n            };\n        }\n    };\n\n    /**\n     * Exporte toutes les données au format JSON\n     * @memberof MetricsManager\n     * @function exportMetricsAsJSON\n     * @returns {string} Chaîne JSON contenant toutes les métriques\n     * @example\n     * const jsonData = manager.exportMetricsAsJSON();\n     * const metrics = JSON.parse(jsonData);\n     * console.log(metrics.extensionDetection);\n     * @since 1.0.0\n     */\n    MetricsManager.prototype.exportMetricsAsJSON = function() {\n        var exportData = {\n            timestamp: new Date().toISOString(),\n            extensionDetection: {}\n        };\n\n        // Transformer la structure pour chaque extension\n        var self = this;\n        Object.keys(this.data.extensions).forEach(function(extensionKey) {\n            var ext = self.data.extensions[extensionKey];\n            var extensionConfig = Config.getExtension(extensionKey);\n\n            exportData.extensionDetection[extensionKey] = {\n                name: extensionConfig ? extensionConfig.name : extensionKey,\n                detected: ext.detectedElements\n            };\n        });\n\n        return JSON.stringify(exportData, null, 2);\n    };\n\n    /**\n     * Réinitialise toutes les données\n     * @memberof MetricsManager\n     * @function reset\n     * @example\n     * manager.reset();\n     * @since 1.0.0\n     */\n    MetricsManager.prototype.reset = function() {\n        this.data = {\n            extensions: {}\n        };\n        this._sessionStart = Date.now();\n    };\n\n    /**\n     * Obtient les données actuelles\n     * @memberof MetricsManager\n     * @function getData\n     * @returns {MetricsData} Données actuelles du gestionnaire\n     * @example\n     * const data = manager.getData();\n     * console.log('Extensions suivies:', Object.keys(data.extensions));\n     * @since 1.0.0\n     */\n    MetricsManager.prototype.getData = function() {\n        return this.data;\n    };\n\n    return {\n        MetricsManager: MetricsManager\n    };\n});"],"names":["define","Config","SharedUtils","MetricsManager","data","extensions","_sessionStart","Date","now","prototype","logDetectedElement","extensionKey","elementInfo","_initExtension","detectedElement","uid","toString","Math","random","substring","timestamp","toISOString","key","hasOwnProperty","detectedElements","push","this","exportMetricsAsJSON","exportData","extensionDetection","self","Object","keys","forEach","ext","extensionConfig","getExtension","name","detected","JSON","stringify","reset","getData"],"mappings":";;;;;;;AAQAA,mEAAO,CACH,mDACA,wCACD,SAASC,OAAQC,iBAmCZC,eAAiB,gBACZC,KAAO,CACRC,WAAY,SAGXC,cAAgBC,KAAKC,cAoB9BL,eAAeM,UAAUC,mBAAqB,SAASC,aAAcC,kBAC5DC,eAAeF,kBAEhBG,gBAAkB,CAClBC,IAAKR,KAAKC,MAAMQ,SAAS,IAAMC,KAAKC,SAASF,SAAS,IAAIG,UAAU,EAAG,GACvER,aAAcA,aACdS,WAAW,IAAIb,MAAOc,mBAIrB,IAAIC,OAAOV,YACRA,YAAYW,eAAeD,OAC3BR,gBAAgBQ,KAAOV,YAAYU,WAItClB,KAAKC,WAAWM,cAAca,iBAAiBC,KAAKX,kBAW7DX,eAAeM,UAAUI,eAAiB,SAASF,cAC1Ce,KAAKtB,KAAKC,WAAWM,qBACjBP,KAAKC,WAAWM,cAAgB,CACjCa,iBAAkB,MAgB9BrB,eAAeM,UAAUkB,oBAAsB,eACvCC,WAAa,CACbR,WAAW,IAAIb,MAAOc,cACtBQ,mBAAoB,IAIpBC,KAAOJ,YACXK,OAAOC,KAAKN,KAAKtB,KAAKC,YAAY4B,SAAQ,SAAStB,kBAC3CuB,IAAMJ,KAAK1B,KAAKC,WAAWM,cAC3BwB,gBAAkBlC,OAAOmC,aAAazB,cAE1CiB,WAAWC,mBAAmBlB,cAAgB,CAC1C0B,KAAMF,gBAAkBA,gBAAgBE,KAAO1B,aAC/C2B,SAAUJ,IAAIV,qBAIfe,KAAKC,UAAUZ,WAAY,KAAM,IAW5CzB,eAAeM,UAAUgC,MAAQ,gBACxBrC,KAAO,CACRC,WAAY,SAEXC,cAAgBC,KAAKC,OAa9BL,eAAeM,UAAUiC,QAAU,kBACxBhB,KAAKtB,MAGT,CACHD,eAAgBA"}