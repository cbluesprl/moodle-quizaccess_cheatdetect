{"version":3,"file":"metrics-manager.min.js","sources":["../../src/extension-detector/metrics-manager.js"],"sourcesContent":["/**\n * @fileoverview Ultra-simplified metrics manager for extension detection\n * @module quizaccess_cheatdetect/extension-detector/metrics-manager\n * @copyright 2025 CBlue SRL <support@cblue.be>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since 1.0.0\n */\n\ndefine([\n    'quizaccess_cheatdetect/extension-detector/config'\n], function(Config) {\n    'use strict';\n\n    /**\n     * @typedef {Object} DetectedElement\n     * @property {string} uid - Unique identifier of detected element\n     * @property {string} timestamp - ISO timestamp of detection\n     * @property {string} DOM - Element outer HTML\n     * @property {string|null} shadowDOM - Shadow DOM HTML if present\n     * @property {string} detection - Detection method used\n     */\n\n    /**\n     * @typedef {Object} ExtensionMetrics\n     * @property {DetectedElement[]} detectedElements - List of detected elements\n     */\n\n    /**\n     * @typedef {Object} MetricsData\n     * @property {Object.<string, ExtensionMetrics>} extensions - Metrics per extension\n     */\n\n    /**\n     * @typedef {Object} ExportData\n     * @property {string} timestamp - Export timestamp\n     * @property {Object.<string, Object>} extensionDetection - Export data per extension\n     */\n\n    /**\n     * Metrics manager constructor\n     * @class MetricsManager\n     * @example\n     * const manager = new MetricsManager();\n     * @since 1.0.0\n     */\n    var MetricsManager = function() {\n        this.data = {\n            extensions: {}\n        };\n\n        this._sessionStart = Date.now();\n    };\n\n    /**\n     * Log a detected element for an extension\n     * @memberof MetricsManager\n     * @function logDetectedElement\n     * @param {string} extensionKey - Extension key\n     * @param {Object} elementInfo - Detected element information\n     * @param {string} elementInfo.DOM - Element outer HTML\n     * @param {string|null} elementInfo.shadowDOM - Shadow DOM HTML\n     * @param {string} elementInfo.detection - Detection method\n     * @example\n     * manager.logDetectedElement('crowdly', {\n     *   DOM: '<div class=\"crowd-element\">...</div>',\n     *   shadowDOM: null,\n     *   detection: 'Class found: crowd'\n     * });\n     * @since 1.0.0\n     */\n    MetricsManager.prototype.logDetectedElement = function(extensionKey, elementInfo) {\n        this._initExtension(extensionKey);\n\n        var detectedElement = {\n            uid: Date.now().toString(36) + Math.random().toString(36).substring(2, 7),\n            extensionKey: extensionKey,\n            timestamp: new Date().toISOString()\n        };\n\n        // Copy elementInfo properties\n        for (var key in elementInfo) {\n            if (elementInfo.hasOwnProperty(key)) {\n                detectedElement[key] = elementInfo[key];\n            }\n        }\n\n        this.data.extensions[extensionKey].detectedElements.push(detectedElement);\n    };\n\n    /**\n     * Initialize extension data if necessary\n     * @memberof MetricsManager\n     * @function _initExtension\n     * @param {string} extensionKey - Extension key\n     * @private\n     * @since 1.0.0\n     */\n    MetricsManager.prototype._initExtension = function(extensionKey) {\n        if (!this.data.extensions[extensionKey]) {\n            this.data.extensions[extensionKey] = {\n                detectedElements: []\n            };\n        }\n    };\n\n    /**\n     * Export all data as JSON\n     * @memberof MetricsManager\n     * @function exportMetricsAsJSON\n     * @returns {string} JSON string containing all metrics\n     * @example\n     * const jsonData = manager.exportMetricsAsJSON();\n     * const metrics = JSON.parse(jsonData);\n     * console.log(metrics.extensionDetection);\n     * @since 1.0.0\n     */\n    MetricsManager.prototype.exportMetricsAsJSON = function() {\n        var exportData = {\n            timestamp: new Date().toISOString(),\n            extensionDetection: {}\n        };\n\n        // Transform structure for each extension\n        var self = this;\n        Object.keys(this.data.extensions).forEach(function(extensionKey) {\n            var ext = self.data.extensions[extensionKey];\n            var extensionConfig = Config.getExtension(extensionKey);\n\n            exportData.extensionDetection[extensionKey] = {\n                name: extensionConfig ? extensionConfig.name : extensionKey,\n                detected: ext.detectedElements\n            };\n        });\n\n        return JSON.stringify(exportData, null, 2);\n    };\n\n    /**\n     * Reset all data\n     * @memberof MetricsManager\n     * @function reset\n     * @example\n     * manager.reset();\n     * @since 1.0.0\n     */\n    MetricsManager.prototype.reset = function() {\n        this.data = {\n            extensions: {}\n        };\n        this._sessionStart = Date.now();\n    };\n\n    /**\n     * Get current data\n     * @memberof MetricsManager\n     * @function getData\n     * @returns {MetricsData} Current manager data\n     * @example\n     * const data = manager.getData();\n     * console.log('Tracked extensions:', Object.keys(data.extensions));\n     * @since 1.0.0\n     */\n    MetricsManager.prototype.getData = function() {\n        return this.data;\n    };\n\n    return {\n        MetricsManager: MetricsManager\n    };\n});\n"],"names":["define","Config","MetricsManager","this","data","extensions","_sessionStart","Date","now","prototype","logDetectedElement","extensionKey","elementInfo","_initExtension","detectedElement","uid","toString","Math","random","substring","timestamp","toISOString","key","hasOwnProperty","detectedElements","push","exportMetricsAsJSON","exportData","extensionDetection","self","Object","keys","forEach","ext","extensionConfig","getExtension","name","detected","JSON","stringify","reset","getData"],"mappings":";;;;;;;AAQAA,mEAAO,CACH,oDACD,SAASC,QAmCR,IAAIC,eAAiB,WACjBC,KAAKC,KAAO,CACRC,WAAY,CAAC,GAGjBF,KAAKG,cAAgBC,KAAKC,OAoH9B,OAhGAN,eAAeO,UAAUC,mBAAqB,SAASC,aAAcC,aACjET,KAAKU,eAAeF,cAEpB,IAAIG,gBAAkB,CAClBC,IAAKR,KAAKC,MAAMQ,SAAS,IAAMC,KAAKC,SAASF,SAAS,IAAIG,UAAU,EAAG,GACvER,aAAcA,aACdS,WAAW,IAAIb,MAAOc,eAI1B,IAAK,IAAIC,OAAOV,YACRA,YAAYW,eAAeD,OAC3BR,gBAAgBQ,KAAOV,YAAYU,MAI3CnB,KAAKC,KAAKC,WAAWM,cAAca,iBAAiBC,KAAKX,kBAW7DZ,eAAeO,UAAUI,eAAiB,SAASF,cAC1CR,KAAKC,KAAKC,WAAWM,gBACtBR,KAAKC,KAAKC,WAAWM,cAAgB,CACjCa,iBAAkB,MAgB9BtB,eAAeO,UAAUiB,oBAAsB,WAC3C,IAAIC,WAAa,CACbP,WAAW,IAAIb,MAAOc,cACtBO,mBAAoB,CAAC,GAIrBC,KAAO1B,KAWX,OAVA2B,OAAOC,KAAK5B,KAAKC,KAAKC,YAAY2B,QAAQ,SAASrB,cAC/C,IAAIsB,IAAMJ,KAAKzB,KAAKC,WAAWM,cAC3BuB,gBAAkBjC,OAAOkC,aAAaxB,cAE1CgB,WAAWC,mBAAmBjB,cAAgB,CAC1CyB,KAAMF,gBAAkBA,gBAAgBE,KAAOzB,aAC/C0B,SAAUJ,IAAIT,iBAEtB,GAEOc,KAAKC,UAAUZ,WAAY,KAAM,IAW5CzB,eAAeO,UAAU+B,MAAQ,WAC7BrC,KAAKC,KAAO,CACRC,WAAY,CAAC,GAEjBF,KAAKG,cAAgBC,KAAKC,OAa9BN,eAAeO,UAAUgC,QAAU,WAC/B,OAAOtC,KAAKC,MAGT,CACHF,eAAgBA,eAExB"}