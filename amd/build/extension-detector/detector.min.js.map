{"version":3,"file":"detector.min.js","sources":["../../src/extension-detector/detector.js"],"sourcesContent":["/**\n * @fileoverview D√©tecteur d'extensions principal avec gestionnaire de m√©triques\n * @module quizaccess_cheatdetect/extension-detector/detector\n * @copyright 2025 CBlue SRL <support@cblue.be>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since 1.0.0\n */\n\ndefine([\n    'quizaccess_cheatdetect/extension-detector/config',\n    'quizaccess_cheatdetect/extension-detector/browser',\n    'quizaccess_cheatdetect/extension-detector/shadow',\n    'quizaccess_cheatdetect/shared/utils',\n    'quizaccess_cheatdetect/extension-detector/metrics-manager'\n], function(Config, Browser, Shadow, SharedUtils, MetricsManager) {\n    'use strict';\n\n    /**\n     * @typedef {Object} ExtensionDetectorState\n     * @property {Set<string>} detectedExtensions - Extensions d√©tect√©es\n     * @property {Map<string, number>} extensionPaths - Chemins d'extension avec timestamp\n     * @property {boolean} isRunning - √âtat de fonctionnement\n     */\n\n    /**\n     * Constructeur du d√©tecteur d'extensions principal\n     * @class ExtensionDetector\n     * @throws {Error} Si le navigateur n'est pas support√©\n     * @example\n     * const detector = new ExtensionDetector();\n     * detector.start();\n     * @since 1.0.0\n     */\n    var ExtensionDetector = function() {\n        var self = this;\n\n        this.browserHandler = new Browser.BrowserHandler();\n        this.shadowMonitor = new Shadow.ShadowMonitor(function(extensionKey, extension, method) {\n            self._onExtensionDetected(extensionKey, extension, method);\n        });\n\n        // Gestionnaire de m√©triques simplifi√©\n        this.metricsManager = new MetricsManager.MetricsManager();\n\n        // Connexion du gestionnaire de m√©triques au moniteur shadow\n        this.shadowMonitor.setMetricsManager(this.metricsManager);\n\n        // √âtat de d√©tection\n        this.detectedExtensions = new Set();\n        this.extensionPaths = new Map();\n        this.isRunning = false;\n    };\n\n    /**\n     * D√©marre le syst√®me de d√©tection\n     * @memberof ExtensionDetector\n     * @function start\n     * @throws {Error} Si le d√©marrage √©choue\n     * @example\n     * detector.start();\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.start = function() {\n        if (this.isRunning) {\n            if (Config.SETTINGS.enableLogging) {\n                console.warn('üß© Extension Detector: D√©j√† en cours d\\'ex√©cution');\n            }\n            return;\n        }\n\n        this.isRunning = true;\n\n        try {\n            // R√©initialiser l'√©tat\n            this._resetState();\n\n            // D√©marrer la surveillance du Shadow DOM\n            this.shadowMonitor.start();\n\n        } catch (error) {\n            console.error('üß© Extension Detector: √âchec du d√©marrage', error);\n            this.isRunning = false;\n            throw error;\n        }\n    };\n\n    /**\n     * Arr√™te le syst√®me de d√©tection\n     * @memberof ExtensionDetector\n     * @function stop\n     * @example\n     * detector.stop();\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.stop = function() {\n        if (!this.isRunning) {\n return;\n}\n\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Arr√™t du syst√®me de d√©tection');\n        }\n        this.isRunning = false;\n\n        // Arr√™ter les composants\n        this.shadowMonitor.stop();\n        this.browserHandler.cleanup();\n\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Syst√®me de d√©tection arr√™t√©');\n        }\n    };\n\n    /**\n     * Red√©marre le syst√®me de d√©tection\n     * @memberof ExtensionDetector\n     * @function restart\n     * @example\n     * detector.restart();\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.restart = function() {\n        var self = this;\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Red√©marrage du syst√®me');\n        }\n        this.stop();\n        setTimeout(function() {\n            self.start();\n        }, 1000);\n    };\n\n    /**\n     * G√®re la d√©tection d'extension\n     * @memberof ExtensionDetector\n     * @function _onExtensionDetected\n     * @param {string} extensionKey - Cl√© de l'extension\n     * @param {Object} extension - Configuration de l'extension\n     * @param {string} method - M√©thode de d√©tection utilis√©e\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._onExtensionDetected = function(extensionKey, extension, method) {\n        // √âviter les d√©tections dupliqu√©es\n        if (this.detectedExtensions.has(extensionKey)) {\n return;\n}\n\n        this.detectedExtensions.add(extensionKey);\n\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üö® Extension Detector: ' + extension.name + ' d√©tect√©e via ' + method);\n        }\n\n        // Logger l'√©v√©nement de d√©tection\n        if (Config.SETTINGS.enableLogging) {\n            this._logDetection(extensionKey, extension.name, method);\n        }\n    };\n\n    /**\n     * G√®re la d√©tection d'ID d'extension\n     * @memberof ExtensionDetector\n     * @function _onExtensionIdDetected\n     * @param {string} extensionPath - Chemin de l'extension\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._onExtensionIdDetected = function(extensionPath) {\n        var self = this;\n\n        console.log('extensionPath', extensionPath);\n        if (this.extensionPaths.has(extensionPath)) {\n return;\n}\n\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Chemin d\\'extension d√©tect√© - ' + extensionPath);\n        }\n        this.extensionPaths.set(extensionPath, Date.now());\n\n        // V√©rifier si l'extension est accessible\n        this.browserHandler.isExtensionAccessible(extensionPath)\n            .then(function(isAccessible) {\n                if (!isAccessible) {\n                    if (Config.SETTINGS.enableLogging) {\n                        console.warn('üß© Extension Detector: Extension √† ' + extensionPath + ' non accessible');\n                    }\n                    return;\n                }\n\n                // V√©rifier les fichiers pour toutes les extensions configur√©es\n                self._checkFilesForAllExtensions(extensionPath);\n            });\n    };\n\n    /**\n     * V√©rifie les fichiers d'extension pour toutes les configurations\n     * @memberof ExtensionDetector\n     * @function _checkFilesForAllExtensions\n     * @param {string} extensionPath - Chemin de l'extension\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._checkFilesForAllExtensions = function(extensionPath) {\n        var self = this;\n        var extensions = Config.getAllExtensions();\n\n        extensions.forEach(function(extension) {\n            if (!extension.files || Object.keys(extension.files).length === 0) {\n return;\n}\n\n            self.browserHandler.checkFiles(extensionPath, extension.files)\n                .then(function(result) {\n                    if (result.detected) {\n                        self._onExtensionDetected(extension.key, extension, 'fileCheck');\n                    }\n                })\n                .catch(function(error) {\n                    if (Config.SETTINGS.enableLogging) {\n                        console.error('üß© Extension Detector: Erreur lors de la v√©rification des fichiers pour ' + extension.key, error);\n                    }\n                });\n        });\n    };\n\n    /**\n     * R√©initialise l'√©tat de d√©tection\n     * @memberof ExtensionDetector\n     * @function _resetState\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._resetState = function() {\n        this.detectedExtensions.clear();\n        this.extensionPaths.clear();\n        this.shadowMonitor.reset();\n        this.metricsManager.reset();\n    };\n\n    /**\n     * Obtient les statistiques de d√©tection avec m√©triques simplifi√©es\n     * @memberof ExtensionDetector\n     * @function getStatistics\n     * @returns {Object} Statistiques de d√©tection\n     * @property {number} totalDetections - Nombre total de d√©tections\n     * @property {number} uniquePaths - Nombre de chemins uniques\n     * @property {number} sessionDetections - D√©tections de session\n     * @property {string[]} detectedExtensionsList - Liste des extensions d√©tect√©es\n     * @property {Object|null} lastDetection - Derni√®re d√©tection\n     * @property {Object} metricsData - Donn√©es de m√©triques\n     * @example\n     * const stats = detector.getStatistics();\n     * console.log('Extensions d√©tect√©es:', stats.detectedExtensionsList);\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.getStatistics = function() {\n        var sessionDetections = [];\n        try {\n            sessionDetections = JSON.parse(sessionStorage.getItem('extensionDetections') || '[]');\n        } catch (error) {\n            if (Config.SETTINGS.enableLogging) {\n                console.warn('üß© Extension Detector: Impossible de lire les d√©tections de session', error);\n            }\n        }\n\n        return {\n            totalDetections: this.detectedExtensions.size,\n            uniquePaths: this.extensionPaths.size,\n            sessionDetections: sessionDetections.length,\n            detectedExtensionsList: Array.from(this.detectedExtensions),\n            lastDetection: sessionDetections.length > 0 ? sessionDetections[sessionDetections.length - 1] : null,\n            metricsData: this.metricsManager.getData()\n        };\n    };\n\n    /**\n     * Exporte les m√©triques au format JSON\n     * @memberof ExtensionDetector\n     * @function exportMetricsAsJSON\n     * @returns {string} Cha√Æne JSON des m√©triques\n     * @example\n     * const jsonMetrics = detector.exportMetricsAsJSON();\n     * const metrics = JSON.parse(jsonMetrics);\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.exportMetricsAsJSON = function() {\n        return this.metricsManager.exportMetricsAsJSON();\n    };\n\n    /**\n     * Ajoute le support pour une nouvelle extension\n     * @memberof ExtensionDetector\n     * @function addExtensionSupport\n     * @param {string} extensionKey - Cl√© de l'extension\n     * @param {string} extensionName - Nom de l'extension\n     * @example\n     * detector.addExtensionSupport('newExt', 'Nouvelle Extension');\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.addExtensionSupport = function(extensionKey, extensionName) {\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Support ajout√© pour l\\'extension: ' + extensionName);\n        }\n    };\n\n    /**\n     * Obtient la configuration d'extension\n     * @memberof ExtensionDetector\n     * @function getExtensionConfig\n     * @param {string} extensionKey - Cl√© de l'extension\n     * @returns {Object|null} Configuration de l'extension\n     * @example\n     * const config = detector.getExtensionConfig('crowdly');\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.getExtensionConfig = function(extensionKey) {\n        return Config.getExtension(extensionKey);\n    };\n\n    /**\n     * Nettoie les ressources\n     * @memberof ExtensionDetector\n     * @function cleanup\n     * @example\n     * detector.cleanup();\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.cleanup = function() {\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Nettoyage des ressources');\n        }\n\n        this.stop();\n    };\n\n    /**\n     * Enregistre un √©v√©nement de d√©tection\n     * @memberof ExtensionDetector\n     * @function _logDetection\n     * @param {string} extensionKey - Cl√© de l'extension\n     * @param {string} extensionName - Nom de l'extension\n     * @param {string} method - M√©thode de d√©tection\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._logDetection = function(extensionKey, extensionName, method) {\n        if (!Config.SETTINGS.enableLogging) {\n return;\n}\n\n        var event = {\n            timestamp: SharedUtils.generateTimestamp().unix,\n            extension: extensionKey,\n            extensionName: extensionName,\n            method: method,\n            url: window.location.href,\n            userAgent: navigator.userAgent\n        };\n\n        try {\n            var history = JSON.parse(sessionStorage.getItem('extensionDetections') || '[]');\n            history.push(event);\n            sessionStorage.setItem('extensionDetections', JSON.stringify(history));\n        } catch (error) {\n            console.warn('üß© Extension Detector: Impossible d\\'enregistrer l\\'√©v√©nement de d√©tection', error);\n        }\n    };\n\n    return {\n        ExtensionDetector: ExtensionDetector\n    };\n});"],"names":["define","Config","Browser","Shadow","SharedUtils","MetricsManager","ExtensionDetector","self","this","browserHandler","BrowserHandler","shadowMonitor","ShadowMonitor","extensionKey","extension","method","_onExtensionDetected","metricsManager","setMetricsManager","detectedExtensions","Set","extensionPaths","Map","isRunning","prototype","start","SETTINGS","enableLogging","console","warn","_resetState","error","stop","log","cleanup","restart","setTimeout","has","add","name","_logDetection","_onExtensionIdDetected","extensionPath","set","Date","now","isExtensionAccessible","then","isAccessible","_checkFilesForAllExtensions","getAllExtensions","forEach","files","Object","keys","length","checkFiles","result","detected","key","catch","clear","reset","getStatistics","sessionDetections","JSON","parse","sessionStorage","getItem","totalDetections","size","uniquePaths","detectedExtensionsList","Array","from","lastDetection","metricsData","getData","exportMetricsAsJSON","addExtensionSupport","extensionName","getExtensionConfig","getExtension","event","timestamp","generateTimestamp","unix","url","window","location","href","userAgent","navigator","history","push","setItem","stringify"],"mappings":"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"}