{"version":3,"file":"detector.min.js","sources":["../../src/extension-detector/detector.js"],"sourcesContent":["/**\n * @fileoverview D√©tecteur d'extensions principal avec gestionnaire de m√©triques\n * @module quizaccess_cheatdetect/extension-detector/detector\n * @copyright 2025 CBlue SRL <support@cblue.be>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since 1.0.0\n */\n\ndefine([\n    'quizaccess_cheatdetect/extension-detector/config',\n    'quizaccess_cheatdetect/extension-detector/browser',\n    'quizaccess_cheatdetect/extension-detector/shadow',\n    'quizaccess_cheatdetect/shared/utils',\n    'quizaccess_cheatdetect/extension-detector/metrics-manager',\n    'quizaccess_cheatdetect/shared/modal'\n], function(Config, Browser, Shadow, SharedUtils, MetricsManager, Modal) {\n    'use strict';\n\n    /**\n     * @typedef {Object} ExtensionDetectorState\n     * @property {Set<string>} detectedExtensions - Extensions d√©tect√©es\n     * @property {Map<string, number>} extensionPaths - Chemins d'extension avec timestamp\n     * @property {boolean} isRunning - √âtat de fonctionnement\n     * @property {boolean} modalShown - Modale d√©j√† affich√©e\n     */\n\n    /**\n     * Constructeur du d√©tecteur d'extensions principal\n     * @class ExtensionDetector\n     * @throws {Error} Si le navigateur n'est pas support√©\n     * @example\n     * const detector = new ExtensionDetector();\n     * detector.start();\n     * @since 1.0.0\n     */\n    var ExtensionDetector = function() {\n        var self = this;\n\n        this.browserHandler = new Browser.BrowserHandler();\n        this.shadowMonitor = new Shadow.ShadowMonitor(function(extensionKey, extension, method) {\n            self._onExtensionDetected(extensionKey, extension, method);\n        });\n\n        // Gestionnaire de m√©triques simplifi√©\n        this.metricsManager = new MetricsManager.MetricsManager();\n\n        // Connexion du gestionnaire de m√©triques au moniteur shadow\n        this.shadowMonitor.setMetricsManager(this.metricsManager);\n\n        // √âtat de d√©tection\n        this.detectedExtensions = new Set();\n        this.extensionPaths = new Map();\n        this.isRunning = false;\n        this.modalShown = false;\n    };\n\n    /**\n     * D√©marre le syst√®me de d√©tection\n     * @memberof ExtensionDetector\n     * @function start\n     * @throws {Error} Si le d√©marrage √©choue\n     * @example\n     * detector.start();\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.start = function() {\n        if (this.isRunning) {\n            if (Config.SETTINGS.enableLogging) {\n                console.warn('üß© Extension Detector: D√©j√† en cours d\\'ex√©cution');\n            }\n            return;\n        }\n\n        this.isRunning = true;\n\n        try {\n            // R√©initialiser l'√©tat\n            this._resetState();\n\n            // D√©marrer la surveillance du Shadow DOM\n            this.shadowMonitor.start();\n\n        } catch (error) {\n            console.error('üß© Extension Detector: √âchec du d√©marrage', error);\n            this.isRunning = false;\n            throw error;\n        }\n    };\n\n    /**\n     * Arr√™te le syst√®me de d√©tection\n     * @memberof ExtensionDetector\n     * @function stop\n     * @example\n     * detector.stop();\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.stop = function() {\n        if (!this.isRunning) return;\n\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Arr√™t du syst√®me de d√©tection');\n        }\n        this.isRunning = false;\n\n        // Arr√™ter les composants\n        this.shadowMonitor.stop();\n        this.browserHandler.cleanup();\n\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Syst√®me de d√©tection arr√™t√©');\n        }\n    };\n\n    /**\n     * Red√©marre le syst√®me de d√©tection\n     * @memberof ExtensionDetector\n     * @function restart\n     * @example\n     * detector.restart();\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.restart = function() {\n        var self = this;\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Red√©marrage du syst√®me');\n        }\n        this.stop();\n        setTimeout(function() {\n            self.start();\n        }, 1000);\n    };\n\n    /**\n     * G√®re la d√©tection d'extension\n     * @memberof ExtensionDetector\n     * @function _onExtensionDetected\n     * @param {string} extensionKey - Cl√© de l'extension\n     * @param {Object} extension - Configuration de l'extension\n     * @param {string} method - M√©thode de d√©tection utilis√©e\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._onExtensionDetected = function(extensionKey, extension, method) {\n        // √âviter les d√©tections dupliqu√©es\n        if (this.detectedExtensions.has(extensionKey)) return;\n\n        this.detectedExtensions.add(extensionKey);\n\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üö® Extension Detector: ' + extension.name + ' d√©tect√©e via ' + method);\n        }\n\n        // Logger l'√©v√©nement de d√©tection\n        if (Config.SETTINGS.enableLogging) {\n            this._logDetection(extensionKey, extension.name, method);\n        }\n\n        // CORRECTION: Afficher la modale TOUJOURS (s√©curit√© critique)\n        // m√™me si startDetection = false dans les param√®tres backend\n        if (!this.modalShown) {\n            this._showWarningModal(extension);\n        }\n    };\n\n    /**\n     * G√®re la d√©tection d'ID d'extension\n     * @memberof ExtensionDetector\n     * @function _onExtensionIdDetected\n     * @param {string} extensionPath - Chemin de l'extension\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._onExtensionIdDetected = function(extensionPath) {\n        var self = this;\n\n        if (this.extensionPaths.has(extensionPath)) return;\n\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Chemin d\\'extension d√©tect√© - ' + extensionPath);\n        }\n        this.extensionPaths.set(extensionPath, Date.now());\n\n        // V√©rifier si l'extension est accessible\n        this.browserHandler.isExtensionAccessible(extensionPath)\n            .then(function(isAccessible) {\n                if (!isAccessible) {\n                    if (Config.SETTINGS.enableLogging) {\n                        console.warn('üß© Extension Detector: Extension √† ' + extensionPath + ' non accessible');\n                    }\n                    return;\n                }\n\n                // V√©rifier les fichiers pour toutes les extensions configur√©es\n                self._checkFilesForAllExtensions(extensionPath);\n            });\n    };\n\n    /**\n     * V√©rifie les fichiers d'extension pour toutes les configurations\n     * @memberof ExtensionDetector\n     * @function _checkFilesForAllExtensions\n     * @param {string} extensionPath - Chemin de l'extension\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._checkFilesForAllExtensions = function(extensionPath) {\n        var self = this;\n        var extensions = Config.getAllExtensions();\n\n        extensions.forEach(function(extension) {\n            if (!extension.files || Object.keys(extension.files).length === 0) return;\n\n            self.browserHandler.checkFiles(extensionPath, extension.files)\n                .then(function(result) {\n                    if (result.detected) {\n                        self._onExtensionDetected(extension.key, extension, 'fileCheck');\n                    }\n                })\n                .catch(function(error) {\n                    if (Config.SETTINGS.enableLogging) {\n                        console.error('üß© Extension Detector: Erreur lors de la v√©rification des fichiers pour ' + extension.key, error);\n                    }\n                });\n        });\n    };\n\n    /**\n     * Affiche la modale d'avertissement\n     * @memberof ExtensionDetector\n     * @function _showWarningModal\n     * @param {Object} extension - Configuration de l'extension\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._showWarningModal = function(extension) {\n        this.modalShown = true;\n        try {\n            Modal.showModal(extension, Config.UI.modal);\n        } catch (error) {\n            console.error('üß© Extension Detector: √âchec de l\\'affichage de la modale', error);\n        }\n    };\n\n    /**\n     * R√©initialise l'√©tat de d√©tection\n     * @memberof ExtensionDetector\n     * @function _resetState\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._resetState = function() {\n        this.detectedExtensions.clear();\n        this.extensionPaths.clear();\n        this.modalShown = false;\n        this.shadowMonitor.reset();\n        this.metricsManager.reset();\n    };\n\n    /**\n     * Obtient les statistiques de d√©tection avec m√©triques simplifi√©es\n     * @memberof ExtensionDetector\n     * @function getStatistics\n     * @returns {Object} Statistiques de d√©tection\n     * @property {number} totalDetections - Nombre total de d√©tections\n     * @property {number} uniquePaths - Nombre de chemins uniques\n     * @property {number} sessionDetections - D√©tections de session\n     * @property {string[]} detectedExtensionsList - Liste des extensions d√©tect√©es\n     * @property {Object|null} lastDetection - Derni√®re d√©tection\n     * @property {Object} metricsData - Donn√©es de m√©triques\n     * @example\n     * const stats = detector.getStatistics();\n     * console.log('Extensions d√©tect√©es:', stats.detectedExtensionsList);\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.getStatistics = function() {\n        var sessionDetections = [];\n        try {\n            sessionDetections = JSON.parse(sessionStorage.getItem('extensionDetections') || '[]');\n        } catch (error) {\n            if (Config.SETTINGS.enableLogging) {\n                console.warn('üß© Extension Detector: Impossible de lire les d√©tections de session', error);\n            }\n        }\n\n        return {\n            totalDetections: this.detectedExtensions.size,\n            uniquePaths: this.extensionPaths.size,\n            sessionDetections: sessionDetections.length,\n            detectedExtensionsList: Array.from(this.detectedExtensions),\n            lastDetection: sessionDetections.length > 0 ? sessionDetections[sessionDetections.length - 1] : null,\n            metricsData: this.metricsManager.getData()\n        };\n    };\n\n    /**\n     * Exporte les m√©triques au format JSON\n     * @memberof ExtensionDetector\n     * @function exportMetricsAsJSON\n     * @returns {string} Cha√Æne JSON des m√©triques\n     * @example\n     * const jsonMetrics = detector.exportMetricsAsJSON();\n     * const metrics = JSON.parse(jsonMetrics);\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.exportMetricsAsJSON = function() {\n        return this.metricsManager.exportMetricsAsJSON();\n    };\n\n    /**\n     * Ajoute le support pour une nouvelle extension\n     * @memberof ExtensionDetector\n     * @function addExtensionSupport\n     * @param {string} extensionKey - Cl√© de l'extension\n     * @param {string} extensionName - Nom de l'extension\n     * @example\n     * detector.addExtensionSupport('newExt', 'Nouvelle Extension');\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.addExtensionSupport = function(extensionKey, extensionName) {\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Support ajout√© pour l\\'extension: ' + extensionName);\n        }\n    };\n\n    /**\n     * Obtient la configuration d'extension\n     * @memberof ExtensionDetector\n     * @function getExtensionConfig\n     * @param {string} extensionKey - Cl√© de l'extension\n     * @returns {Object|null} Configuration de l'extension\n     * @example\n     * const config = detector.getExtensionConfig('crowdly');\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.getExtensionConfig = function(extensionKey) {\n        return Config.getExtension(extensionKey);\n    };\n\n    /**\n     * Nettoie les ressources\n     * @memberof ExtensionDetector\n     * @function cleanup\n     * @example\n     * detector.cleanup();\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype.cleanup = function() {\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Nettoyage des ressources');\n        }\n\n        this.stop();\n    };\n\n    /**\n     * Enregistre un √©v√©nement de d√©tection\n     * @memberof ExtensionDetector\n     * @function _logDetection\n     * @param {string} extensionKey - Cl√© de l'extension\n     * @param {string} extensionName - Nom de l'extension\n     * @param {string} method - M√©thode de d√©tection\n     * @private\n     * @since 1.0.0\n     */\n    ExtensionDetector.prototype._logDetection = function(extensionKey, extensionName, method) {\n        if (!Config.SETTINGS.enableLogging) return;\n\n        var event = {\n            timestamp: SharedUtils.generateTimestamp().unix,\n            extension: extensionKey,\n            extensionName: extensionName,\n            method: method,\n            url: window.location.href,\n            userAgent: navigator.userAgent\n        };\n\n        try {\n            var history = JSON.parse(sessionStorage.getItem('extensionDetections') || '[]');\n            history.push(event);\n            sessionStorage.setItem('extensionDetections', JSON.stringify(history));\n        } catch (error) {\n            console.warn('üß© Extension Detector: Impossible d\\'enregistrer l\\'√©v√©nement de d√©tection', error);\n        }\n    };\n\n    return {\n        ExtensionDetector: ExtensionDetector\n    };\n});"],"names":["define","Config","Browser","Shadow","SharedUtils","MetricsManager","Modal","ExtensionDetector","self","this","browserHandler","BrowserHandler","shadowMonitor","ShadowMonitor","extensionKey","extension","method","_onExtensionDetected","metricsManager","setMetricsManager","detectedExtensions","Set","extensionPaths","Map","isRunning","modalShown","prototype","start","SETTINGS","enableLogging","console","warn","_resetState","error","stop","log","cleanup","restart","setTimeout","has","add","name","_logDetection","_showWarningModal","_onExtensionIdDetected","extensionPath","set","Date","now","isExtensionAccessible","then","isAccessible","_checkFilesForAllExtensions","getAllExtensions","forEach","files","Object","keys","length","checkFiles","result","detected","key","catch","showModal","UI","modal","clear","reset","getStatistics","sessionDetections","JSON","parse","sessionStorage","getItem","totalDetections","size","uniquePaths","detectedExtensionsList","Array","from","lastDetection","metricsData","getData","exportMetricsAsJSON","addExtensionSupport","extensionName","getExtensionConfig","getExtension","event","timestamp","generateTimestamp","unix","url","window","location","href","userAgent","navigator","history","push","setItem","stringify"],"mappings":"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"}