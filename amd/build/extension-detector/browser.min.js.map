{"version":3,"file":"browser.min.js","sources":["../../src/extension-detector/browser.js"],"sourcesContent":["/**\n * @fileoverview Browser handler for extension file verification\n * @module quizaccess_cheatdetect/extension-detector/browser\n * @copyright 2025 CBlue SRL <support@cblue.be>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since 1.0.0\n */\n\ndefine([\n    'quizaccess_cheatdetect/extension-detector/config',\n    'quizaccess_cheatdetect/shared/utils'\n], function(Config, SharedUtils) {\n    'use strict';\n\n    /**\n     * @typedef {Object} FileCheckResult\n     * @property {string} file - Verified file name\n     * @property {boolean} success - Verification success\n     * @property {boolean} detected - File detected successfully\n     * @property {string} [reason] - Result reason\n     * @property {string} [error] - Error message if failed\n     * @property {number} [contentLength] - Content size if available\n     * @property {boolean} [skipped] - File skipped (duplicate request)\n     */\n\n    /**\n     * @typedef {Object} AnalysisResult\n     * @property {boolean} success - Overall analysis success\n     * @property {number} totalFiles - Total number of files checked\n     * @property {number} successfulChecks - Number of successful checks\n     * @property {number} detectedFiles - Number of detected files\n     * @property {number} failedChecks - Number of failed checks\n     * @property {boolean} detected - At least one file detected\n     * @property {FileCheckResult[]} results - Detailed results\n     * @property {string[]} evidence - List of detected files (evidence)\n     */\n\n    /**\n     * Browser handler constructor\n     * @class BrowserHandler\n     * @example\n     * const handler = new BrowserHandler();\n     * @since 1.0.0\n     */\n    var BrowserHandler = function() {\n        this.activeRequests = new Set();\n    };\n\n    /**\n     * Check specified extension files\n     * @memberof BrowserHandler\n     * @function checkFiles\n     * @param {string} extensionPath - Extension base path\n     * @param {Object.<string, string[]>} filesToCheck - Files to check with their content patterns\n     * @returns {Promise<AnalysisResult>} Promise resolving with analysis results\n     * @example\n     * handler.checkFiles('chrome-extension://abc123', {\n     *   'manifest.json': ['\"name\"', '\"version\"'],\n     *   'script.js': ['crowdly']\n     * }).then(result => {\n     *   if (result.detected) console.log('Extension detected!');\n     * });\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype.checkFiles = function(extensionPath, filesToCheck) {\n        var self = this;\n\n        if (Config.SETTINGS.enableLogging) {\n            // eslint-disable-next-line no-console\n            console.log('ðŸ§© Extension Detector: Checking ' + Object.keys(filesToCheck).length + ' files');\n        }\n\n        return this._checkMultipleFiles(extensionPath, filesToCheck)\n            .then(function(results) {\n                return self._analyzeResults(results);\n            });\n    };\n\n    /**\n     * Extract extension ID from content\n     * @memberof BrowserHandler\n     * @function extractExtensionId\n     * @param {string} content - Content to analyze\n     * @returns {string|null} Extracted extension URL or null\n     * @example\n     * const id = handler.extractExtensionId('chrome-extension://abc123/script.js');\n     * // \"chrome-extension://abc123\"\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype.extractExtensionId = function(content) {\n        if (!content) {\n            return null;\n        }\n\n        var match = content.match(Config.EXTENSION_URL_REGEX);\n        return match ? match[0] : null;\n    };\n\n    /**\n     * Check if extension path is accessible\n     * @memberof BrowserHandler\n     * @function isExtensionAccessible\n     * @param {string} extensionPath - Extension path to check\n     * @returns {Promise<boolean>} Promise resolving with true if accessible\n     * @example\n     * handler.isExtensionAccessible('chrome-extension://abc123')\n     *   .then(accessible => {\n     *     if (accessible) console.log('Extension accessible');\n     *   });\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype.isExtensionAccessible = function(extensionPath) {\n        var manifestUrl = extensionPath + '/manifest.json';\n        return SharedUtils.fetchWithTimeout(manifestUrl, 3000)\n            .then(function(result) {\n                return result.success;\n            });\n    };\n\n    /**\n     * Check multiple files in parallel\n     * @memberof BrowserHandler\n     * @function _checkMultipleFiles\n     * @param {string} extensionPath - Extension base path\n     * @param {Object.<string, string[]>} filesToCheck - Files to check\n     * @returns {Promise<FileCheckResult[]>} Promise with all file results\n     * @private\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype._checkMultipleFiles = function(extensionPath, filesToCheck) {\n        var self = this;\n\n        var promises = Object.keys(filesToCheck).map(function(fileName) {\n            var contentChecks = filesToCheck[fileName];\n            return self._checkSingleFile(extensionPath, fileName, contentChecks);\n        });\n\n        return Promise.all(promises);\n    };\n\n    /**\n     * Check a single file with content validation\n     * @memberof BrowserHandler\n     * @function _checkSingleFile\n     * @param {string} extensionPath - Extension base path\n     * @param {string} fileName - File name to check\n     * @param {string[]} contentChecks - Patterns to search in content\n     * @returns {Promise<FileCheckResult>} Promise with verification result\n     * @private\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype._checkSingleFile = function(extensionPath, fileName, contentChecks) {\n        var self = this;\n        var fileUrl = extensionPath + '/' + fileName;\n        var requestId = extensionPath + ':' + fileName;\n\n        // Avoid duplicate requests\n        if (this.activeRequests.has(requestId)) {\n            return Promise.resolve({ file: fileName, skipped: true });\n        }\n\n        this.activeRequests.add(requestId);\n\n        return SharedUtils.fetchWithTimeout(fileUrl, Config.SETTINGS.fileCheckTimeout)\n            .then(function(fetchResult) {\n                self.activeRequests.delete(requestId);\n\n                if (!fetchResult.success) {\n                    return {\n                        file: fileName,\n                        success: false,\n                        error: fetchResult.error,\n                        detected: false\n                    };\n                }\n\n                // If no content validation needed, file existence is enough\n                if (!contentChecks || contentChecks.length === 0) {\n                    return {\n                        file: fileName,\n                        success: true,\n                        detected: true,\n                        reason: 'File exists'\n                    };\n                }\n\n                // Validate file content\n                return fetchResult.response.text().then(function(content) {\n                    var detected = self._validateContent(content, contentChecks);\n\n                    return {\n                        file: fileName,\n                        success: true,\n                        detected: detected,\n                        reason: detected ? 'Content validation successful' : 'Content validation failed',\n                        contentLength: content.length\n                    };\n                });\n            })\n            .catch(function(error) {\n                self.activeRequests.delete(requestId);\n                return {\n                    file: fileName,\n                    success: false,\n                    error: error.message,\n                    detected: false\n                };\n            });\n    };\n\n    /**\n     * Validate file content against specified patterns\n     * @memberof BrowserHandler\n     * @function _validateContent\n     * @param {string} content - File content\n     * @param {string[]} patterns - Patterns to search\n     * @returns {boolean} True if at least one pattern is found\n     * @private\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype._validateContent = function(content, patterns) {\n        if (!content || !patterns || patterns.length === 0) {\n            return false;\n        }\n\n        // Check if a pattern is found in content\n        return patterns.some(function(pattern) {\n            return content.includes(pattern);\n        });\n    };\n\n    /**\n     * Analyze file verification results\n     * @memberof BrowserHandler\n     * @function _analyzeResults\n     * @param {FileCheckResult[]} results - Raw verification results\n     * @returns {AnalysisResult} Consolidated results analysis\n     * @private\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype._analyzeResults = function(results) {\n        var successful = results.filter(function(r) { return r.success; });\n        var detected = results.filter(function(r) { return r.detected; });\n        var failed = results.filter(function(r) { return !r.success; });\n\n        // Log results for debugging\n        if (Config.SETTINGS.enableLogging) {\n            if (detected.length > 0) {\n                var detectedFiles = detected.map(function(r) { return r.file; }).join(', ');\n                // eslint-disable-next-line no-console\n                console.log('ðŸ§© Extension Detector: Files detected - ' + detectedFiles);\n            }\n\n            if (failed.length > 0) {\n                var failedFiles = failed.map(function(r) { return r.file; }).join(', ');\n                // eslint-disable-next-line no-console\n                console.warn('ðŸ§© Extension Detector: File checks failed - ' + failedFiles);\n            }\n        }\n\n        return {\n            success: true,\n            totalFiles: results.length,\n            successfulChecks: successful.length,\n            detectedFiles: detected.length,\n            failedChecks: failed.length,\n            detected: detected.length > 0,\n            results: results,\n            evidence: detected.map(function(r) { return r.file; })\n        };\n    };\n\n    /**\n     * Clean up active requests\n     * @memberof BrowserHandler\n     * @function cleanup\n     * @example\n     * handler.cleanup();\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype.cleanup = function() {\n        if (Config.SETTINGS.enableLogging) {\n            // eslint-disable-next-line no-console\n            console.log('ðŸ§© Extension Detector: Cleaning up ' + this.activeRequests.size + ' active requests');\n        }\n        this.activeRequests.clear();\n    };\n\n    return {\n        BrowserHandler: BrowserHandler\n    };\n});\n"],"names":["define","Config","SharedUtils","BrowserHandler","this","activeRequests","Set","prototype","checkFiles","extensionPath","filesToCheck","self","SETTINGS","enableLogging","console","log","Object","keys","length","_checkMultipleFiles","then","results","_analyzeResults","extractExtensionId","content","match","EXTENSION_URL_REGEX","isExtensionAccessible","manifestUrl","fetchWithTimeout","result","success","promises","map","fileName","contentChecks","_checkSingleFile","Promise","all","fileUrl","requestId","has","resolve","file","skipped","add","fileCheckTimeout","fetchResult","delete","response","text","detected","_validateContent","reason","contentLength","error","catch","message","patterns","some","pattern","includes","successful","filter","r","failed","detectedFiles","join","failedFiles","warn","totalFiles","successfulChecks","failedChecks","evidence","cleanup","size","clear"],"mappings":"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"}