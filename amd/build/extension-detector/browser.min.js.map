{"version":3,"file":"browser.min.js","sources":["../../src/extension-detector/browser.js"],"sourcesContent":["/**\n * @fileoverview Gestionnaire de navigateur pour la v√©rification des fichiers d'extension\n * @module quizaccess_cheatdetect/extension-detector/browser\n * @copyright 2025 CBlue SRL <support@cblue.be>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since 1.0.0\n */\n\ndefine([\n    'quizaccess_cheatdetect/extension-detector/config',\n    'quizaccess_cheatdetect/shared/utils'\n], function(Config, SharedUtils) {\n    'use strict';\n\n    /**\n     * @typedef {Object} FileCheckResult\n     * @property {string} file - Nom du fichier v√©rifi√©\n     * @property {boolean} success - Succ√®s de la v√©rification\n     * @property {boolean} detected - Fichier d√©tect√© avec succ√®s\n     * @property {string} [reason] - Raison du r√©sultat\n     * @property {string} [error] - Message d'erreur si √©chec\n     * @property {number} [contentLength] - Taille du contenu si disponible\n     * @property {boolean} [skipped] - Fichier ignor√© (requ√™te dupliqu√©e)\n     */\n\n    /**\n     * @typedef {Object} AnalysisResult\n     * @property {boolean} success - Succ√®s de l'analyse globale\n     * @property {number} totalFiles - Nombre total de fichiers v√©rifi√©s\n     * @property {number} successfulChecks - Nombre de v√©rifications r√©ussies\n     * @property {number} detectedFiles - Nombre de fichiers d√©tect√©s\n     * @property {number} failedChecks - Nombre de v√©rifications √©chou√©es\n     * @property {boolean} detected - Au moins un fichier d√©tect√©\n     * @property {FileCheckResult[]} results - R√©sultats d√©taill√©s\n     * @property {string[]} evidence - Liste des fichiers d√©tect√©s (preuves)\n     */\n\n    /**\n     * Constructeur du gestionnaire de navigateur\n     * @class BrowserHandler\n     * @example\n     * const handler = new BrowserHandler();\n     * @since 1.0.0\n     */\n    var BrowserHandler = function() {\n        this.activeRequests = new Set();\n    };\n\n    /**\n     * V√©rifie les fichiers d'extension sp√©cifi√©s\n     * @memberof BrowserHandler\n     * @function checkFiles\n     * @param {string} extensionPath - Chemin de base de l'extension\n     * @param {Object.<string, string[]>} filesToCheck - Fichiers √† v√©rifier avec leurs motifs de contenu\n     * @returns {Promise<AnalysisResult>} Promesse qui r√©sout avec les r√©sultats d'analyse\n     * @example\n     * handler.checkFiles('chrome-extension://abc123', {\n     *   'manifest.json': ['\"name\"', '\"version\"'],\n     *   'script.js': ['crowdly']\n     * }).then(result => {\n     *   if (result.detected) console.log('Extension d√©tect√©e!');\n     * });\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype.checkFiles = function(extensionPath, filesToCheck) {\n        var self = this;\n\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: V√©rification de ' + Object.keys(filesToCheck).length + ' fichiers');\n        }\n\n        return this._checkMultipleFiles(extensionPath, filesToCheck)\n            .then(function(results) {\n                return self._analyzeResults(results);\n            });\n    };\n\n    /**\n     * Extrait l'ID d'extension du contenu\n     * @memberof BrowserHandler\n     * @function extractExtensionId\n     * @param {string} content - Contenu √† analyser\n     * @returns {string|null} URL d'extension extraite ou null\n     * @example\n     * const id = handler.extractExtensionId('chrome-extension://abc123/script.js');\n     * // \"chrome-extension://abc123\"\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype.extractExtensionId = function(content) {\n        if (!content) return null;\n\n        var match = content.match(Config.EXTENSION_URL_REGEX);\n        return match ? match[0] : null;\n    };\n\n    /**\n     * V√©rifie si le chemin d'extension est accessible\n     * @memberof BrowserHandler\n     * @function isExtensionAccessible\n     * @param {string} extensionPath - Chemin de l'extension √† v√©rifier\n     * @returns {Promise<boolean>} Promesse qui r√©sout avec true si accessible\n     * @example\n     * handler.isExtensionAccessible('chrome-extension://abc123')\n     *   .then(accessible => {\n     *     if (accessible) console.log('Extension accessible');\n     *   });\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype.isExtensionAccessible = function(extensionPath) {\n        var manifestUrl = extensionPath + '/manifest.json';\n        return SharedUtils.fetchWithTimeout(manifestUrl, 3000)\n            .then(function(result) {\n                return result.success;\n            });\n    };\n\n    /**\n     * V√©rifie plusieurs fichiers en parall√®le\n     * @memberof BrowserHandler\n     * @function _checkMultipleFiles\n     * @param {string} extensionPath - Chemin de base de l'extension\n     * @param {Object.<string, string[]>} filesToCheck - Fichiers √† v√©rifier\n     * @returns {Promise<FileCheckResult[]>} Promesse avec les r√©sultats de tous les fichiers\n     * @private\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype._checkMultipleFiles = function(extensionPath, filesToCheck) {\n        var self = this;\n\n        var promises = Object.keys(filesToCheck).map(function(fileName) {\n            var contentChecks = filesToCheck[fileName];\n            return self._checkSingleFile(extensionPath, fileName, contentChecks);\n        });\n\n        return Promise.all(promises);\n    };\n\n    /**\n     * V√©rifie un seul fichier avec validation de contenu\n     * @memberof BrowserHandler\n     * @function _checkSingleFile\n     * @param {string} extensionPath - Chemin de base de l'extension\n     * @param {string} fileName - Nom du fichier √† v√©rifier\n     * @param {string[]} contentChecks - Motifs √† rechercher dans le contenu\n     * @returns {Promise<FileCheckResult>} Promesse avec le r√©sultat de v√©rification\n     * @private\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype._checkSingleFile = function(extensionPath, fileName, contentChecks) {\n        var self = this;\n        var fileUrl = extensionPath + '/' + fileName;\n        var requestId = extensionPath + ':' + fileName;\n\n        // √âviter les requ√™tes dupliqu√©es\n        if (this.activeRequests.has(requestId)) {\n            return Promise.resolve({ file: fileName, skipped: true });\n        }\n\n        this.activeRequests.add(requestId);\n\n        return SharedUtils.fetchWithTimeout(fileUrl, Config.SETTINGS.fileCheckTimeout)\n            .then(function(fetchResult) {\n                self.activeRequests.delete(requestId);\n\n                if (!fetchResult.success) {\n                    return {\n                        file: fileName,\n                        success: false,\n                        error: fetchResult.error,\n                        detected: false\n                    };\n                }\n\n                // Si aucune validation de contenu n√©cessaire, l'existence du fichier suffit\n                if (!contentChecks || contentChecks.length === 0) {\n                    return {\n                        file: fileName,\n                        success: true,\n                        detected: true,\n                        reason: 'Le fichier existe'\n                    };\n                }\n\n                // Valider le contenu du fichier\n                return fetchResult.response.text().then(function(content) {\n                    var detected = self._validateContent(content, contentChecks);\n\n                    return {\n                        file: fileName,\n                        success: true,\n                        detected: detected,\n                        reason: detected ? 'Validation du contenu r√©ussie' : 'Validation du contenu √©chou√©e',\n                        contentLength: content.length\n                    };\n                });\n            })\n            .catch(function(error) {\n                self.activeRequests.delete(requestId);\n                return {\n                    file: fileName,\n                    success: false,\n                    error: error.message,\n                    detected: false\n                };\n            });\n    };\n\n    /**\n     * Valide le contenu du fichier contre les motifs sp√©cifi√©s\n     * @memberof BrowserHandler\n     * @function _validateContent\n     * @param {string} content - Contenu du fichier\n     * @param {string[]} patterns - Motifs √† rechercher\n     * @returns {boolean} True si au moins un motif est trouv√©\n     * @private\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype._validateContent = function(content, patterns) {\n        if (!content || !patterns || patterns.length === 0) return false;\n\n        // V√©rifier si un motif est trouv√© dans le contenu\n        return patterns.some(function(pattern) {\n            return content.includes(pattern);\n        });\n    };\n\n    /**\n     * Analyse les r√©sultats de v√©rification des fichiers\n     * @memberof BrowserHandler\n     * @function _analyzeResults\n     * @param {FileCheckResult[]} results - R√©sultats bruts de v√©rification\n     * @returns {AnalysisResult} Analyse consolid√©e des r√©sultats\n     * @private\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype._analyzeResults = function(results) {\n        var successful = results.filter(function(r) { return r.success; });\n        var detected = results.filter(function(r) { return r.detected; });\n        var failed = results.filter(function(r) { return !r.success; });\n\n        // Logger les r√©sultats pour le d√©bogage\n        if (Config.SETTINGS.enableLogging) {\n            if (detected.length > 0) {\n                var detectedFiles = detected.map(function(r) { return r.file; }).join(', ');\n                console.log('üß© Extension Detector: Fichiers d√©tect√©s - ' + detectedFiles);\n            }\n\n            if (failed.length > 0) {\n                var failedFiles = failed.map(function(r) { return r.file; }).join(', ');\n                console.warn('üß© Extension Detector: V√©rifications de fichiers √©chou√©es - ' + failedFiles);\n            }\n        }\n\n        return {\n            success: true,\n            totalFiles: results.length,\n            successfulChecks: successful.length,\n            detectedFiles: detected.length,\n            failedChecks: failed.length,\n            detected: detected.length > 0,\n            results: results,\n            evidence: detected.map(function(r) { return r.file; })\n        };\n    };\n\n    /**\n     * Nettoie les requ√™tes actives\n     * @memberof BrowserHandler\n     * @function cleanup\n     * @example\n     * handler.cleanup();\n     * @since 1.0.0\n     */\n    BrowserHandler.prototype.cleanup = function() {\n        if (Config.SETTINGS.enableLogging) {\n            console.log('üß© Extension Detector: Nettoyage de ' + this.activeRequests.size + ' requ√™tes actives');\n        }\n        this.activeRequests.clear();\n    };\n\n    return {\n        BrowserHandler: BrowserHandler\n    };\n});"],"names":["define","Config","SharedUtils","BrowserHandler","activeRequests","Set","prototype","checkFiles","extensionPath","filesToCheck","self","this","SETTINGS","enableLogging","console","log","Object","keys","length","_checkMultipleFiles","then","results","_analyzeResults","extractExtensionId","content","match","EXTENSION_URL_REGEX","isExtensionAccessible","manifestUrl","fetchWithTimeout","result","success","promises","map","fileName","contentChecks","_checkSingleFile","Promise","all","fileUrl","requestId","has","resolve","file","skipped","add","fileCheckTimeout","fetchResult","delete","response","text","detected","_validateContent","reason","contentLength","error","catch","message","patterns","some","pattern","includes","successful","filter","r","failed","detectedFiles","join","failedFiles","warn","totalFiles","successfulChecks","failedChecks","evidence","cleanup","size","clear"],"mappings":"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"}