/**
 * @fileoverview D√©tecteur d'extensions principal avec gestionnaire de m√©triques
 * @module quizaccess_cheatdetect/extension-detector/detector
 * @copyright 2025 CBlue SRL <support@cblue.be>
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since 1.0.0
 */
define("quizaccess_cheatdetect/extension-detector/detector",["quizaccess_cheatdetect/extension-detector/config","quizaccess_cheatdetect/extension-detector/browser","quizaccess_cheatdetect/extension-detector/shadow","quizaccess_cheatdetect/shared/utils","quizaccess_cheatdetect/extension-detector/metrics-manager"],function(Config,Browser,Shadow,SharedUtils,MetricsManager){var ExtensionDetector=function(){var self=this;this.browserHandler=new Browser.BrowserHandler,this.shadowMonitor=new Shadow.ShadowMonitor(function(extensionKey,extension,method){self._onExtensionDetected(extensionKey,extension,method)}),this.metricsManager=new MetricsManager.MetricsManager,this.shadowMonitor.setMetricsManager(this.metricsManager),this.shadowMonitor.setExtensionIdDetectedCallback(function(extensionKey,extensionId){self._scanAndRemoveElementsWithExtensionId(extensionKey,extensionId)}),this.detectedExtensions=new Set,this.isRunning=!1};return ExtensionDetector.prototype.start=function(){if(this.isRunning)Config.SETTINGS.enableLogging&&console.warn("üß© Extension Detector: D√©j√† en cours d'ex√©cution");else{this.isRunning=!0;try{this._resetState(),this.shadowMonitor.start()}catch(error){throw console.error("üß© Extension Detector: √âchec du d√©marrage",error),this.isRunning=!1,error}}},ExtensionDetector.prototype.stop=function(){this.isRunning&&(Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: Arr√™t du syst√®me de d√©tection"),this.isRunning=!1,this.shadowMonitor.stop(),this.browserHandler.cleanup(),Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: Syst√®me de d√©tection arr√™t√©"))},ExtensionDetector.prototype.restart=function(){var self=this;Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: Red√©marrage du syst√®me"),this.stop(),setTimeout(function(){self.start()},1e3)},ExtensionDetector.prototype._onExtensionDetected=function(extensionKey,extension,method){this.detectedExtensions.has(extensionKey)||(this.detectedExtensions.add(extensionKey),Config.SETTINGS.enableLogging&&console.log("üö® Extension Detector: "+extension.name+" d√©tect√©e via "+method),Config.SETTINGS.enableLogging&&this._logDetection(extensionKey,extension.name,method))},ExtensionDetector.prototype._onExtensionIdDetected=function(extensionPath){var self=this;this.extensionPaths.has(extensionPath)||(Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: Chemin d'extension d√©tect√© - "+extensionPath),this.extensionPaths.set(extensionPath,Date.now()),this.browserHandler.isExtensionAccessible(extensionPath).then(function(isAccessible){isAccessible?self._checkFilesForAllExtensions(extensionPath):Config.SETTINGS.enableLogging&&console.warn("üß© Extension Detector: Extension √† "+extensionPath+" non accessible")}))},ExtensionDetector.prototype._checkFilesForAllExtensions=function(extensionPath){var self=this;Config.getAllExtensions().forEach(function(extension){extension.files&&0!==Object.keys(extension.files).length&&self.browserHandler.checkFiles(extensionPath,extension.files).then(function(result){result.detected&&self._onExtensionDetected(extension.key,extension,"fileCheck")}).catch(function(error){Config.SETTINGS.enableLogging&&console.error("üß© Extension Detector: Erreur lors de la v√©rification des fichiers pour "+extension.key,error)})})},ExtensionDetector.prototype._scanAndRemoveElementsWithExtensionId=function(extensionKey,extensionId){if(Config.SETTINGS.removeDetectedElements){Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: Scan du DOM pour supprimer tous les √©l√©ments avec l'extension ID  : "+extensionId);var removedCount=0;removedCount+=this._scanElementsForExtensionId(document.body,extensionKey,extensionId);for(var allElements=document.querySelectorAll("*"),i=0;i<allElements.length;i++){var element=allElements[i];element.shadowRoot&&(removedCount+=this._scanShadowRootForExtensionId(element.shadowRoot,extensionKey,extensionId))}Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: "+removedCount+" √©l√©ments supprim√©s avec l'extension ID "+extensionId)}},ExtensionDetector.prototype._scanElementsForExtensionId=function(rootElement,extensionKey,extensionId){if(!rootElement)return 0;for(var removedCount=0,elementsToRemove=[],allElements=rootElement.querySelectorAll("*"),i=0;i<allElements.length;i++){var element=allElements[i];element!==document.body&&element!==document.documentElement&&"BODY"!==element.tagName&&"HTML"!==element.tagName&&"HEAD"!==element.tagName&&(this._elementContainsExtensionId(element,extensionId)&&elementsToRemove.push(element))}for(var j=0;j<elementsToRemove.length;j++){var elementToRemove=elementsToRemove[j];try{if(Config.SETTINGS.enableLogging){var elementInfo={tag:elementToRemove.tagName,id:elementToRemove.id||"(pas d'id)",class:elementToRemove.className||"(pas de classe)",html:elementToRemove.outerHTML.substring(0,200)+"..."};console.log("üß© Extension Detector:   ‚Üí √âl√©ment #"+(j+1)+" supprim√©:",elementInfo)}elementToRemove.parentNode?(elementToRemove.parentNode.removeChild(elementToRemove),removedCount++):elementToRemove.remove&&(elementToRemove.remove(),removedCount++)}catch(error){}}return removedCount},ExtensionDetector.prototype._scanShadowRootForExtensionId=function(shadowRoot,extensionKey,extensionId){if(!shadowRoot)return 0;var removedCount=0,elementsToRemove=[];try{for(var allElements=shadowRoot.querySelectorAll("*"),i=0;i<allElements.length;i++){var element=allElements[i];this._elementContainsExtensionId(element,extensionId)&&elementsToRemove.push(element),element.shadowRoot&&(removedCount+=this._scanShadowRootForExtensionId(element.shadowRoot,extensionKey,extensionId))}for(var j=0;j<elementsToRemove.length;j++){var elementToRemove=elementsToRemove[j];try{if(Config.SETTINGS.enableLogging){var elementInfo={tag:elementToRemove.tagName,id:elementToRemove.id||"(pas d'id)",class:elementToRemove.className||"(pas de classe)",html:elementToRemove.outerHTML.substring(0,200)+"...",location:"Shadow DOM"};console.log("üß© Extension Detector:   ‚Üí √âl√©ment supprim√© depuis Shadow DOM:",elementInfo)}elementToRemove.parentNode?(elementToRemove.parentNode.removeChild(elementToRemove),removedCount++):elementToRemove.remove&&(elementToRemove.remove(),removedCount++)}catch(error){}}}catch(error){}return removedCount},ExtensionDetector.prototype._elementContainsExtensionId=function(element,extensionId){return!(!element||!extensionId)&&-1!==(element.outerHTML+(element.shadowRoot?element.shadowRoot.innerHTML:"")).indexOf(extensionId)},ExtensionDetector.prototype._resetState=function(){this.detectedExtensions.clear(),this.shadowMonitor.reset(),this.metricsManager.reset()},ExtensionDetector.prototype.getStatistics=function(){var sessionDetections=[];try{sessionDetections=JSON.parse(sessionStorage.getItem("extensionDetections")||"[]")}catch(error){Config.SETTINGS.enableLogging&&console.warn("üß© Extension Detector: Impossible de lire les d√©tections de session",error)}return{totalDetections:this.detectedExtensions.size,sessionDetections:sessionDetections.length,detectedExtensionsList:Array.from(this.detectedExtensions),lastDetection:sessionDetections.length>0?sessionDetections[sessionDetections.length-1]:null,metricsData:this.metricsManager.getData()}},ExtensionDetector.prototype.exportMetricsAsJSON=function(){return this.metricsManager.exportMetricsAsJSON()},ExtensionDetector.prototype.addExtensionSupport=function(extensionKey,extensionName){Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: Support ajout√© pour l'extension: "+extensionName)},ExtensionDetector.prototype.getExtensionConfig=function(extensionKey){return Config.getExtension(extensionKey)},ExtensionDetector.prototype.cleanup=function(){Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: Nettoyage des ressources"),this.stop()},ExtensionDetector.prototype._logDetection=function(extensionKey,extensionName,method){if(Config.SETTINGS.enableLogging){var event={timestamp:SharedUtils.generateTimestamp().unix,extension:extensionKey,extensionName:extensionName,method:method,url:window.location.href,userAgent:navigator.userAgent};try{var history=JSON.parse(sessionStorage.getItem("extensionDetections")||"[]");history.push(event),sessionStorage.setItem("extensionDetections",JSON.stringify(history))}catch(error){console.warn("üß© Extension Detector: Impossible d'enregistrer l'√©v√©nement de d√©tection",error)}}},{ExtensionDetector:ExtensionDetector}});

//# sourceMappingURL=detector.min.js.map