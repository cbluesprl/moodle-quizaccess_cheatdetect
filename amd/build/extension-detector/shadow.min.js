/**
 * @fileoverview Moniteur Shadow DOM pour la d√©tection d'√©l√©ments d'extension
 * @module quizaccess_cheatdetect/extension-detector/shadow
 * @copyright 2025 CBlue SRL <support@cblue.be>
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since 1.0.0
 */
define("quizaccess_cheatdetect/extension-detector/shadow",["quizaccess_cheatdetect/extension-detector/config","quizaccess_cheatdetect/shared/utils"],function(Config,SharedUtils){var ShadowMonitor=function(onDetected){this.onDetected=onDetected,this.observers=new Map,this.processedShadowRoots=new WeakSet,this.detectedExtensions=new Set,this.isActive=!1,this.scanInterval=null,this.metricsManager=null,this.metricsState={hasDetectedElements:!1,totalDetections:0}};return ShadowMonitor.prototype.setMetricsManager=function(metricsManager){this.metricsManager=metricsManager},ShadowMonitor.prototype.start=function(){if(!this.isActive){this.isActive=!0;try{this._scanAllElements(),this._createObserver(),this._startPeriodicScan()}catch(error){console.error("üß© Extension Detector: √âchec du d√©marrage de la surveillance",error),this.isActive=!1}}},ShadowMonitor.prototype._startPeriodicScan=function(){var self=this;this.scanInterval=setInterval(function(){self.isActive&&self._scanAllElements()},1e3)},ShadowMonitor.prototype._scanAllElements=function(){try{for(var allElements=document.querySelectorAll("*"),i=0;i<allElements.length;i++){var element=allElements[i];this._checkAndProcessElement(element,"periodicScan"),element.shadowRoot&&!this.processedShadowRoots.has(element.shadowRoot)&&this._handleShadowRoot(element)}}catch(error){Config.SETTINGS.enableLogging&&console.warn("üß© Extension Detector: Erreur pendant le scan p√©riodique",error)}},ShadowMonitor.prototype._createObserver=function(){var self=this,observer=new MutationObserver(function(mutations){self.isActive&&mutations.forEach(function(mutation){if("childList"===mutation.type&&mutation.addedNodes.length>0&&mutation.addedNodes.forEach(function(node){if(node.nodeType===Node.ELEMENT_NODE){if(self._checkAndProcessElement(node,"mutationObserver"),node.querySelectorAll)for(var children=node.querySelectorAll("*"),i=0;i<children.length;i++)self._checkAndProcessElement(children[i],"mutationObserver");node.shadowRoot&&self._handleShadowRoot(node)}}),"attributes"===mutation.type){var target=mutation.target;target&&target.nodeType===Node.ELEMENT_NODE&&self._checkAndProcessElement(target,"attributeChange")}})});observer.observe(document,{childList:!0,subtree:!0,attributes:!0}),this.observers.set("main",observer)},ShadowMonitor.prototype._checkAndProcessElement=function(element,source){if(!element)return!1;for(var extensions=Config.getAllExtensions(),i=0;i<extensions.length;i++){var extension=extensions[i];if(this._detectExtensionElement(element,extension,source))return this._processDetectedElement(extension.key,element,source),!0}return!1},ShadowMonitor.prototype._detectExtensionElement=function(element,extension,source){if(!extension)return!1;if(element===document.body||element===document.documentElement||"BODY"===element.tagName||"HTML"===element.tagName||"HEAD"===element.tagName)return!1;if(this._containsSpecificExtensionId(element,extension))return!0;if(extension.textKeywords&&element.textContent)for(var k=0;k<extension.textKeywords.length;k++){var keyword=extension.textKeywords[k];if(element.textContent.includes(keyword))return!0}if(extension.patterns.ids&&element.id)for(var elementId=element.id.toLowerCase(),j=0;j<extension.patterns.ids.length;j++){var pattern=extension.patterns.ids[j].toLowerCase();if(elementId.includes(pattern))return!0}if(extension.patterns.classes&&element.className)for(var className=element.className.toLowerCase(),i=0;i<extension.patterns.classes.length;i++){pattern=extension.patterns.classes[i].toLowerCase();if(className.includes(pattern))return!0}return!1},ShadowMonitor.prototype._processDetectedElement=function(extensionKey,element,source){this.metricsState.totalDetections++;var elementInfo=this._extractElementInfo(element,source);(this.metricsManager&&(this.metricsManager.logDetectedElement(extensionKey,elementInfo),Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: üö® "+extensionKey+" : √©l√©ment d√©tect√©",elementInfo)),Config.SETTINGS.removeDetectedElements)&&(this._tryRemoveElement(element)?Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: ‚úÖ "+extensionKey+" : √©l√©ment supprim√©",elementInfo):Config.SETTINGS.enableLogging&&console.log("üß© Extension Detector: ‚ùå "+extensionKey+" - √©chec de suppression d'√©l√©ment",elementInfo));if(!this.detectedExtensions.has(extensionKey)&&(this.detectedExtensions.add(extensionKey),this.onDetected)){var extensionConfig=Config.getExtension(extensionKey);this.onDetected(extensionKey,extensionConfig,source)}},ShadowMonitor.prototype._extractElementInfo=function(element,source){for(var method="",extensions=Config.getAllExtensions(),i=0;i<extensions.length;i++){var extension=extensions[i];if(this._containsSpecificExtensionId(element,extension)){var match=element.outerHTML.match(Config.EXTENSION_URL_REGEX);method=match&&match[2]?"Extension de navigateur trouv√©e par son ID : "+match[2]:"Extension de navigateur trouv√©e";break}if(extension.textKeywords&&element.textContent){for(var found=!1,l=0;l<extension.textKeywords.length;l++)if(element.textContent.includes(extension.textKeywords[l])){method="Mot-cl√© texte trouv√© : "+extension.textKeywords[l],found=!0;break}if(found)break}else if(extension.patterns.ids&&element.id){for(var elementId=element.id.toLowerCase(),j=0;j<extension.patterns.ids.length;j++){var pattern=extension.patterns.ids[j].toLowerCase();if(elementId.includes(pattern)){method="ID trouv√© : "+pattern,found=!0;break}}if(found)break}else if(extension.patterns.classes&&element.className){for(var className=element.className.toLowerCase(),k=0;k<extension.patterns.classes.length;k++){pattern=extension.patterns.classes[k].toLowerCase();if(className.includes(pattern)){method="Classe trouv√©e : "+pattern,found=!0;break}}if(found)break}}return{DOM:element.outerHTML,shadowDOM:element.shadowRoot?element.shadowRoot.innerHTML:null,detection:method}},ShadowMonitor.prototype._tryRemoveElement=function(element){if(!element||element===document.body||element===document.documentElement||"BODY"===element.tagName||"HTML"===element.tagName||"HEAD"===element.tagName)return!1;try{if(element.parentNode)return element.parentNode.removeChild(element),!0;if(element.remove)return element.remove(),!0}catch(error){}return!1},ShadowMonitor.prototype._containsSpecificExtensionId=function(element,extension){var extensionIds=Config.getExtensionId(extension.key);if(!extensionIds)return!1;var match=element.outerHTML.match(Config.EXTENSION_URL_REGEX);if(!match)return!1;var foundExtensionId=match[2];for(var browser in extensionIds)if(extensionIds[browser]===foundExtensionId)return!0;return!1},ShadowMonitor.prototype._handleShadowRoot=function(element){var shadowRoot=element.shadowRoot;this.processedShadowRoots.has(shadowRoot)||(this.processedShadowRoots.add(shadowRoot),this._observeShadowRoot(shadowRoot),this._scanShadowRoot(shadowRoot))},ShadowMonitor.prototype._observeShadowRoot=function(shadowRoot){if(!this.observers.has(shadowRoot)){var self=this,shadowObserver=new MutationObserver(function(mutations){self.isActive&&mutations.forEach(function(mutation){"childList"===mutation.type&&mutation.addedNodes.length>0&&mutation.addedNodes.forEach(function(node){node.nodeType===Node.ELEMENT_NODE&&self._checkAndProcessElement(node,"shadowDOM")})})});shadowObserver.observe(shadowRoot,{childList:!0,subtree:!0,attributes:!0}),this.observers.set(shadowRoot,shadowObserver)}},ShadowMonitor.prototype._scanShadowRoot=function(shadowRoot){try{for(var elements=shadowRoot.querySelectorAll("*"),i=0;i<elements.length;i++)this._checkAndProcessElement(elements[i],"shadowDOM")}catch(error){}},ShadowMonitor.prototype.stop=function(){this.isActive&&(this.isActive=!1,this.scanInterval&&(clearInterval(this.scanInterval),this.scanInterval=null),this._cleanup())},ShadowMonitor.prototype._cleanup=function(){this.observers.forEach(function(observer){try{observer.disconnect()}catch(error){}}),this.observers.clear(),this.processedShadowRoots=new WeakSet,this.detectedExtensions.clear()},ShadowMonitor.prototype.reset=function(){this.detectedExtensions.clear(),this.metricsState={hasDetectedElements:!1,totalDetections:0}},{ShadowMonitor:ShadowMonitor}});

//# sourceMappingURL=shadow.min.js.map