/**
 * @fileoverview Shadow DOM monitor for extension element detection
 * @module quizaccess_cheatdetect/extension-detector/shadow
 * @copyright 2025 CBlue SRL <support@cblue.be>
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since 1.0.0
 */
define("quizaccess_cheatdetect/extension-detector/shadow",["quizaccess_cheatdetect/extension-detector/config"],function(Config){var ShadowMonitor=function(onDetected){this.onDetected=onDetected,this.onExtensionIdDetected=null,this.observers=new Map,this.processedShadowRoots=new WeakSet,this.detectedExtensions=new Set,this.detectedExtensionIds=new Set,this.isActive=!1,this.scanInterval=null,this.metricsManager=null,this.metricsState={hasDetectedElements:!1,totalDetections:0}};return ShadowMonitor.prototype.setMetricsManager=function(metricsManager){this.metricsManager=metricsManager},ShadowMonitor.prototype.setExtensionIdDetectedCallback=function(callback){this.onExtensionIdDetected=callback},ShadowMonitor.prototype.start=function(){if(!this.isActive){this.isActive=!0;try{this._scanAllElements(),this._createObserver(),this._startPeriodicScan()}catch(error){console.error("ðŸ§© Extension Detector: Failed to start monitoring",error),this.isActive=!1}}},ShadowMonitor.prototype._startPeriodicScan=function(){var self=this;this.scanInterval=setInterval(function(){self.isActive&&self._scanAllElements()},1e3)},ShadowMonitor.prototype._scanAllElements=function(){try{for(var allElements=document.querySelectorAll("*"),i=0;i<allElements.length;i++){var element=allElements[i];this._checkAndProcessElement(element,"periodicScan"),element.shadowRoot&&!this.processedShadowRoots.has(element.shadowRoot)&&this._handleShadowRoot(element)}}catch(error){Config.SETTINGS.enableLogging&&console.warn("ðŸ§© Extension Detector: Error during periodic scan",error)}},ShadowMonitor.prototype._createObserver=function(){var self=this,observer=new MutationObserver(function(mutations){self.isActive&&mutations.forEach(function(mutation){if("childList"===mutation.type&&mutation.addedNodes.length>0&&mutation.addedNodes.forEach(function(node){if(node.nodeType===Node.ELEMENT_NODE){if(self._checkAndProcessElement(node,"mutationObserver"),node.querySelectorAll)for(var children=node.querySelectorAll("*"),i=0;i<children.length;i++)self._checkAndProcessElement(children[i],"mutationObserver");node.shadowRoot&&self._handleShadowRoot(node)}}),"attributes"===mutation.type){var target=mutation.target;target&&target.nodeType===Node.ELEMENT_NODE&&self._checkAndProcessElement(target,"attributeChange")}})});observer.observe(document,{childList:!0,subtree:!0,attributes:!0}),this.observers.set("main",observer)},ShadowMonitor.prototype._checkAndProcessElement=function(element){if(!element)return!1;for(var extensions=Config.getAllExtensions(),i=0;i<extensions.length;i++){var extension=extensions[i];if(this._detectExtensionElement(element,extension))return this._processDetectedElement(extension.key,element),!0}return!1},ShadowMonitor.prototype._detectExtensionElement=function(element,extension){if(!extension)return!1;if(element===document.body||element===document.documentElement||"BODY"===element.tagName||"HTML"===element.tagName||"HEAD"===element.tagName)return!1;if(this._containsAnyExtensionId(element,extension))return!0;var detectedByPattern=!1;if(extension.textKeywords&&element.textContent)for(var k=0;k<extension.textKeywords.length;k++){var keyword=extension.textKeywords[k];if(element.textContent.includes(keyword)){detectedByPattern=!0;break}}if(!detectedByPattern&&extension.patterns.ids&&element.id)for(var elementId=("string"==typeof element.id?element.id:element.id.baseVal||"").toLowerCase(),j=0;j<extension.patterns.ids.length;j++){var pattern=extension.patterns.ids[j].toLowerCase();if(elementId.includes(pattern)){detectedByPattern=!0;break}}if(!detectedByPattern&&extension.patterns.classes&&element.className)for(var className=("string"==typeof element.className?element.className:element.className.baseVal||"").toLowerCase(),i=0;i<extension.patterns.classes.length;i++){var classPattern=extension.patterns.classes[i].toLowerCase();if(className.includes(classPattern)){detectedByPattern=!0;break}}return!!detectedByPattern&&(this._extractAndStoreExtensionId(element,extension),!0)},ShadowMonitor.prototype._processDetectedElement=function(extensionKey,element){this.metricsState.totalDetections++;var elementInfo=this._extractElementInfo(element);(this.metricsManager&&(this.metricsManager.logDetectedElement(extensionKey,elementInfo),Config.SETTINGS.enableLogging&&console.log("ðŸ§© Extension Detector: ðŸš¨ "+extensionKey+" : element detected",elementInfo)),Config.SETTINGS.removeDetectedElements)&&(this._tryRemoveElement(element)?Config.SETTINGS.enableLogging:Config.SETTINGS.enableLogging&&console.log("ðŸ§© Extension Detector: âŒ "+extensionKey+" - element removal failed",elementInfo));if(!this.detectedExtensions.has(extensionKey)&&(this.detectedExtensions.add(extensionKey),this.onDetected)){var extensionConfig=Config.getExtension(extensionKey);this.onDetected(extensionKey,extensionConfig,"DOM detection")}},ShadowMonitor.prototype._extractElementInfo=function(element){for(var method="",extensions=Config.getAllExtensions(),i=0;i<extensions.length;i++){var extension=extensions[i];if(this._containsAnyExtensionId(element,extension)){var match=(element.outerHTML+(element.shadowRoot?element.shadowRoot.innerHTML:"")).match(Config.EXTENSION_URL_REGEX);method=match&&match[2]?"Browser extension found by extension ID: "+match[2]:"Browser extension found";break}if(extension.textKeywords&&element.textContent){for(var found=!1,l=0;l<extension.textKeywords.length;l++)if(element.textContent.includes(extension.textKeywords[l])){method="Text keyword found: "+extension.textKeywords[l],found=!0;break}if(found)break}else if(extension.patterns.ids&&element.id){for(var elementId=element.id.toLowerCase(),j=0;j<extension.patterns.ids.length;j++){var pattern=extension.patterns.ids[j].toLowerCase();if(elementId.includes(pattern)){method="ID found: "+pattern,found=!0;break}}if(found)break}else if(extension.patterns.classes&&element.className){for(var className=element.className.toLowerCase(),k=0;k<extension.patterns.classes.length;k++){var classPattern=extension.patterns.classes[k].toLowerCase();if(className.includes(classPattern)){method="Class found: "+classPattern,found=!0;break}}if(found)break}}return{DOM:element.outerHTML,shadowDOM:element.shadowRoot?element.shadowRoot.innerHTML:null,detection:method}},ShadowMonitor.prototype._tryRemoveElement=function(element){if(!element||element===document.body||element===document.documentElement||"BODY"===element.tagName||"HTML"===element.tagName||"HEAD"===element.tagName)return!1;try{if(element.parentNode)return element.parentNode.removeChild(element),!0;if(element.remove)return element.remove(),!0}catch(error){}return!1},ShadowMonitor.prototype._containsAnyExtensionId=function(element,extension){var allIds=Config.getAllExtensionIds(extension.key);if(!allIds||0===allIds.length)return!1;var match=(element.outerHTML+(element.shadowRoot?element.shadowRoot.innerHTML:"")).match(Config.EXTENSION_URL_REGEX);if(!match)return!1;var foundExtensionId=match[2];return-1!==allIds.indexOf(foundExtensionId)},ShadowMonitor.prototype._extractAndStoreExtensionId=function(element,extension){for(var match,combinedHTML=element.outerHTML+(element.shadowRoot?element.shadowRoot.innerHTML:""),regex=new RegExp(Config.EXTENSION_URL_REGEX,"g");null!==(match=regex.exec(combinedHTML));){var extensionProtocol=match[1],extensionId=match[2],extensionPath=extensionProtocol+extensionId;if(!this.detectedExtensionIds.has(extensionPath)){this.detectedExtensionIds.add(extensionPath);var added=Config.addDetectedExtensionId(extension.key,extensionId);added&&Config.SETTINGS.enableLogging&&console.log("ðŸ§© Extension Detector: New extension ID extracted for "+extension.name+": "+extensionId),this.onExtensionIdDetected&&added&&this.onExtensionIdDetected(extension.key,extensionId)}}},ShadowMonitor.prototype._containsSpecificExtensionId=function(element,extension){return this._containsAnyExtensionId(element,extension)},ShadowMonitor.prototype._handleShadowRoot=function(element){var shadowRoot=element.shadowRoot;this.processedShadowRoots.has(shadowRoot)||(this.processedShadowRoots.add(shadowRoot),this._observeShadowRoot(shadowRoot),this._scanShadowRoot(shadowRoot))},ShadowMonitor.prototype._observeShadowRoot=function(shadowRoot){if(!this.observers.has(shadowRoot)){var self=this,shadowObserver=new MutationObserver(function(mutations){self.isActive&&mutations.forEach(function(mutation){"childList"===mutation.type&&mutation.addedNodes.length>0&&mutation.addedNodes.forEach(function(node){node.nodeType===Node.ELEMENT_NODE&&self._checkAndProcessElement(node,"shadowDOM")})})});shadowObserver.observe(shadowRoot,{childList:!0,subtree:!0,attributes:!0}),this.observers.set(shadowRoot,shadowObserver)}},ShadowMonitor.prototype._scanShadowRoot=function(shadowRoot){try{for(var elements=shadowRoot.querySelectorAll("*"),i=0;i<elements.length;i++)this._checkAndProcessElement(elements[i],"shadowDOM")}catch(error){}},ShadowMonitor.prototype.stop=function(){this.isActive&&(this.isActive=!1,this.scanInterval&&(clearInterval(this.scanInterval),this.scanInterval=null),this._cleanup())},ShadowMonitor.prototype._cleanup=function(){this.observers.forEach(function(observer){try{observer.disconnect()}catch(error){}}),this.observers.clear(),this.processedShadowRoots=new WeakSet,this.detectedExtensions.clear()},ShadowMonitor.prototype.reset=function(){this.detectedExtensions.clear(),this.detectedExtensionIds.clear(),this.metricsState={hasDetectedElements:!1,totalDetections:0}},{ShadowMonitor:ShadowMonitor}});

//# sourceMappingURL=shadow.min.js.map