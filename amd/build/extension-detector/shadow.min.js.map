{"version":3,"file":"shadow.min.js","sources":["../../src/extension-detector/shadow.js"],"sourcesContent":["/**\n * @fileoverview Moniteur Shadow DOM pour la d√©tection d'√©l√©ments d'extension\n * @module quizaccess_cheatdetect/extension-detector/shadow\n * @copyright 2025 CBlue SRL <support@cblue.be>\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since 1.0.0\n */\n\ndefine([\n    'quizaccess_cheatdetect/extension-detector/config',\n    'quizaccess_cheatdetect/shared/utils',\n    'quizaccess_cheatdetect/shared/modal'\n], function(Config, SharedUtils, Modal) {\n    'use strict';\n\n    /**\n     * @typedef {Object} ElementInfo\n     * @property {string} DOM - HTML externe de l'√©l√©ment\n     * @property {string|null} shadowDOM - HTML du Shadow DOM si pr√©sent\n     * @property {string} detection - M√©thode de d√©tection utilis√©e\n     */\n\n    /**\n     * @typedef {Object} ShadowMonitorState\n     * @property {boolean} hasDetectedElements - Au moins un √©l√©ment d√©tect√©\n     * @property {number} totalDetections - Nombre total de d√©tections\n     */\n\n    /**\n     * Constructeur du moniteur Shadow DOM\n     * @class ShadowMonitor\n     * @param {Function} onDetected - Callback appel√© lors de la d√©tection d'extension\n     * @example\n     * const monitor = new ShadowMonitor((key, ext, method) => {\n     *   console.log('Extension d√©tect√©e:', ext.name);\n     * });\n     * @since 1.0.0\n     */\n    var ShadowMonitor = function(onDetected) {\n        this.onDetected = onDetected;\n        this.observers = new Map();\n        this.processedShadowRoots = new WeakSet();\n        this.detectedExtensions = new Set();\n        this.isActive = false;\n        this.scanInterval = null;\n        this.metricsManager = null;\n\n        // √âtat des m√©triques simples\n        this.metricsState = {\n            hasDetectedElements: false,\n            totalDetections: 0\n        };\n    };\n\n    /**\n     * D√©finit la r√©f√©rence du gestionnaire de m√©triques\n     * @memberof ShadowMonitor\n     * @function setMetricsManager\n     * @param {Object} metricsManager - Instance du gestionnaire de m√©triques\n     * @example\n     * monitor.setMetricsManager(metricsManagerInstance);\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype.setMetricsManager = function(metricsManager) {\n        this.metricsManager = metricsManager;\n    };\n\n    /**\n     * D√©marre la surveillance du DOM et Shadow DOM\n     * @memberof ShadowMonitor\n     * @function start\n     * @throws {Error} Si le d√©marrage √©choue\n     * @example\n     * monitor.start();\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype.start = function() {\n        if (this.isActive) {\n            return;\n        }\n\n        this.isActive = true;\n\n        try {\n            this._scanAllElements();\n            this._createObserver();\n            this._startPeriodicScan();\n        } catch (error) {\n            console.error('üß© Extension Detector: √âchec du d√©marrage de la surveillance', error);\n            this.isActive = false;\n        }\n    };\n\n    /**\n     * D√©marre le scan p√©riodique des √©l√©ments\n     * @memberof ShadowMonitor\n     * @function _startPeriodicScan\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._startPeriodicScan = function() {\n        var self = this;\n\n        this.scanInterval = setInterval(function() {\n            if (!self.isActive) return;\n            self._scanAllElements();\n        }, 1000);\n    };\n\n    /**\n     * Scanne tous les √©l√©ments du document\n     * @memberof ShadowMonitor\n     * @function _scanAllElements\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._scanAllElements = function() {\n        try {\n            var allElements = document.querySelectorAll('*');\n\n            for (var i = 0; i < allElements.length; i++) {\n                var element = allElements[i];\n\n                this._checkAndProcessElement(element, 'periodicScan');\n\n                if (element.shadowRoot && !this.processedShadowRoots.has(element.shadowRoot)) {\n                    this._handleShadowRoot(element);\n                }\n            }\n        } catch (error) {\n            if (Config.SETTINGS.enableLogging) {\n                console.warn('üß© Extension Detector: Erreur pendant le scan p√©riodique', error);\n            }\n        }\n    };\n\n    /**\n     * Cr√©e un MutationObserver pour surveiller les changements DOM\n     * @memberof ShadowMonitor\n     * @function _createObserver\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._createObserver = function() {\n        var self = this;\n\n        var observer = new MutationObserver(function(mutations) {\n            if (!self.isActive) return;\n\n            mutations.forEach(function(mutation) {\n                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {\n                    mutation.addedNodes.forEach(function(node) {\n                        if (node.nodeType === Node.ELEMENT_NODE) {\n                            self._checkAndProcessElement(node, 'mutationObserver');\n\n                            if (node.querySelectorAll) {\n                                var children = node.querySelectorAll('*');\n                                for (var i = 0; i < children.length; i++) {\n                                    self._checkAndProcessElement(children[i], 'mutationObserver');\n                                }\n                            }\n\n                            if (node.shadowRoot) {\n                                self._handleShadowRoot(node);\n                            }\n                        }\n                    });\n                }\n\n                if (mutation.type === 'attributes') {\n                    var target = mutation.target;\n                    if (target && target.nodeType === Node.ELEMENT_NODE) {\n                        self._checkAndProcessElement(target, 'attributeChange');\n                    }\n                }\n            });\n        });\n\n        observer.observe(document, {\n            childList: true,\n            subtree: true,\n            attributes: true\n        });\n\n        this.observers.set('main', observer);\n    };\n\n    /**\n     * V√©rifie et traite un √©l√©ment pour d√©tecter les extensions\n     * @memberof ShadowMonitor\n     * @function _checkAndProcessElement\n     * @param {Element} element - √âl√©ment √† v√©rifier\n     * @param {string} source - Source de la d√©tection\n     * @returns {boolean} True si une extension a √©t√© d√©tect√©e\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._checkAndProcessElement = function(element, source) {\n        if (!element) return false;\n\n        // PROTECTION: Ne jamais traiter nos propres modales d'avertissement\n        if (this._isOurWarningModal(element)) {\n            return false;\n        }\n\n        var extensions = Config.getAllExtensions();\n\n        for (var i = 0; i < extensions.length; i++) {\n            var extension = extensions[i];\n\n            if (this._detectExtensionElement(element, extension, source)) {\n                this._processDetectedElement(extension.key, element, source);\n                return true;\n            }\n        }\n\n        return false;\n    };\n\n    /**\n     * V√©rifie si l'√©l√©ment fait partie de notre modale d'avertissement\n     * @memberof ShadowMonitor\n     * @function _isOurWarningModal\n     * @param {Element} element - √âl√©ment √† v√©rifier\n     * @returns {boolean} True si l'√©l√©ment fait partie de notre modale\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._isOurWarningModal = function(element) {\n        var current = element;\n        var maxDepth = 5;\n        var depth = 0;\n\n        while (current && depth < maxDepth) {\n            if (current.nodeType === Node.ELEMENT_NODE) {\n                if (current.id && Modal.isOurModalId(current.id)) {\n                    return true;\n                }\n            }\n            current = current.parentNode;\n            depth++;\n        }\n\n        return false;\n    };\n\n    /**\n     * D√©tecte si un √©l√©ment appartient √† une extension\n     * @memberof ShadowMonitor\n     * @function _detectExtensionElement\n     * @param {Element} element - √âl√©ment √† analyser\n     * @param {Object} extension - Configuration de l'extension\n     * @param {string} source - Source de la d√©tection\n     * @returns {boolean} True si l'√©l√©ment appartient √† l'extension\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._detectExtensionElement = function(element, extension, source) {\n        if (!extension) return false;\n\n        // S√âCURIT√â: Ne jamais essayer de supprimer des √©l√©ments critiques\n        if (element === document.body || element === document.documentElement ||\n            element.tagName === 'BODY' || element.tagName === 'HTML' || element.tagName === 'HEAD') {\n            return false;\n        }\n\n        // Strat√©gies de d√©tection\n        if (this._containsSpecificExtensionId(element, extension)) {\n            return true;\n        }\n\n        if (extension.textKeywords && element.textContent) {\n            for (var k = 0; k < extension.textKeywords.length; k++) {\n                var keyword = extension.textKeywords[k];\n                if (element.textContent.includes(keyword)) {\n                    return true;\n                }\n            }\n        }\n\n        if (extension.patterns.ids && element.id) {\n            var elementId = element.id.toLowerCase();\n            for (var j = 0; j < extension.patterns.ids.length; j++) {\n                var pattern = extension.patterns.ids[j].toLowerCase();\n                if (elementId.includes(pattern)) {\n                    return true;\n                }\n            }\n        }\n\n        if (extension.patterns.classes && element.className) {\n            var className = element.className.toLowerCase();\n            for (var i = 0; i < extension.patterns.classes.length; i++) {\n                var pattern = extension.patterns.classes[i].toLowerCase();\n                if (className.includes(pattern)) {\n                    return true;\n                }\n            }\n        }\n\n        return false;\n    };\n\n    /**\n     * Traite un √©l√©ment d√©tect√© (enregistrement et suppression)\n     * @memberof ShadowMonitor\n     * @function _processDetectedElement\n     * @param {string} extensionKey - Cl√© de l'extension\n     * @param {Element} element - √âl√©ment d√©tect√©\n     * @param {string} source - Source de la d√©tection\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._processDetectedElement = function(extensionKey, element, source) {\n        this.metricsState.totalDetections++;\n\n        // Extraire les informations de l'√©l√©ment\n        var elementInfo = this._extractElementInfo(element, source);\n\n        // Logger la d√©tection (TOUJOURS)\n        if (this.metricsManager) {\n            this.metricsManager.logDetectedElement(extensionKey, elementInfo);\n\n            if (Config.SETTINGS.enableLogging) {\n                console.log('üß© Extension Detector: üö® ' + extensionKey + ' : √©l√©ment d√©tect√©', elementInfo);\n            }\n        }\n\n        // Essayer de supprimer si le param√®tre le permet\n        if (Config.SETTINGS.removeDetectedElements) {\n            var removed = this._tryRemoveElement(element);\n\n            if (removed) {\n                if (Config.SETTINGS.enableLogging) {\n                    console.log('üß© Extension Detector: ‚úÖ ' + extensionKey + ' : √©l√©ment supprim√©', elementInfo);\n                }\n            } else {\n                if (Config.SETTINGS.enableLogging) {\n                    console.log('üß© Extension Detector: ‚ùå ' + extensionKey + ' - √©chec de suppression d\\'√©l√©ment', elementInfo);\n                }\n            }\n        }\n\n        // CORRECTION: Notifier TOUJOURS lors de la premi√®re d√©tection\n        // m√™me si startDetection = false dans les param√®tres backend\n        if (!this.detectedExtensions.has(extensionKey)) {\n            this.detectedExtensions.add(extensionKey);\n            if (this.onDetected) {\n                var extensionConfig = Config.getExtension(extensionKey);\n                this.onDetected(extensionKey, extensionConfig, source);\n            }\n        }\n    };\n\n    /**\n     * Extrait les informations pertinentes d'un √©l√©ment d√©tect√©\n     * @memberof ShadowMonitor\n     * @function _extractElementInfo\n     * @param {Element} element - √âl√©ment √† analyser\n     * @param {string} source - Source de la d√©tection\n     * @returns {ElementInfo} Informations extraites de l'√©l√©ment\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._extractElementInfo = function(element, source) {\n        var method = '';\n\n        // D√©terminer la m√©thode bas√©e sur ce qui a d√©clench√© la d√©tection\n        var extensions = Config.getAllExtensions();\n        for (var i = 0; i < extensions.length; i++) {\n            var extension = extensions[i];\n            if (this._containsSpecificExtensionId(element, extension)) {\n                //Extraire juste l'ID d'extension trouv√© dans l'√©l√©ment\n                var outerHTML = element.outerHTML;\n                var match = outerHTML.match(Config.EXTENSION_URL_REGEX);\n                if (match && match[2]) {\n                    method = 'Extension de navigateur trouv√©e par son ID : ' + match[2];\n                } else {\n                    method = 'Extension de navigateur trouv√©e';\n                }\n                break;\n            } else if (extension.textKeywords && element.textContent) {\n                var found = false;\n                for (var l = 0; l < extension.textKeywords.length; l++) {\n                    if (element.textContent.includes(extension.textKeywords[l])) {\n                        method = 'Mot-cl√© texte trouv√© : ' + extension.textKeywords[l];\n                        found = true;\n                        break;\n                    }\n                }\n                if (found) break;\n            }\n            else if (extension.patterns.ids && element.id) {\n                var elementId = element.id.toLowerCase();\n                for (var j = 0; j < extension.patterns.ids.length; j++) {\n                    var pattern = extension.patterns.ids[j].toLowerCase();\n                    if (elementId.includes(pattern)) {\n                        method = 'ID trouv√© : ' + pattern;\n                        found = true;\n                        break;\n                    }\n                }\n                if (found) break;\n            }\n            else if (extension.patterns.classes && element.className) {\n                var className = element.className.toLowerCase();\n                for (var k = 0; k < extension.patterns.classes.length; k++) {\n                    var pattern = extension.patterns.classes[k].toLowerCase();\n                    if (className.includes(pattern)) {\n                        method = 'Classe trouv√©e : ' + pattern;\n                        found = true;\n                        break;\n                    }\n                }\n                if (found) break;\n            }\n        }\n\n        return {\n            DOM: element.outerHTML,\n            shadowDOM: element.shadowRoot ? element.shadowRoot.innerHTML : null,\n            detection: method\n        };\n    };\n\n    /**\n     * Essaie de supprimer un √©l√©ment de mani√®re s√©curis√©e\n     * @memberof ShadowMonitor\n     * @function _tryRemoveElement\n     * @param {Element} element - √âl√©ment √† supprimer\n     * @returns {boolean} True si la suppression a r√©ussi\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._tryRemoveElement = function(element) {\n        if (!element ||\n            element === document.body ||\n            element === document.documentElement ||\n            element.tagName === 'BODY' ||\n            element.tagName === 'HTML' ||\n            element.tagName === 'HEAD') {\n            return false;\n        }\n\n        try {\n            if (element.parentNode) {\n                element.parentNode.removeChild(element);\n                return true;\n            } else if (element.remove) {\n                element.remove();\n                return true;\n            }\n        } catch (error) {\n            // √âchec silencieux\n        }\n        return false;\n    };\n\n    /**\n     * V√©rifie l'ID d'extension avec regex multi-navigateur\n     * @memberof ShadowMonitor\n     * @function _containsSpecificExtensionId\n     * @param {Element} element - √âl√©ment √† v√©rifier\n     * @param {Object} extension - Configuration de l'extension\n     * @returns {boolean} True si l'ID d'extension est trouv√©\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._containsSpecificExtensionId = function(element, extension) {\n        var extensionIds = Config.getExtensionId(extension.key);\n        if (!extensionIds) return false;\n\n        var outerHTML = element.outerHTML;\n\n        // V√©rifier avec la regex pour d√©tecter les URLs d'extension\n        var match = outerHTML.match(Config.EXTENSION_URL_REGEX);\n        if (!match) return false;\n\n        var foundExtensionId = match[2]; // L'ID extrait de la regex\n\n        // V√©rifier si l'ID trouv√© correspond √† un des IDs configur√©s\n        for (var browser in extensionIds) {\n            if (extensionIds[browser] === foundExtensionId) {\n                return true;\n            }\n        }\n\n        return false;\n    };\n\n    /**\n     * G√®re un Shadow Root d√©tect√©\n     * @memberof ShadowMonitor\n     * @function _handleShadowRoot\n     * @param {Element} element - √âl√©ment contenant le Shadow Root\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._handleShadowRoot = function(element) {\n        var shadowRoot = element.shadowRoot;\n        if (this.processedShadowRoots.has(shadowRoot)) return;\n\n        this.processedShadowRoots.add(shadowRoot);\n        this._observeShadowRoot(shadowRoot);\n        this._scanShadowRoot(shadowRoot);\n    };\n\n    /**\n     * Observe les changements dans un Shadow Root\n     * @memberof ShadowMonitor\n     * @function _observeShadowRoot\n     * @param {ShadowRoot} shadowRoot - Shadow Root √† observer\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._observeShadowRoot = function(shadowRoot) {\n        if (this.observers.has(shadowRoot)) return;\n\n        var self = this;\n        var shadowObserver = new MutationObserver(function(mutations) {\n            if (!self.isActive) return;\n\n            mutations.forEach(function(mutation) {\n                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {\n                    mutation.addedNodes.forEach(function(node) {\n                        if (node.nodeType === Node.ELEMENT_NODE) {\n                            self._checkAndProcessElement(node, 'shadowDOM');\n                        }\n                    });\n                }\n            });\n        });\n\n        shadowObserver.observe(shadowRoot, {\n            childList: true,\n            subtree: true,\n            attributes: true\n        });\n\n        this.observers.set(shadowRoot, shadowObserver);\n    };\n\n    /**\n     * Scanne tous les √©l√©ments d'un Shadow Root\n     * @memberof ShadowMonitor\n     * @function _scanShadowRoot\n     * @param {ShadowRoot} shadowRoot - Shadow Root √† scanner\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._scanShadowRoot = function(shadowRoot) {\n        try {\n            var elements = shadowRoot.querySelectorAll('*');\n            for (var i = 0; i < elements.length; i++) {\n                this._checkAndProcessElement(elements[i], 'shadowDOM');\n            }\n        } catch (error) {\n            // √âchec silencieux\n        }\n    };\n\n    /**\n     * Arr√™te la surveillance\n     * @memberof ShadowMonitor\n     * @function stop\n     * @example\n     * monitor.stop();\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype.stop = function() {\n        if (!this.isActive) return;\n\n        this.isActive = false;\n\n        if (this.scanInterval) {\n            clearInterval(this.scanInterval);\n            this.scanInterval = null;\n        }\n\n        this._cleanup();\n    };\n\n    /**\n     * Nettoie les ressources utilis√©es\n     * @memberof ShadowMonitor\n     * @function _cleanup\n     * @private\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype._cleanup = function() {\n        this.observers.forEach(function(observer) {\n            try {\n                observer.disconnect();\n            } catch (error) {\n                // √âchec silencieux\n            }\n        });\n\n        this.observers.clear();\n        this.processedShadowRoots = new WeakSet();\n        this.detectedExtensions.clear();\n    };\n\n    /**\n     * R√©initialise l'√©tat du moniteur\n     * @memberof ShadowMonitor\n     * @function reset\n     * @example\n     * monitor.reset();\n     * @since 1.0.0\n     */\n    ShadowMonitor.prototype.reset = function() {\n        this.detectedExtensions.clear();\n        this.metricsState = {\n            hasDetectedElements: false,\n            totalDetections: 0\n        };\n    };\n\n    return {\n        ShadowMonitor: ShadowMonitor\n    };\n});"],"names":["define","Config","SharedUtils","Modal","ShadowMonitor","onDetected","this","observers","Map","processedShadowRoots","WeakSet","detectedExtensions","Set","isActive","scanInterval","metricsManager","metricsState","hasDetectedElements","totalDetections","prototype","setMetricsManager","start","_scanAllElements","_createObserver","_startPeriodicScan","error","console","self","setInterval","allElements","document","querySelectorAll","i","length","element","_checkAndProcessElement","shadowRoot","has","_handleShadowRoot","SETTINGS","enableLogging","warn","observer","MutationObserver","mutations","forEach","mutation","type","addedNodes","node","nodeType","Node","ELEMENT_NODE","children","target","observe","childList","subtree","attributes","set","source","_isOurWarningModal","extensions","getAllExtensions","extension","_detectExtensionElement","_processDetectedElement","key","current","depth","id","isOurModalId","parentNode","body","documentElement","tagName","_containsSpecificExtensionId","textKeywords","textContent","k","keyword","includes","patterns","ids","elementId","toLowerCase","j","pattern","classes","className","extensionKey","elementInfo","_extractElementInfo","logDetectedElement","log","removeDetectedElements","_tryRemoveElement","add","extensionConfig","getExtension","method","match","outerHTML","EXTENSION_URL_REGEX","found","l","DOM","shadowDOM","innerHTML","detection","removeChild","remove","extensionIds","getExtensionId","foundExtensionId","browser","_observeShadowRoot","_scanShadowRoot","shadowObserver","elements","stop","clearInterval","_cleanup","disconnect","clear","reset"],"mappings":"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"}