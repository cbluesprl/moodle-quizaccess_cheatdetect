function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,o)}return t}function _defineProperty(e,r,t){return(r=function(t){var i=function(t,r){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}
/**
 * @fileoverview Module de tracking d'activité utilisateur avec détection d'événements suspects
 * @module quizaccess_cheatdetect/tracking/index
 * @copyright 2025 CBlue SRL <support@cblue.be>
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since 1.0.0
 */(t,"string");return"symbol"==typeof i?i:i+""}(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}define("quizaccess_cheatdetect/tracking/index",["quizaccess_cheatdetect/extension-detector/index","quizaccess_cheatdetect/shared/utils"],function(ExtensionDetector,SharedUtils){return{init:function(backendParams){if(!0!==backendParams.startDetection)return void console.log("Tracking désactivé: startDetection !== true");(()=>{let db=null,isCurrentlyFocused=!document.hidden,lastKnownExtensions={},extensionCheckInterval=null,extensionDetectedDataAlreadySent=new Set;function getExtensionsMetrics(){try{const metricsJSON=ExtensionDetector.getMetrics(),metrics=JSON.parse(metricsJSON);return metrics.timestamp&&metrics.extensionDetection?metrics.extensionDetection:(console.warn("Extension Detector: Structure de métriques invalide reçue"),{})}catch(error){return console.warn("Extension Detector: Erreur lors de la récupération des métriques d'extension:",error),{}}}function checkForNewExtensions(){const currentExtensions=getExtensionsMetrics(),newData=[];for(const[key,value]of Object.entries(currentExtensions))for(const detectedElement of value.detected){const _data=JSON.stringify({extensionKey:key,detectedElementUid:detectedElement.uid});extensionDetectedDataAlreadySent.has(_data)||(extensionDetectedDataAlreadySent.add(_data),newData.push(detectedElement))}newData.length>0&&logEvent({action:"extensions_detected",data:newData})}function logEvent(newEvent){if(db){const objectStore=db.transaction("events","readwrite").objectStore("events"),_newEvent=function(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){_defineProperty(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}({timestamp:SharedUtils.generateTimestamp()},newEvent);console.log("Nouvelle action utilisateur stockée",_newEvent),objectStore.add(_newEvent)}}function trackDocumentState(event){performance.now();let type=event.type;if("visibilitychange"===event.type&&("visible"===document.visibilityState?type="focus":"hidden"===document.visibilityState&&(type="blur")),"focus"===type){if(!isCurrentlyFocused){isCurrentlyFocused=!0;logEvent({action:"page_foreground",data:{previousState:"background"}})}}else if("blur"===type&&isCurrentlyFocused){isCurrentlyFocused=!1;logEvent({action:"page_background",data:{previousState:"foreground"}})}}function initTracking(){if(window._trackingInitialized)return void console.warn("Tracking déjà initialisé, ignoré");window._trackingInitialized=!0;logEvent({action:"page_load",data:{url:window.location.href,referrer:document.referrer||null,userAgent:navigator.userAgent}}),ExtensionDetector.init(backendParams),function(){checkForNewExtensions();const initialExtensions=getExtensionsMetrics();lastKnownExtensions=initialExtensions,extensionCheckInterval=setInterval(()=>{checkForNewExtensions()},5e3)}(),document.addEventListener("visibilitychange",trackDocumentState),document.addEventListener("blur",trackDocumentState,!0),window.addEventListener("focus",trackDocumentState),window.addEventListener("blur",trackDocumentState),document.addEventListener("copy",event=>function(){const selection=window.getSelection(),copiedText=selection.toString();if(!copiedText)return;const anchorNode=selection.anchorNode;if(!anchorNode)return;let qtextElement=null,currentElement=anchorNode.nodeType===Node.TEXT_NODE?anchorNode.parentElement:anchorNode;for(;currentElement&&currentElement!==document.body;){if(currentElement.classList&&currentElement.classList.contains("qtext")){qtextElement=currentElement;break}currentElement=currentElement.parentElement}if(!qtextElement)return;let questionElement=null;currentElement=qtextElement;const questionIdPattern=/^question-\d+-\d+$/;for(;currentElement&&currentElement!==document.body;){if(currentElement.id&&questionIdPattern.test(currentElement.id)){questionElement=currentElement;break}currentElement=currentElement.parentElement}if(!questionElement)return;logEvent({action:"copy",data:{content:copiedText,questionId:questionElement.id}})}()),window.addEventListener("beforeunload",()=>{extensionCheckInterval&&(clearInterval(extensionCheckInterval),extensionCheckInterval=null);logEvent({action:"page_unload",data:{}}),flushEvents()}),trackDocumentState({type:"visibilitychange"})}function flushEvents(){if(db){const request=db.transaction("events","readonly").objectStore("events").getAll();request.onsuccess=()=>{const events=request.result;if(events.length>0){const data={session_id:backendParams.sessionId,attemptid:backendParams.attemptid,userid:backendParams.userid,quizid:backendParams.quizid,slot:backendParams.slot,events:events};fetch("/local/rest/api/quizaccess_cheatdetect/save-data",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then(response=>{response.ok?(console.log("Action(s) utilisateur envoyée(s) au serveur",data),function(){const transaction=db.transaction("events","readwrite"),objectStore=transaction.objectStore("events");objectStore.clear()}()):console.error("Erreur lors de l'envoi des événements")}).catch(error=>{console.error("Erreur réseau:",error)})}else console.log("Aucune action utilisateur à sauvegarder")},request.onerror=error=>{console.error("Erreur lors de la récupération des événements depuis IndexedDB:",error)}}}new Promise((resolve,reject)=>{if(!window.indexedDB)return void reject("IndexedDB n'est pas disponible.");const request=indexedDB.open("UserActivityDB",1);request.onupgradeneeded=event=>{const database=event.target.result;database.objectStoreNames.contains("events")||database.createObjectStore("events",{autoIncrement:!0})},request.onsuccess=event=>{db=event.target.result,resolve()},request.onerror=event=>{console.error("Erreur lors de l'ouverture d'IndexedDB:",event.target.error),reject(event.target.error)}}).then(()=>{initTracking(),setInterval(()=>{flushEvents()},5e3)}).catch(error=>{console.error("Échec de l'initialisation d'IndexedDB:",error)})})()}}});

//# sourceMappingURL=index.min.js.map