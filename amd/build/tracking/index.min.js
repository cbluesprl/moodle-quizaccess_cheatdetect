/**
 * @fileoverview User activity tracking module with suspicious event detection
 * @module quizaccess_cheatdetect/tracking/index
 * @copyright 2025 CBlue SRL <support@cblue.be>
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @since 1.0.0
 */
define("quizaccess_cheatdetect/tracking/index",["quizaccess_cheatdetect/extension-detector/index","quizaccess_cheatdetect/shared/utils"],(function(ExtensionDetector,SharedUtils){return{init:function(backendParams){if(!0!==backendParams.startDetection)return void console.log("Tracking disabled: startDetection !== true");(()=>{let db=null,isCurrentlyFocused=!document.hidden,extensionCheckInterval=null,extensionDetectedDataAlreadySent=new Set;function checkForNewExtensions(){const currentExtensions=function(){try{const metricsJSON=ExtensionDetector.getMetrics(),metrics=JSON.parse(metricsJSON);return metrics.timestamp&&metrics.extensionDetection?metrics.extensionDetection:(console.warn("Extension Detector: Invalid metrics structure received"),{})}catch(error){return console.warn("Extension Detector: Error retrieving extension metrics:",error),{}}}(),newData=[];for(const[key,value]of Object.entries(currentExtensions))for(const detectedElement of value.detected){const _data=JSON.stringify({extensionKey:key,detectedElementUid:detectedElement.uid});extensionDetectedDataAlreadySent.has(_data)||(extensionDetectedDataAlreadySent.add(_data),newData.push(detectedElement))}newData.length>0&&logEvent({action:"extensions_detected",data:newData})}function logEvent(newEvent){if(db){const objectStore=db.transaction("events","readwrite").objectStore("events"),_newEvent={timestamp:SharedUtils.generateTimestamp(),...newEvent};console.log("New user action stored",_newEvent),objectStore.add(_newEvent)}}function trackDocumentState(event){let type=event.type;if("visibilitychange"===event.type&&("visible"===document.visibilityState?type="focus":"hidden"===document.visibilityState&&(type="blur")),"focus"===type){if(!isCurrentlyFocused){isCurrentlyFocused=!0;logEvent({action:"page_foreground",data:{previousState:"background"}})}}else if("blur"===type&&isCurrentlyFocused){isCurrentlyFocused=!1;logEvent({action:"page_background",data:{previousState:"foreground"}})}}function initTracking(){if(window._trackingInitialized)return void console.warn("Tracking already initialized, skipped");window._trackingInitialized=!0;logEvent({action:"page_load",data:{url:window.location.href,referrer:document.referrer||null,userAgent:navigator.userAgent}}),ExtensionDetector.init(backendParams),checkForNewExtensions(),extensionCheckInterval=setInterval((()=>{checkForNewExtensions()}),5e3),document.addEventListener("visibilitychange",trackDocumentState),document.addEventListener("blur",trackDocumentState,!0),window.addEventListener("focus",trackDocumentState),window.addEventListener("blur",trackDocumentState),document.addEventListener("copy",(event=>function(event){const selection=window.getSelection(),copiedText=selection.toString();if(!copiedText)return;const anchorNode=selection.anchorNode;if(!anchorNode)return;let qtextElement=null,currentElement=anchorNode.nodeType===Node.TEXT_NODE?anchorNode.parentElement:anchorNode;for(;currentElement&&currentElement!==document.body;){if(currentElement.classList&&currentElement.classList.contains("qtext")){qtextElement=currentElement;break}currentElement=currentElement.parentElement}if(!qtextElement)return;let questionElement=null;currentElement=qtextElement;const questionIdPattern=/^question-\d+-\d+$/;for(;currentElement&&currentElement!==document.body;){if(currentElement.id&&questionIdPattern.test(currentElement.id)){questionElement=currentElement;break}currentElement=currentElement.parentElement}if(!questionElement)return;logEvent({action:"copy",data:{content:copiedText,questionId:questionElement.id}})}())),window.addEventListener("beforeunload",(()=>{extensionCheckInterval&&(clearInterval(extensionCheckInterval),extensionCheckInterval=null);logEvent({action:"page_unload",data:{}}),flushEvents()})),trackDocumentState({type:"visibilitychange"})}function flushEvents(){if(db){const request=db.transaction("events","readonly").objectStore("events").getAll();request.onsuccess=()=>{const events=request.result;if(events.length>0){const data={session_id:backendParams.sessionId,attemptid:backendParams.attemptid,userid:backendParams.userid,quizid:backendParams.quizid,slot:backendParams.slot,events:events};fetch("/local/rest/api/quizaccess_cheatdetect/save-data",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(data)}).then((response=>{response.ok?(console.log("User action(s) sent to server",data),function(){const transaction=db.transaction("events","readwrite");transaction.objectStore("events").clear()}()):console.error("Error sending events")})).catch((error=>{console.error("Network error:",error)}))}else console.log("No user actions to save")},request.onerror=error=>{console.error("Error retrieving events from IndexedDB:",error)}}}new Promise(((resolve,reject)=>{if(!window.indexedDB)return void reject("IndexedDB is not available.");const request=indexedDB.open("UserActivityDB",1);request.onupgradeneeded=event=>{const database=event.target.result;database.objectStoreNames.contains("events")||database.createObjectStore("events",{autoIncrement:!0})},request.onsuccess=event=>{db=event.target.result,resolve()},request.onerror=event=>{console.error("Error opening IndexedDB:",event.target.error),reject(event.target.error)}})).then((()=>{initTracking(),setInterval((()=>{flushEvents()}),5e3)})).catch((error=>{console.error("Failed to initialize IndexedDB:",error)}))})()}}}));

//# sourceMappingURL=index.min.js.map