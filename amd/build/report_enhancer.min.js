/**
 * This JS is made to enhance the /mod/quiz/report.php?id=X&mode=overview core_moodle report table
 * and /mod/quiz/reviewquestion.php pages
 *
 * @module     quizaccess_cheatdetect/report_enhancer
 * @package
 * @copyright   2025 CBlue SPRL
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @author      gnormand@cblue.be
 */
define("quizaccess_cheatdetect/report_enhancer",["jquery","core/ajax","core/notification","core/str"],(function($,Ajax,Notification,Str){var createSvgIcon=function(iconColor,iconType){var iconFile="spy-icon-"+iconColor+".svg",svgPath=M.cfg.wwwroot+"/mod/quiz/accessrule/cheatdetect/pix/"+iconFile,$img=$("<img>").attr("src",svgPath).attr("aria-hidden","true").addClass("cheatdetect-svg-icon").attr("data-cblue-spyicon",iconType);return"summary"===iconType?$img.css({width:"20px",height:"20px","margin-left":"8px","vertical-align":"middle"}):$img.css({width:"20px",height:"20px",display:"block","margin-top":"4px"}),$img},extractSlotFromUrl=function(url){if(!url)return null;var urlParts=url.split("?");if(urlParts.length>1){var slot=new URLSearchParams(urlParts[1]).get("slot");return slot?parseInt(slot,10):null}return null},generatePopoverContent=function(slotData,strings){var timeInMinutes=Math.round(slotData.time_spent/60),timePercentage=Math.round(slotData.time_percentage),html='<ul class="mb-0">';html+="<li>"+strings.timespent.replace("{$a->minutes}",timeInMinutes).replace("{$a->percentage}",timePercentage)+"</li>";var copyCountText=strings.copycount.replace("{$a}",slotData.copy_count);slotData.copy_count>0?html+='<li class="text-danger fw-bold">'+copyCountText+"</li>":html+="<li>"+copyCountText+"</li>";var focusLossText=strings.focuslosscount.replace("{$a}",slotData.focus_loss_count);slotData.focus_loss_count>0?html+='<li class="text-danger fw-bold">'+focusLossText+"</li>":html+="<li>"+focusLossText+"</li>";var extensionText=slotData.has_extension?strings.yes:strings.no,extensionDetectedText=strings.extensiondetected.replace("{$a}",extensionText);return slotData.has_extension?html+='<li class="text-danger fw-bold">'+extensionDetectedText+"</li>":html+="<li>"+extensionDetectedText+"</li>",html+="</ul>"},processBulkAttemptSummaries=function(summaries){console.log("CheatDetect: Processing "+summaries.length+" attempt summaries");Str.get_strings([{key:"questiondetails",component:"quizaccess_cheatdetect"},{key:"timespent",component:"quizaccess_cheatdetect"},{key:"copycount",component:"quizaccess_cheatdetect"},{key:"focuslosscount",component:"quizaccess_cheatdetect"},{key:"extensiondetected",component:"quizaccess_cheatdetect"},{key:"yes",component:"quizaccess_cheatdetect"},{key:"no",component:"quizaccess_cheatdetect"}]).then((function(stringsArray){var strings={questiondetails:stringsArray[0],timespent:stringsArray[1],copycount:stringsArray[2],focuslosscount:stringsArray[3],extensiondetected:stringsArray[4],yes:stringsArray[5],no:stringsArray[6]};processAttemptSummariesWithStrings(summaries,strings)})).catch((function(error){console.error("CheatDetect: Error loading strings",error)}))},processAttemptSummariesWithStrings=function(summaries,strings){summaries.forEach((function(attemptData){var attemptId=attemptData.attemptid,slots=attemptData.slots,$row=$('tr[data-cblue-attempt="'+attemptId+'"]');if(0!==$row.length){console.log("CheatDetect: Processing attempt "+attemptId+" with "+slots.length+" slots");var hasRedSlot=!1;slots&&0!==slots.length?slots.forEach((function(slotData){var slotId=slotData.slot,$td=$row.find('td[data-cblue-slot="'+slotId+'"]');if(0!==$td.length){if(!($td.find(".cheatdetect-svg-icon").length>0)){var iconColor=slotData.cheat_detected?"red":"green";if(slotData.cheat_detected&&(hasRedSlot=!0),$td.find('a[href*="reviewquestion.php"]').first().length>0){var $icon=createSvgIcon(iconColor,"question"),popoverContent=generatePopoverContent(slotData,strings),$iconButton=$("<button>").attr("type","button").attr("data-bs-toggle","popover").attr("data-bs-trigger","click").attr("data-bs-html","true").attr("data-bs-title",strings.questiondetails).attr("data-bs-content",popoverContent).attr("data-bs-placement","left").addClass("btn btn-link p-0").css({border:"none",background:"none",cursor:"pointer",display:"inline-block"}).append($icon);$td.append($iconButton),console.log("CheatDetect: Added "+iconColor+" icon for slot "+slotId+" (cheat_detected: "+slotData.cheat_detected+")")}}}else console.warn("CheatDetect: TD not found for attempt "+attemptId+" slot "+slotId)})):(console.log("CheatDetect: No slot data for attempt "+attemptId+", using gray icons"),$row.find("td[data-cblue-slot]").each((function(){var $td=$(this);if(!($td.find(".cheatdetect-svg-icon").length>0)){var slotId=$td.attr("data-cblue-slot");if($td.find('a[href*="reviewquestion.php"]').first().length>0){var $icon=createSvgIcon("gray","question"),grayPopoverContent=generatePopoverContent({time_spent:0,time_percentage:0,copy_count:0,focus_loss_count:0,has_extension:!1},strings),$iconButton=$("<button>").attr("type","button").attr("data-bs-toggle","popover").attr("data-bs-trigger","click").attr("data-bs-html","true").attr("data-bs-title",strings.questiondetails).attr("data-bs-content",grayPopoverContent).attr("data-bs-placement","left").addClass("btn btn-link p-0").css({border:"none",background:"none",cursor:"pointer",display:"inline-block"}).append($icon);$td.append($iconButton),console.log("CheatDetect: Added gray icon for slot "+slotId)}}})));var $reviewLink=$row.find(".reviewlink");if($reviewLink.length>0){var $oldEyeIcon=$reviewLink.find(".cheatdetect-icon");if($oldEyeIcon.length>0){var summaryColor=slots&&0!==slots.length?hasRedSlot?"red":"green":"gray",$newEyeIcon=createSvgIcon(summaryColor,"summary");$oldEyeIcon.replaceWith($newEyeIcon),console.log("CheatDetect: Replaced summary icon for attempt "+attemptId+" (color: "+summaryColor+")")}}}else console.warn("CheatDetect: Row not found for attempt "+attemptId)})),console.log("CheatDetect: Finished processing all attempt summaries"),function(){if("undefined"!=typeof bootstrap&&bootstrap.Popover){var popoverElements=document.querySelectorAll('[data-bs-toggle="popover"]');popoverElements.forEach((function(element){if(!bootstrap.Popover.getInstance(element)){var popoverConfig={html:!0,trigger:"click",sanitize:!1};new bootstrap.Popover(element,popoverConfig)}}));var message="CheatDetect: Initialized "+popoverElements.length+" popovers";console.log(message)}else console.warn("CheatDetect: Bootstrap 5 not available")}()},enhanceReportTable=function(){if(0!==$("table.generaltable").length){console.log("CheatDetect: Enhancing report table");var attemptIds=function(){var $attemptsTable=$("#attempts"),attemptIds=[];return 0===$attemptsTable.length?(console.warn("CheatDetect: Attempts table not found"),attemptIds):($attemptsTable.find("tbody tr").each((function(){var $row=$(this),$reviewLink=$row.find(".reviewlink");if($reviewLink.length>0){var href=$reviewLink.attr("href");if(href){var urlParts=href.split("?");if(urlParts.length>1){var attemptId=new URLSearchParams(urlParts[1]).get("attempt");attemptId&&($row.attr("data-cblue-attempt",attemptId),attemptIds.push(parseInt(attemptId,10)),console.log("CheatDetect: Added data-cblue-attempt="+attemptId+" to row"))}}}})),attemptIds)}();if($('a[href*="reviewquestion.php"]').each((function(){var $link=$(this),href=$link.attr("href");if(href){var slotId=extractSlotFromUrl(href);slotId&&($link.closest("td").attr("data-cblue-slot",slotId),console.log("CheatDetect: Added data-cblue-slot="+slotId+" to TD"))}})),addIconsToReviewLinks(),0!==attemptIds.length)return function(attemptIds){if(attemptIds&&0!==attemptIds.length){var payload={attemptids:attemptIds};console.log("CheatDetect: Fetching bulk attempt summaries for IDs:",attemptIds);var ajaxConfig={url:"/local/rest/api/quizaccess_cheatdetect/bulk-attempt-summaries",method:"POST",dataType:"json",success:function(response){console.log("CheatDetect: Bulk attempt summaries response:",response),response.success&&response.data?processBulkAttemptSummaries(response.data):console.warn("CheatDetect: Invalid response from bulk summaries webservice",response)},error:function(xhr,status,error){console.error("CheatDetect: Error fetching bulk attempt summaries",error)},contentType:"application/json"};ajaxConfig.data=JSON.stringify(payload),$.ajax(ajaxConfig)}else console.warn("CheatDetect: No attempt IDs provided")}(attemptIds),attemptIds;console.warn("CheatDetect: No attempts found")}else console.warn("CheatDetect: Report table not found")},addIconsToReviewLinks=function(){$(".reviewlink").each((function(){var $link=$(this);if(!($link.find(".cheatdetect-icon").length>0)){var $icon=$("<i>").addClass("fa fa-eye cheatdetect-icon").attr("aria-hidden","true").css({"margin-left":"8px",color:"#0066cc"});$link.append(" ").append($icon)}}))},enhanceReviewQuestionPage=function(){console.log("CheatDetect: Enhancing review question page");var attemptId=getUrlParameter("attempt"),slotId=getUrlParameter("slot");attemptId&&slotId?fetchAttemptSummary(attemptId,slotId):console.warn("CheatDetect: Missing attempt or slot parameter in URL")},getUrlParameter=function(name){return new URLSearchParams(window.location.search).get(name)},fetchAttemptSummary=function(attemptId,slotId){var url="/local/rest/api/quizaccess_cheatdetect/attempt-summary/"+attemptId+"/slots/"+slotId;$.ajax({url:url,method:"GET",dataType:"json",success:function(response){response.success&&response.data?createCheatDetectResumeBlock(response.data):console.warn("CheatDetect: Invalid response from webservice",response)},error:function(xhr,status,error){console.error("CheatDetect: Error fetching attempt summary",error)}})},createCheatDetectResumeBlock=function(data){if(!($(".cheatdetect_resume").length>0)){var timeInMinutes=Math.round(data.time_spent/60),timePercentage=Math.round(data.time_percentage);Str.get_strings([{key:"timespent",component:"quizaccess_cheatdetect"},{key:"copycount",component:"quizaccess_cheatdetect"},{key:"focuslosscount",component:"quizaccess_cheatdetect"},{key:"extensiondetected",component:"quizaccess_cheatdetect"},{key:"yes",component:"quizaccess_cheatdetect"},{key:"no",component:"quizaccess_cheatdetect"}]).then((function(strings){var timeSpentStr=strings[0],copyCountStr=strings[1],focusLossCountStr=strings[2],extensionDetectedStr=strings[3],yesStr=strings[4],noStr=strings[5],extensionText=data.has_extension?yesStr:noStr,$resumeBlock=$("<div>").addClass("cheatdetect_resume").css({"background-color":"#d3d3d3",padding:"1rem 1rem","margin-bottom":"1rem",border:"var(--bs-border-width) solid #fff0","border-radius":"var(--bs-border-radius)","font-size":"14px","line-height":"1.6"}),timeSpentText=timeSpentStr.replace("{$a->minutes}",timeInMinutes).replace("{$a->percentage}",timePercentage),$timeLine=$("<div>").text(timeSpentText),copyCountText=copyCountStr.replace("{$a}",data.copy_count),$copyLine=$("<div>").text(copyCountText).css("color",data.copy_count>0?"#ff0000":"inherit"),focusLossCountText=focusLossCountStr.replace("{$a}",data.focus_loss_count),$focusLine=$("<div>").text(focusLossCountText).css("color",data.focus_loss_count>0?"#ff0000":"inherit"),extensionDetectedText=extensionDetectedStr.replace("{$a}",extensionText),$extensionLine=$("<div>").text(extensionDetectedText);$resumeBlock.append($timeLine).append($copyLine).append($focusLine).append($extensionLine);var $outcomeContainer=$(".outcome");if($outcomeContainer.length>0)$outcomeContainer.after($resumeBlock);else{var $targetContainer=$(".que");$targetContainer.length>0?$targetContainer.prepend($resumeBlock):$("#page-content").prepend($resumeBlock)}console.log("CheatDetect: Resume block added successfully")})).catch((function(error){console.error("CheatDetect: Error loading strings",error)}))}};return{init:function(params){params,$(document).ready((function(){-1!==window.location.pathname.indexOf("reviewquestion.php")?enhanceReviewQuestionPage():enhanceReportTable()}))}}}));

//# sourceMappingURL=report_enhancer.min.js.map