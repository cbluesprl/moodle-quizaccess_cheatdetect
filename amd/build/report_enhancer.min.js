/**
 * @fileoverview Report enhancer module for quiz cheat detection visualization
 *
 * This module enhances the /mod/quiz/report.php?id=X&mode=overview core Moodle report table
 * and /mod/quiz/reviewquestion.php pages with cheat detection indicators and popovers.
 *
 * @module     quizaccess_cheatdetect/report_enhancer
 * @copyright  2025 CBlue SPRL
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 * @author     gnormand@cblue.be, jdeboysere@cblue.be
 * @since      1.0.0
 */
define("quizaccess_cheatdetect/report_enhancer",["jquery","core/ajax","core/notification","core/str","theme_boost/bootstrap/popover"],(function($,Ajax,Notification,Str,Popover){var createSvgIcon=function(iconColor,iconType){var iconFile="spy-icon-"+iconColor+".svg",svgPath=M.cfg.wwwroot+"/mod/quiz/accessrule/cheatdetect/pix/"+iconFile;return $("<img>").attr("src",svgPath).attr("aria-hidden","true").addClass("cheatdetect-svg-icon").attr("data-cblue-spyicon",iconType)},extractSlotFromUrl=function(url){if(!url)return null;var urlParts=url.split("?");if(urlParts.length>1){var slot=new URLSearchParams(urlParts[1]).get("slot");return slot?parseInt(slot,10):null}return null},getTimeSpentStringKey=function(timeSpentSeconds){var timeInMinutes=timeSpentSeconds/60;if(timeInMinutes<1){var seconds=Math.round(timeSpentSeconds);return{value:seconds,key:seconds>1?"timespent_seconds_plural":"timespent_seconds"}}var minutes=Math.round(timeInMinutes);return{value:minutes,key:minutes>1?"timespent_minutes_plural":"timespent_minutes"}},generatePopoverContent=function(slotData,strings,slotId){var timeInfo=getTimeSpentStringKey(slotData.time_spent),timePercentage=Math.round(slotData.time_percentage),html='<ul class="mb-0">';html+="<li>"+strings[timeInfo.key].replace("{$a->time}",timeInfo.value).replace("{$a->percentage}",timePercentage).replace("{$a->slot}",slotId)+"</li>";var copyCountText=strings.copycount.replace("{$a}",slotData.copy_count);slotData.copy_count>0?html+='<li class="text-danger fw-bold">'+copyCountText+"</li>":html+="<li>"+copyCountText+"</li>";var focusLossText=strings.focuslosscount.replace("{$a}",slotData.focus_loss_count);slotData.focus_loss_count>0?html+='<li class="text-danger fw-bold">'+focusLossText+"</li>":html+="<li>"+focusLossText+"</li>";var extensionText=slotData.has_extension?strings.yes:strings.no,extensionDetectedText=strings.extensiondetected.replace("{$a}",extensionText);return slotData.has_extension?html+='<li class="text-danger fw-bold">'+extensionDetectedText+"</li>":html+="<li>"+extensionDetectedText+"</li>",html+="</ul>"},hideAllPopoversExcept=function($except){$('[data-bs-toggle="popover"]').each((function(){var $el=$(this);if(!$except||$el[0]!==$except[0]){var instance=$el.data("popover-instance");instance&&instance.hide()}}))},hideAllPopovers=function(){$('[data-bs-toggle="popover"]').each((function(){var instance=$(this).data("popover-instance");instance&&instance.hide()}))},setupPopoverCloseHandlers=function(){$(document).off("mouseenter.cheatdetect",".popover"),$(document).on("mouseenter.cheatdetect",".popover",(function(){if(!("ontouchstart"in window)){var popoverId=$(this).attr("id");$('[aria-describedby="'+popoverId+'"]').data("popover-inside",!0)}})),$(document).off("mouseleave.cheatdetect",".popover"),$(document).on("mouseleave.cheatdetect",".popover",(function(){if(!("ontouchstart"in window)){var popoverId=$(this).attr("id"),$trigger=$('[aria-describedby="'+popoverId+'"]');$trigger.data("popover-inside",!1),setTimeout((function(){if(!$trigger.data("popover-hover")&&!$trigger.data("popover-inside")){var instance=$trigger.data("popover-instance");instance&&instance.hide()}}),300)}})),$(document).off("click.cheatdetect-inside",".popover"),$(document).on("click.cheatdetect-inside",".popover",(function(e){e.stopPropagation()})),$(document).off("click.cheatdetect-outside touchend.cheatdetect-outside"),$(document).on("click.cheatdetect-outside touchend.cheatdetect-outside",(function(e){$(e.target).closest('[data-bs-toggle="popover"]').length>0||$(e.target).closest(".popover").length>0||hideAllPopovers()})),$(document).off("keydown.cheatdetect-escape"),$(document).on("keydown.cheatdetect-escape",(function(e){"Escape"===e.key&&hideAllPopovers()}))},processBulkAttemptSummaries=function(summaries){console.log("CheatDetect: Processing "+summaries.length+" attempt summaries");Str.get_strings([{key:"questiondetails",component:"quizaccess_cheatdetect"},{key:"timespent_minutes",component:"quizaccess_cheatdetect"},{key:"timespent_minutes_plural",component:"quizaccess_cheatdetect"},{key:"timespent_seconds",component:"quizaccess_cheatdetect"},{key:"timespent_seconds_plural",component:"quizaccess_cheatdetect"},{key:"copycount",component:"quizaccess_cheatdetect"},{key:"focuslosscount",component:"quizaccess_cheatdetect"},{key:"extensiondetected",component:"quizaccess_cheatdetect"},{key:"yes",component:"quizaccess_cheatdetect"},{key:"no",component:"quizaccess_cheatdetect"},{key:"closepopover",component:"quizaccess_cheatdetect"}]).then((function(stringsArray){var strings={questiondetails:stringsArray[0],timespent_minutes:stringsArray[1],timespent_minutes_plural:stringsArray[2],timespent_seconds:stringsArray[3],timespent_seconds_plural:stringsArray[4],copycount:stringsArray[5],focuslosscount:stringsArray[6],extensiondetected:stringsArray[7],yes:stringsArray[8],no:stringsArray[9],closepopover:stringsArray[10]};processAttemptSummariesWithStrings(summaries,strings)})).catch((function(error){console.error("CheatDetect: Error loading strings",error)}))},processAttemptSummariesWithStrings=function(summaries,strings){var $popoverElements;summaries.forEach((function(attemptData){var attemptId=attemptData.attemptid,slots=attemptData.slots,$row=$('tr[data-cblue-attempt="'+attemptId+'"]');if(0!==$row.length){console.log("CheatDetect: Processing attempt "+attemptId+" with "+slots.length+" slots");var hasRedSlot=!1;slots&&0!==slots.length?slots.forEach((function(slotData){var slotId=slotData.slot,$td=$row.find('td[data-cblue-slot="'+slotId+'"]');if(0!==$td.length){if(!($td.find(".cheatdetect-svg-icon").length>0)){var iconColor=slotData.cheat_detected?"red":"green";if(slotData.cheat_detected&&(hasRedSlot=!0),$td.find('a[href*="reviewquestion.php"]').first().length>0){var $icon=createSvgIcon(iconColor,"question"),popoverContent=generatePopoverContent(slotData,strings,slotId),$iconButton=$("<button>").attr("type","button").attr("data-bs-toggle","popover").attr("data-bs-trigger","click").attr("data-bs-html","true").attr("data-bs-title",strings.questiondetails).attr("data-bs-content",popoverContent).attr("data-bs-placement","left").addClass("btn btn-link p-0 cheatdetect-icon-button").append($icon);$td.append($iconButton),console.log("CheatDetect: Added "+iconColor+" icon for slot "+slotId+" (cheat_detected: "+slotData.cheat_detected+")")}}}else console.warn("CheatDetect: TD not found for attempt "+attemptId+" slot "+slotId)})):(console.log("CheatDetect: No slot data for attempt "+attemptId+", using gray icons"),$row.find("td[data-cblue-slot]").each((function(){var $td=$(this);if(!($td.find(".cheatdetect-svg-icon").length>0)){var slotId=$td.attr("data-cblue-slot");if($td.find('a[href*="reviewquestion.php"]').first().length>0){var $icon=createSvgIcon("gray","question"),grayPopoverContent=generatePopoverContent({time_spent:0,time_percentage:0,copy_count:0,focus_loss_count:0,has_extension:!1},strings,slotId),$iconButton=$("<button>").attr("type","button").attr("data-bs-toggle","popover").attr("data-bs-trigger","click").attr("data-bs-html","true").attr("data-bs-title",strings.questiondetails).attr("data-bs-content",grayPopoverContent).attr("data-bs-placement","left").addClass("btn btn-link p-0 cheatdetect-icon-button").append($icon);$td.append($iconButton),console.log("CheatDetect: Added gray icon for slot "+slotId)}}})));var $reviewLink=$row.find(".reviewlink");if($reviewLink.length>0){var $oldEyeIcon=$reviewLink.find(".cheatdetect-icon");if($oldEyeIcon.length>0){var summaryColor=slots&&0!==slots.length?hasRedSlot?"red":"green":"gray",$newEyeIcon=createSvgIcon(summaryColor,"summary");$oldEyeIcon.replaceWith($newEyeIcon),console.log("CheatDetect: Replaced summary icon for attempt "+attemptId+" (color: "+summaryColor+")")}}}else console.warn("CheatDetect: Row not found for attempt "+attemptId)})),console.log("CheatDetect: Finished processing all attempt summaries"),($popoverElements=$('[data-bs-toggle="popover"]')).each((function(){var $element=$(this);if(!$element.data("cheatdetect-initialized")){$element.data("cheatdetect-initialized",!0);var originalContent=$element.attr("data-bs-content")||"",title=$element.attr("data-bs-title")||"",popoverInstance=new Popover($element[0],{html:!0,trigger:"manual",placement:"left",title:title,content:originalContent,sanitize:!1});$element.data("popover-instance",popoverInstance),$element.on("mouseenter",(function(){"ontouchstart"in window||$element.attr("aria-describedby")||($element.data("popover-hover",!0),hideAllPopoversExcept($element),popoverInstance.show())})),$element.on("mouseleave",(function(e){"ontouchstart"in window||($(e.relatedTarget).closest(".popover").length>0?$element.data("popover-inside",!0):($element.data("popover-hover",!1),setTimeout((function(){$element.data("popover-hover")||$element.data("popover-inside")||popoverInstance.hide()}),300)))})),$element.on("click",(function(e){e.preventDefault(),e.stopPropagation();var isVisible=$element.attr("aria-describedby");hideAllPopovers(),isVisible||popoverInstance.show()})),$element.on("keydown",(function(e){if("Enter"===e.key||" "===e.key){e.preventDefault();var isVisible=$element.attr("aria-describedby");hideAllPopovers(),isVisible||popoverInstance.show()}else"Escape"===e.key&&popoverInstance.hide()})),$element.attr("tabindex","0"),$element.attr("role","button"),$element.attr("aria-expanded","false"),$element.on("shown.bs.popover",(function(){$element.attr("aria-expanded","true")})),$element.on("hidden.bs.popover",(function(){$element.attr("aria-expanded","false"),$element.data("popover-hover",!1),$element.data("popover-inside",!1)}))}})),setupPopoverCloseHandlers(),console.log("CheatDetect: Initialized "+$popoverElements.length+" Bootstrap popovers")},enhanceReportTable=function(){if(0!==$("table.generaltable").length){console.log("CheatDetect: Enhancing report table");var attemptIds=function(){var $attemptsTable=$("#attempts"),attemptIds=[];return 0===$attemptsTable.length?(console.warn("CheatDetect: Attempts table not found"),attemptIds):($attemptsTable.find("tbody tr").each((function(){var $row=$(this),$reviewLink=$row.find(".reviewlink");if($reviewLink.length>0){var href=$reviewLink.attr("href");if(href){var urlParts=href.split("?");if(urlParts.length>1){var attemptId=new URLSearchParams(urlParts[1]).get("attempt");attemptId&&($row.attr("data-cblue-attempt",attemptId),attemptIds.push(parseInt(attemptId,10)),console.log("CheatDetect: Added data-cblue-attempt="+attemptId+" to row"))}}}})),attemptIds)}();if($('a[href*="reviewquestion.php"]').each((function(){var $link=$(this),href=$link.attr("href");if(href){var slotId=extractSlotFromUrl(href);slotId&&($link.closest("td").attr("data-cblue-slot",slotId),console.log("CheatDetect: Added data-cblue-slot="+slotId+" to TD"))}})),addIconsToReviewLinks(),0!==attemptIds.length)return function(attemptIds){if(attemptIds&&0!==attemptIds.length){var payload={attemptids:attemptIds};console.log("CheatDetect: Fetching bulk attempt summaries for IDs:",attemptIds);var ajaxConfig={url:"/local/rest/api/quizaccess_cheatdetect/bulk-attempt-summaries",method:"POST",dataType:"json",success:function(response){console.log("CheatDetect: Bulk attempt summaries response:",response),response.success&&response.data?processBulkAttemptSummaries(response.data):console.warn("CheatDetect: Invalid response from bulk summaries webservice",response)},error:function(xhr,status,error){console.error("CheatDetect: Error fetching bulk attempt summaries",error)},contentType:"application/json"};ajaxConfig.data=JSON.stringify(payload),$.ajax(ajaxConfig)}else console.warn("CheatDetect: No attempt IDs provided")}(attemptIds),attemptIds;console.warn("CheatDetect: No attempts found")}else console.warn("CheatDetect: Report table not found")},addIconsToReviewLinks=function(){$(".reviewlink").each((function(){var $link=$(this);if(!($link.find(".cheatdetect-icon").length>0)){var $icon=$("<i>").addClass("fa fa-eye cheatdetect-icon").attr("aria-hidden","true");$link.append(" ").append($icon)}}))},enhanceReviewQuestionPage=function(){console.log("CheatDetect: Enhancing review question page");var attemptId=function(){var attemptId=new URLSearchParams(window.location.search).get("attempt");return attemptId?(console.log("CheatDetect: Attempt parameter found in URL ("+attemptId+")"),attemptId):(console.warn("CheatDetect: No attempt parameter found in URL"),null)}();if(attemptId){var questionElements=$('[id^="question-"]').filter((function(){return/^question-\d+-\d+$/.test(this.id)}));0!==questionElements.length?(console.log("CheatDetect: Found "+questionElements.length+" question elements"),questionElements.each((function(){var $questionElement=$(this),matches=$questionElement.attr("id").match(/^question-\d+-(\d+)$/);if(matches){var slotId=matches[1];console.log("CheatDetect: Processing question element - attempt: "+attemptId+", slot: "+slotId),fetchAttemptSummary(attemptId,slotId,$questionElement)}}))):console.warn("CheatDetect: No question elements found")}else console.warn("CheatDetect: Cannot enhance review page without attempt ID")},fetchAttemptSummary=function(attemptId,slotId,$questionElement){var url="/local/rest/api/quizaccess_cheatdetect/attempt-summary/"+attemptId+"/slots/"+slotId;$.ajax({url:url,method:"GET",dataType:"json",success:function(response){response.success&&response.data?createCheatDetectResumeBlock(response.data,$questionElement,slotId):console.warn("CheatDetect: Invalid response from webservice",response)},error:function(xhr,status,error){console.error("CheatDetect: Error fetching attempt summary",error)}})},createCheatDetectResumeBlock=function(data,$questionElement,slotId){if(!($questionElement.find(".cheatdetect_resume").length>0)){var timeInfo=getTimeSpentStringKey(data.time_spent),timePercentage=Math.round(data.time_percentage);Str.get_strings([{key:"timespent_minutes",component:"quizaccess_cheatdetect"},{key:"timespent_minutes_plural",component:"quizaccess_cheatdetect"},{key:"timespent_seconds",component:"quizaccess_cheatdetect"},{key:"timespent_seconds_plural",component:"quizaccess_cheatdetect"},{key:"copycount",component:"quizaccess_cheatdetect"},{key:"focuslosscount",component:"quizaccess_cheatdetect"},{key:"extensiondetected",component:"quizaccess_cheatdetect"},{key:"yes",component:"quizaccess_cheatdetect"},{key:"no",component:"quizaccess_cheatdetect"}]).then((function(stringsArray){var strings={timespent_minutes:stringsArray[0],timespent_minutes_plural:stringsArray[1],timespent_seconds:stringsArray[2],timespent_seconds_plural:stringsArray[3],copycount:stringsArray[4],focuslosscount:stringsArray[5],extensiondetected:stringsArray[6],yes:stringsArray[7],no:stringsArray[8]},extensionText=data.has_extension?strings.yes:strings.no,blockColorClass="cheatdetect_resume--gray";void 0!==data.cheat_detected&&(blockColorClass=data.cheat_detected?"cheatdetect_resume--red":"cheatdetect_resume--green");var $resumeBlock=$("<div>").addClass("cheatdetect_resume").addClass(blockColorClass),timeSpentText=strings[timeInfo.key].replace("{$a->time}",timeInfo.value).replace("{$a->percentage}",timePercentage).replace("{$a->slot}",slotId),$timeLine=$("<div>").text(timeSpentText),copyCountText=strings.copycount.replace("{$a}",data.copy_count),$copyLine=$("<div>").text(copyCountText);data.copy_count>0&&$copyLine.addClass("cheatdetect-alert");var focusLossCountText=strings.focuslosscount.replace("{$a}",data.focus_loss_count),$focusLine=$("<div>").text(focusLossCountText);data.focus_loss_count>0&&$focusLine.addClass("cheatdetect-alert");var extensionDetectedText=strings.extensiondetected.replace("{$a}",extensionText),$extensionLine=$("<div>").text(extensionDetectedText);$resumeBlock.append($timeLine).append($copyLine).append($focusLine).append($extensionLine);var $formulationContainer=$questionElement.find(".formulation");$formulationContainer.length>0?$formulationContainer.before($resumeBlock):$questionElement.prepend($resumeBlock),setTimeout((function(){$resumeBlock.addClass("cheatdetect_resume--visible")}),50),console.log("CheatDetect: Resume block added to "+$questionElement.attr("id"))})).catch((function(error){console.error("CheatDetect: Error loading strings",error)}))}};return{init:function(params){$(document).ready((function(){-1!==window.location.pathname.indexOf("/mod/quiz/report.php")?enhanceReportTable():(-1!==window.location.pathname.indexOf("/mod/quiz/reviewquestion.php")||-1!==window.location.pathname.indexOf("/mod/quiz/review.php"))&&enhanceReviewQuestionPage()}))}}}));

//# sourceMappingURL=report_enhancer.min.js.map